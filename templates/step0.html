<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Step 0 - Optimizar im√°genes</title>
  <style>
    body { background:#000; color:#fff; font-family:'Raleway',sans-serif; padding:40px; }
    h2 { text-align:center; margin-bottom:6px; }
    .hint { text-align:center; color:#ccc; margin-bottom:20px; }
    form { text-align:center; margin-bottom:20px; }
    input[type="file"] { margin-bottom:10px; color:white; }
    button { background:linear-gradient(135deg,#ff0080,#7928ca); border:none; color:white;
             padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; margin:5px; }
    button:hover { opacity:0.9; }
    .error { color:#ff4d4d; margin-top:10px; text-align:center; min-height:22px; }
    .meta { text-align:center; color:#ccc; font-size:0.9em; margin-top:8px; min-height:20px; }
    .preview { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:20px; }
    .preview-item { position:relative; width:160px; }
    .preview img { width:100%; height:auto; border:1px solid #333; border-radius:6px; object-fit:contain; background:#111; }
    .badge { position:absolute; bottom:6px; left:6px; background:rgba(0,0,0,0.6); color:#fff; font-size:11px;
             padding:3px 6px; border-radius:4px; }
    .remove-btn { position:absolute; top:4px; right:4px; background:rgba(255,0,0,0.75); color:white; border:none;
                  border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:14px; line-height:24px; text-align:center; }
  </style>
</head>
<body>
  <h2>Optimiza y sube tus im√°genes</h2>
  <p class="hint">M√°x. 500 im√°genes, convertidas autom√°ticamente a WebP (300√ó180 px, calidad 80)</p>

  <form id="formStep0" method="POST" action="/step0" enctype="multipart/form-data" onsubmit="return enviarOptimizado();">
    <input type="file" name="imagenes" id="imagenes" multiple accept="image/*">
    <br>
    <button type="button" id="optimizeBtn">Optimizar</button>
    <button type="button" id="clearBtn">Quitar todas</button>
    <button type="button" id="downloadAllBtn" disabled>Descargar optimizadas</button>
    <button type="submit" id="uploadBtn" disabled>Subir optimizadas</button>
  </form>

  <div class="error" id="error"></div>
  <div class="meta" id="meta"></div>
  <div class="preview" id="preview"></div>

  <script>
    const input = document.getElementById('imagenes');
    const errorEl = document.getElementById('error');
    const metaEl = document.getElementById('meta');
    const previewEl = document.getElementById('preview');
    const clearBtn = document.getElementById('clearBtn');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const uploadBtn = document.getElementById('uploadBtn');

    let originales = [];
    let optimizadas = [];

    function resetErrores() { errorEl.textContent = ''; }
    function setError(msg) { errorEl.textContent = msg; }
    function bytesToKB(b) { return (b / 1024).toFixed(1); }

    input.addEventListener('change', () => {
      resetErrores();
      const nuevos = Array.from(input.files);

      // L√≠mite de cantidad (500)
      if (originales.length + nuevos.length > 500) {
        setError('‚ö†Ô∏è M√°ximo 500 im√°genes permitidas.');
        input.value = '';
        return;
      }

      // Acumular evitando duplicados
      nuevos.forEach(f => {
        const existe = originales.some(a =>
          a.name === f.name && a.size === f.size && a.lastModified === f.lastModified
        );
        if (!existe) originales.push(f);
      });

      renderOriginales();
      actualizarMeta();
    });

    clearBtn.addEventListener('click', () => {
      originales = [];
      optimizadas = [];
      previewEl.innerHTML = '';
      actualizarMeta();
      downloadAllBtn.disabled = true;
      uploadBtn.disabled = true;
    });

    function actualizarMeta() {
      const totalOrig = originales.reduce((sum, f) => sum + f.size, 0);
      const totalOpt  = optimizadas.reduce((sum, f) => sum + f.size, 0);
      const partes = [];
      if (originales.length) partes.push(`${originales.length} original(es) ‚Äî ${bytesToKB(totalOrig)} KB`);
      if (optimizadas.length) partes.push(`${optimizadas.length} optimizada(s) ‚Äî ${bytesToKB(totalOpt)} KB`);
      metaEl.textContent = partes.join(' | ');
    }

    function renderOriginales() {
      previewEl.innerHTML = '';
      originales.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = e => {
          const item = document.createElement('div');
          item.className = 'preview-item';

          const img = document.createElement('img');
          img.src = e.target.result;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-btn';
          removeBtn.textContent = '‚úñ';
          removeBtn.onclick = () => {
            originales.splice(idx, 1);
            renderOriginales();
            actualizarMeta();
          };

          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = `${file.name} ‚Äî ${bytesToKB(file.size)} KB`;

          item.appendChild(img);
          item.appendChild(removeBtn);
          item.appendChild(badge);
          previewEl.appendChild(item);
        };
        reader.readAsDataURL(file);
      });
    }

    // Redimensionar y convertir a WebP con transparencia
    async function resizeToWebP(file) {
      const imgUrl = URL.createObjectURL(file);
      const img = await new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = imgUrl;
      });

      const targetW = 300;
      const targetH = 180;

      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext('2d');

      // Fondo transparente
      ctx.clearRect(0, 0, targetW, targetH);

      // Calcular proporci√≥n
      const ratio = Math.min(targetW / img.width, targetH / img.height);
      const newW = Math.round(img.width * ratio);
      const newH = Math.round(img.height * ratio);

      // Centrar
      const offsetX = Math.floor((targetW - newW) / 2);
      const offsetY = Math.floor((targetH - newH) / 2);

      ctx.drawImage(img, offsetX, offsetY, newW, newH);
      URL.revokeObjectURL(imgUrl);

      // Exportar a WebP calidad 80
      const blob = await new Promise(resolve =>
        canvas.toBlob(resolve, 'image/webp', 0.8)
      );

      return blob;
    }

    optimizeBtn.addEventListener('click', async () => {
      resetErrores();
      if (!originales.length) {
        setError('Sub√≠ im√°genes primero.');
        return;
      }

      optimizadas = [];
      for (const file of originales) {
        const blob = await resizeToWebP(file);
        const nameBase = file.name.replace(/\.(png|jpg|jpeg|gif|tiff|bmp)$/i, '');
        const finalName = `${nameBase}.webp`;

        optimizadas.push({ name: finalName, blob, size: blob.size, url: URL.createObjectURL(blob) });
      }

      renderOptimizadas();
      actualizarMeta();

      downloadAllBtn.disabled = optimizadas.length === 0;
      uploadBtn.disabled = optimizadas.length === 0;
    });

    function renderOptimizadas() {
      previewEl.innerHTML = '';
      optimizadas.forEach((item, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'preview-item';

        const img = document.createElement('img');
        img.src = item.url;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = '‚úñ';
        removeBtn.onclick = () => {
          URL.revokeObjectURL(item.url);
          optimizadas.splice(idx, 1);
          renderOptimizadas();
          actualizarMeta();
          downloadAllBtn.disabled = optimizadas.length === 0;
          uploadBtn.disabled = optimizadas.length === 0;
        };

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = `${item.name} ‚Äî ${bytesToKB(item.size)} KB`;

        wrap.appendChild(img);
        wrap.appendChild(removeBtn);
        wrap.appendChild(badge);
        previewEl.appendChild(wrap);
      });
    }

    downloadAllBtn.addEventListener('click', async () => {
  if (!optimizadas.length) {
    setError("No hay im√°genes optimizadas para descargar.");
    return;
  }

  const zip = new JSZip();

  for (const item of optimizadas) {
    // Convertir Blob a ArrayBuffer para agregar al ZIP
    const arrayBuffer = await item.blob.arrayBuffer();
    zip.file(item.name, arrayBuffer);
  }

  // Generar ZIP y descargar
  const content = await zip.generateAsync({ type: "blob" });
  saveAs(content, "imagenes_optimizadas.zip");
});


    // Subir optimizadas al backend
    async function enviarOptimizado() {
      resetErrores();
      if (!optimizadas.length) {
        setError('Primero optimiz√° las im√°genes.');
        return false;
      }

      for (const item of optimizadas) {
        const formData = new FormData();
        formData.append('file', item.blob, item.name);

        try {
          const res = await fetch('/upload-image', { method: 'POST', body: formData });
          const data = await res.json();
          if (!data.ok) {
            console.warn('Error al subir', item.name, data.error || data.status);
            setError(`‚ö†Ô∏è Error al subir ${item.name}.`);
          } else {
            console.log('üì§ Subida completa:', item.name, data.url || '');
          }
        } catch (err) {
          console.error('Fallo de red en', item.name, err);
          setError(`‚ö†Ô∏è Fallo de red al subir ${item.name}.`);
        }
      }
      return false; // prevenimos submit HTML est√°ndar
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</body>
</html>
