<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Step 0 - Optimizar im√°genes</title>
  <style>
    body { background:#000; color:#fff; font-family:'Raleway',sans-serif; padding:40px; }
    h2 { text-align:center; margin-bottom:6px; }
    .hint { text-align:center; color:#ccc; margin-bottom:20px; }

    form { text-align:center; margin-bottom:20px; }
    .file-block { text-align:center; }
    input[type="file"] { margin-bottom:10px; color:white; }
    .file-count { color:#ccc; font-size:0.9em; margin-top:6px; min-height:20px; }

    button { background:linear-gradient(135deg,#ff0080,#7928ca); border:none; color:white;
             padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; }
    button:hover { opacity:0.9; }

    .error { color:#ff4d4d; margin-top:10px; text-align:center; min-height:22px; }
    .meta { text-align:center; color:#ccc; font-size:0.9em; margin-top:8px; min-height:20px; }

    .botonera { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-top:20px; }
    .botonera .col { text-align:center; min-width:200px; }
    .botonera p { color:white; font-weight:bold; margin-bottom:6px; }

    .preview { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:20px; }
    .preview-item { position:relative; width:180px; }
    .preview img { width:100%; height:auto; border:1px solid #333; border-radius:6px; object-fit:contain; background:#111; }

    .badge { position:absolute; bottom:6px; left:6px; background:rgba(0,0,0,0.6); color:#fff; font-size:11px;
             padding:3px 6px; border-radius:4px; max-width:90%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .remove-btn { position:absolute; top:4px; right:4px; background:rgba(255,0,0,0.8); color:white; border:none;
                  border-radius:50%; width:22px; height:22px; cursor:pointer; font-size:14px; line-height:2px; text-align:center; padding-left: 10px; }

    /* Deshabilitado visual */
    .btn-disabled { opacity:0.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <h2>Optimiza y sube tus im√°genes</h2>
  <p class="hint">M√°x. 500 im√°genes, convertidas autom√°ticamente a WebP (300√ó180 px, calidad 80)</p>

  <form id="formStep0" method="POST" action="/step0" enctype="multipart/form-data" onsubmit="return enviarOptimizado();">
    <div class="file-block">
      <input type="file" name="imagenes" id="imagenes" multiple accept="image/*">
      <div id="fileCount" class="file-count"></div>
    </div>

    <div class="botonera">
      <div class="col">
        <p>Paso 1</p>
        <button type="button" id="optimizeBtn">Optimizar</button>
      </div>
      <div class="col">
        <p>Opcional</p>
        <button type="button" id="clearBtn">Quitar todas</button>
      </div>
      <div class="col">
        <p>Opcional</p>
        <button type="button" id="downloadAllBtn" class="btn-disabled" disabled>Descargar optimizadas</button>
      </div>
      <div class="col">
        <p>Paso 2 y finalizar</p>
        <button type="submit" id="uploadBtn" class="btn-disabled" disabled>Subir optimizadas</button>
      </div>
    </div>
  </form>

  <div class="error" id="error"></div>
  <div class="meta" id="meta"></div>
  <div class="preview" id="preview"></div>
  <div id="pager" style="display:flex; justify-content:center; gap:8px; margin-top:12px;"></div>

  <div id="pager" style="display:flex; justify-content:center; gap:8px; margin-top:12px;"></div>
<div style="text-align:center; margin-top:8px;">
  <label style="color:#ccc; font-size:0.9em;">Miniaturas por p√°gina:</label>
  <select id="pageSizeSelect">
    <option value="20" selected>20</option>
    <option value="30">30</option>
    <option value="50">50</option>
  </select>
</div>

  <script>
    const input = document.getElementById('imagenes');
    const errorEl = document.getElementById('error');
    const metaEl = document.getElementById('meta');
    const previewEl = document.getElementById('preview');
    const fileCountEl = document.getElementById('fileCount');

    const clearBtn = document.getElementById('clearBtn');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const uploadBtn = document.getElementById('uploadBtn');

    let originales = [];
    let optimizadas = [];
    let pageSize = 20;       // por defecto
let pageOrig = 1;        // p√°gina actual para originales
let pageOpt = 1;         // p√°gina actual para optimizadas

// Si us√°s el selector:
const pageSizeSelect = document.getElementById('pageSizeSelect');
if (pageSizeSelect) {
  pageSizeSelect.addEventListener('change', () => {
    pageSize = parseInt(pageSizeSelect.value, 10);
    pageOrig = 1; pageOpt = 1;
    renderOriginales();
    renderOptimizadas();
  });
}

function renderPager(totalItems, currentPage, onGoToPage) {
  const pagerEl = document.getElementById('pager');
  pagerEl.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));

  // Prev
  const prev = document.createElement('button');
  prev.textContent = '¬´';
  prev.disabled = currentPage <= 1;
  prev.onclick = () => onGoToPage(currentPage - 1);
  pagerEl.appendChild(prev);

  // N√∫meros (acota para no generar 1..100 de golpe)
  const maxButtons = 10;
  let start = Math.max(1, currentPage - Math.floor(maxButtons/2));
  let end = Math.min(totalPages, start + maxButtons - 1);
  if (end - start + 1 < maxButtons) start = Math.max(1, end - maxButtons + 1);

  for (let p = start; p <= end; p++) {
    const btn = document.createElement('button');
    btn.textContent = String(p);
    btn.style.minWidth = '32px';
    if (p === currentPage) {
      btn.disabled = true;
      btn.classList.add('btn-disabled');
    } else {
      btn.onclick = () => onGoToPage(p);
    }
    pagerEl.appendChild(btn);
  }

  // Next
  const next = document.createElement('button');
  next.textContent = '¬ª';
  next.disabled = currentPage >= totalPages;
  next.onclick = () => onGoToPage(currentPage + 1);
  pagerEl.appendChild(next);
}

    
    // IndexedDB helper: asegura store, y se auto-repara si falta
    function ensureDB(callback) {
      const request = indexedDB.open("imagenesDB", 2);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("imagenes")) {
          db.createObjectStore("imagenes");
          console.log("üì¶ Store 'imagenes' creado.");
        }
      };
      request.onsuccess = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("imagenes")) {
          console.warn("‚ö†Ô∏è DB sin store. Se borra y recrea.");
          db.close();
          const del = indexedDB.deleteDatabase("imagenesDB");
          del.onsuccess = () => {
            const re = indexedDB.open("imagenesDB", 2);
            re.onupgradeneeded = ev => ev.target.result.createObjectStore("imagenes");
            re.onsuccess = ev => callback(ev.target.result);
          };
          del.onerror = () => {
            console.error("‚ùå No se pudo borrar la DB.");
            callback(db);
          };
        } else {
          callback(db);
        }
      };
      request.onerror = e => console.error("‚ùå Error abriendo IndexedDB:", e.target.error);
    }

    function guardarImagenEnIndexedDB(file) {
      ensureDB(db => {
        const tx = db.transaction("imagenes", "readwrite");
        tx.objectStore("imagenes").put(file, file.name);
        tx.oncomplete = () => {
          let lista = JSON.parse(localStorage.getItem("imagenesLista") || "[]");
          if (!lista.includes(file.name)) {
            lista.push(file.name);
            localStorage.setItem("imagenesLista", JSON.stringify(lista));
          }
        };
        tx.onerror = e => console.error("‚ùå Error guardando imagen en IndexedDB:", e.target.error);
      });
    }

    function resetErrores() { errorEl.textContent = ''; }
    function setError(msg) { errorEl.textContent = msg; }
    function bytesToKB(b) { return (b / 1024).toFixed(1); }
    function bytesToMB(b) { return (b / (1024*1024)).toFixed(2); }

    // Sincroniza input.files con originales usando DataTransfer para que el selector muestre ‚ÄúN archivos‚Äù
    function syncInputWithOriginales() {
      const dt = new DataTransfer();
      originales.forEach(file => dt.items.add(file));
      input.files = dt.files;
      actualizarFileCount();
    }

    function actualizarFileCount() {
      if (originales.length) {
        const totalBytes = originales.reduce((s,f)=>s+f.size,0);
        fileCountEl.textContent = `${originales.length} archivo(s) ‚Äî ${bytesToMB(totalBytes)} MB`;
      } else {
        fileCountEl.textContent = '';
      }
    }

    input.addEventListener('change', () => {
      resetErrores();
      const nuevos = Array.from(input.files);

      // Validaciones
      if (originales.length + nuevos.length > 500) {
        setError('‚ö†Ô∏è M√°ximo 500 im√°genes permitidas.');
        input.value = '';
        return;
      }
      for (const f of nuevos) {
        // l√≠mite por archivo: 1 MB
        if (f.size > 1 * 1024 * 1024) {
          setError(`La imagen "${f.name}" supera 1 MB.`);
          input.value = '';
          return;
        }
      }

      // Evitar duplicados
      nuevos.forEach(f => {
        const existe = originales.some(a =>
          a.name === f.name && a.size === f.size && a.lastModified === f.lastModified
        );
        if (!existe) {
          originales.push(f);
          guardarImagenEnIndexedDB(f);
        }
      });

      syncInputWithOriginales();
      renderOriginales();
      actualizarMeta();
    });

    clearBtn.addEventListener('click', () => {
  optimizadas.forEach(i => i.url && URL.revokeObjectURL(i.url));
  optimizadas = [];
  originales = [];
  previewEl.innerHTML = '';
  actualizarMeta();
  downloadAllBtn.disabled = true; downloadAllBtn.classList.add('btn-disabled');
  uploadBtn.disabled = true; uploadBtn.classList.add('btn-disabled');
  syncInputWithOriginales();
  input.value = '';
  actualizarFileCount();
  localStorage.removeItem("imagenesLista");
  const del = indexedDB.deleteDatabase("imagenesDB");
  del.onsuccess = () => console.log("üóëÔ∏è IndexedDB borrada al limpiar todas");
});


    function actualizarMeta() {
      const totalOrig = originales.reduce((sum, f) => sum + f.size, 0);
      const totalOpt  = optimizadas.reduce((sum, f) => sum + f.size, 0);
      const partes = [];
      if (originales.length) partes.push(`${originales.length} original(es) ‚Äî ${bytesToKB(totalOrig)} KB`);
      if (optimizadas.length) partes.push(`${optimizadas.length} optimizada(s) ‚Äî ${bytesToKB(totalOpt)} KB`);
      metaEl.textContent = partes.join(' | ');

      // estado botones seg√∫n optimizadas
      const hasOpt = optimizadas.length > 0;
      downloadAllBtn.disabled = !hasOpt;
      uploadBtn.disabled = !hasOpt;
      downloadAllBtn.classList.toggle('btn-disabled', !hasOpt);
      uploadBtn.classList.toggle('btn-disabled', !hasOpt);
    }

    function renderOriginales() {
  previewEl.innerHTML = '';

  const total = originales.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  pageOrig = Math.min(pageOrig, totalPages);

  const start = (pageOrig - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const pageItems = originales.slice(start, end);

  pageItems.forEach((file, idxPage) => {
    const reader = new FileReader();
    reader.onload = e => {
      const item = document.createElement('div');
      item.className = 'preview-item';

      const img = document.createElement('img');
      img.src = e.target.result;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.alt = file.name;

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = '‚úñ';
      // idx global = start + idxPage
      removeBtn.onclick = () => {
        originales.splice(start + idxPage, 1);
        syncInputWithOriginales();
        renderOriginales();
        actualizarMeta();
      };

      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = `${file.name} ‚Äî ${bytesToKB(file.size)} KB`;

      item.appendChild(img);
      item.appendChild(removeBtn);
      item.appendChild(badge);
      previewEl.appendChild(item);
    };
    reader.readAsDataURL(file);
  });

  // Dibujar paginador para originales
  renderPager(total, pageOrig, (p) => {
    pageOrig = p;
    renderOriginales();
  });
}

    async function resizeToWebP(file) {
      const imgUrl = URL.createObjectURL(file);
      const img = await new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = imgUrl;
      });

      const targetW = 300, targetH = 180;
      const canvas = document.createElement('canvas');
      canvas.width = targetW; canvas.height = targetH;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, targetW, targetH);

      const ratio = Math.min(targetW / img.width, targetH / img.height);
      const newW = Math.round(img.width * ratio);
      const newH = Math.round(img.height * ratio);
      const offsetX = Math.floor((targetW - newW) / 2);
      const offsetY = Math.floor((targetH - newH) / 2);

      ctx.drawImage(img, offsetX, offsetY, newW, newH);
      URL.revokeObjectURL(imgUrl);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/webp', 0.8));
      return blob;
    }

    optimizeBtn.addEventListener('click', async () => {
      resetErrores();
      if (!originales.length) {
        setError('Sub√≠ im√°genes primero.');
        return;
      }

      optimizadas = [];
      for (const file of originales) {
        const blob = await resizeToWebP(file);
        const nameBase = file.name.replace(/\.(png|jpg|jpeg|gif|tiff|bmp|webp)$/i, '');
        const finalName = `${nameBase}.webp`;
        optimizadas.push({ name: finalName, blob, size: blob.size, url: URL.createObjectURL(blob) });
      }

      renderOptimizadas();
      actualizarMeta();
    });

    function renderOptimizadas() {
  previewEl.innerHTML = '';

  const total = optimizadas.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  pageOpt = Math.min(pageOpt, totalPages);

  const start = (pageOpt - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const pageItems = optimizadas.slice(start, end);

  pageItems.forEach((item, idxPage) => {
    const wrap = document.createElement('div');
    wrap.className = 'preview-item';

    const img = document.createElement('img');
    img.src = item.url;
    img.loading = 'lazy';
    img.decoding = 'async';
    img.alt = item.name;

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '‚úñ';
    removeBtn.onclick = () => {
      URL.revokeObjectURL(item.url);
      optimizadas.splice(start + idxPage, 1);
      renderOptimizadas();
      actualizarMeta();
    };

    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.textContent = `${item.name} ‚Äî ${bytesToKB(item.size)} KB`;

    wrap.appendChild(img);
    wrap.appendChild(removeBtn);
    wrap.appendChild(badge);
    previewEl.appendChild(wrap);
  });

  // Dibujar paginador para optimizadas
  renderPager(total, pageOpt, (p) => {
    pageOpt = p;
    renderOptimizadas();
  });
}


    downloadAllBtn.addEventListener('click', async () => {
      if (!optimizadas.length) {
        setError("No hay im√°genes optimizadas para descargar.");
        return;
      }
      const zip = new JSZip();
      for (const item of optimizadas) {
        const arrayBuffer = await item.blob.arrayBuffer();
        zip.file(item.name, arrayBuffer);
      }
      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "imagenes_optimizadas.zip");
    });

    async function enviarOptimizado() {
      resetErrores();
      if (!optimizadas || !optimizadas.length) {
        setError("‚ö†Ô∏è Primero optimiz√° las im√°genes.");
        return false;
      }
      try {
        const resultados = await Promise.all(
          optimizadas.map(async (item) => {
            const formData = new FormData();
            formData.append("file", item.blob, item.name);
            const res = await fetch("/upload-image", { method: "POST", body: formData });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (!data.ok) {
              setError(`‚ö†Ô∏è Error al subir ${item.name}.`);
              return { ok: false };
            }
            console.log("üì§ Subida completa:", item.name, data.url || "");
            return { ok: true };
          })
        );
        if (resultados.every(r => !r.ok)) {
          setError("‚ùå No se pudo subir ninguna imagen.");
        }
      } catch (err) {
        setError("‚ö†Ô∏è Error inesperado al subir im√°genes.");
      }
      return false; // prevenir submit HTML est√°ndar
    }
  </script>
  <!-- Librer√≠as para ZIP y descarga -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</body>
</html>
