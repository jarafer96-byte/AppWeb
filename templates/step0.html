<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Step 0 - Optimizar im√°genes</title>
  <style>
    body { background:#000; color:#fff; font-family:'Raleway',sans-serif; padding:40px; }
    h2 { text-align:center; margin-bottom:6px; }
    .hint { text-align:center; color:#ccc; margin-bottom:20px; }
    form { text-align:center; margin-bottom:20px; }
    input[type="file"] { margin-bottom:10px; color:white; }
    button { background:linear-gradient(135deg,#ff0080,#7928ca); border:none; color:white;
             padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; margin:5px; }
    button:hover { opacity:0.9; }
    .error { color:#ff4d4d; margin-top:10px; text-align:center; min-height:22px; }
    .meta { text-align:center; color:#ccc; font-size:0.9em; margin-top:8px; min-height:20px; }
    .preview { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:20px; }
    .preview-item { position:relative; width:160px; }
    .preview img { width:100%; height:auto; border:1px solid #333; border-radius:6px; object-fit:contain; background:#111; }
    .badge { position:absolute; bottom:6px; left:6px; background:rgba(0,0,0,0.6); color:#fff; font-size:11px;
             padding:3px 6px; border-radius:4px; }
    .remove-btn { position:absolute; top:4px; right:4px; background:rgba(255,0,0,0.75); color:white; border:none;
                  border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:14px; line-height:24px; text-align:center; }
  </style>
</head>
<body>
  <h2>Optimiza y sube tus im√°genes</h2>
  <p class="hint">M√°x. 500 im√°genes, convertidas autom√°ticamente a WebP (300√ó180 px, calidad 80)</p>

  <form id="formStep0" method="POST" action="/step0" enctype="multipart/form-data" onsubmit="return enviarOptimizado();">
  <input type="file" name="imagenes" id="imagenes" multiple accept="image/*"
         onchange="Array.from(this.files).forEach(f => guardarImagenEnIndexedDB(f))">
  <br><br>

  <!-- Contenedor horizontal -->
  <div class="d-flex justify-content-center gap-4 flex-wrap text-center">

    <div>
      <p style="color:white; font-weight:bold; margin-bottom:6px;">Paso 1</p>
      <button type="button" id="optimizeBtn" class="btn-gradient">Optimizar</button>
    </div>

    <div>
      <p style="color:white; font-weight:bold; margin-bottom:6px;">Opcional</p>
      <button type="button" id="clearBtn" class="btn-gradient">Quitar todas</button>
    </div>

    <div>
      <p style="color:white; font-weight:bold; margin-bottom:6px;">Opcional</p>
      <button type="button" id="downloadAllBtn" class="btn-gradient">Descargar optimizadas</button>
    </div>

    <div>
      <p style="color:white; font-weight:bold; margin-bottom:6px;">Paso 2 y finalizar</p>
      <button type="submit" id="uploadBtn" class="btn-gradient">Subir optimizadas</button>
    </div>

  </div>
</form>


  <div class="error" id="error"></div>
  <div class="meta" id="meta"></div>
  <div class="preview" id="preview"></div>

  <script>
    const input = document.getElementById('imagenes');
    const errorEl = document.getElementById('error');
    const metaEl = document.getElementById('meta');
    const previewEl = document.getElementById('preview');
    const clearBtn = document.getElementById('clearBtn');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const uploadBtn = document.getElementById('uploadBtn');

    let originales = [];
    let optimizadas = [];

    // Util: garantiza que el store exista; si falta, borra DB y recrea
    function ensureDB(callback) {
      const request = indexedDB.open("imagenesDB", 2); // versi√≥n 2 para forzar upgrade

      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("imagenes")) {
          db.createObjectStore("imagenes");
          console.log("üì¶ Object store 'imagenes' creado (upgrade)");
        }
      };

      request.onsuccess = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("imagenes")) {
          // Estado corrupto: DB existe sin store. Borramos y recreamos.
          console.warn("‚ö†Ô∏è DB sin store. Se borra y recrea 'imagenesDB'.");
          db.close();
          const del = indexedDB.deleteDatabase("imagenesDB");
          del.onsuccess = () => {
            const re = indexedDB.open("imagenesDB", 2);
            re.onupgradeneeded = ev => {
              ev.target.result.createObjectStore("imagenes");
              console.log("üì¶ Store creado tras borrar DB");
            };
            re.onsuccess = ev => callback(ev.target.result);
          };
          del.onerror = () => {
            console.error("‚ùå No se pudo borrar la DB. IndexedDB queda inconsistente.");
            callback(db); // lo mejor posible
          };
        } else {
          callback(db);
        }
      };

      request.onerror = e => {
        console.error("‚ùå Error abriendo IndexedDB:", e.target.error);
      };
    }

    function guardarImagenEnIndexedDB(file) {
      ensureDB(db => {
        const tx = db.transaction("imagenes", "readwrite");
        const store = tx.objectStore("imagenes");
        store.put(file, file.name);

        tx.oncomplete = () => {
          console.log("‚úÖ Imagen guardada en IndexedDB:", file.name);
          let lista = JSON.parse(localStorage.getItem("imagenesLista") || "[]");
          if (!lista.includes(file.name)) {
            lista.push(file.name);
            localStorage.setItem("imagenesLista", JSON.stringify(lista));
          }
          uploadBtn.disabled = false;
          downloadAllBtn.disabled = false;
        };

        tx.onerror = e => {
          console.error("‚ùå Error guardando imagen en IndexedDB:", e.target.error);
        };
      });
    }

    function resetErrores() { errorEl.textContent = ''; }
    function setError(msg) { errorEl.textContent = msg; }
    function bytesToKB(b) { return (b / 1024).toFixed(1); }

    input.addEventListener('change', () => {
      resetErrores();
      const nuevos = Array.from(input.files);

      if (originales.length + nuevos.length > 500) {
        setError('‚ö†Ô∏è M√°ximo 500 im√°genes permitidas.');
        input.value = '';
        return;
      }

      nuevos.forEach(f => {
        const existe = originales.some(a =>
          a.name === f.name && a.size === f.size && a.lastModified === f.lastModified
        );
        if (!existe) originales.push(f);
      });

      renderOriginales();
      actualizarMeta();
    });

    clearBtn.addEventListener('click', () => {
  originales = [];
  optimizadas = [];
  previewEl.innerHTML = '';
  actualizarMeta();
  downloadAllBtn.disabled = true;
  uploadBtn.disabled = true;

  // üîπ limpiar tambi√©n el input file
  input.value = '';
});


    function actualizarMeta() {
      const totalOrig = originales.reduce((sum, f) => sum + f.size, 0);
      const totalOpt  = optimizadas.reduce((sum, f) => sum + f.size, 0);
      const partes = [];
      if (originales.length) partes.push(`${originales.length} original(es) ‚Äî ${bytesToKB(totalOrig)} KB`);
      if (optimizadas.length) partes.push(`${optimizadas.length} optimizada(s) ‚Äî ${bytesToKB(totalOpt)} KB`);
      metaEl.textContent = partes.join(' | ');
    }

    function renderOriginales() {
      previewEl.innerHTML = '';
      originales.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = e => {
          const item = document.createElement('div');
          item.className = 'preview-item';

          const img = document.createElement('img');
          img.src = e.target.result;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-btn';
          removeBtn.textContent = '‚úñ';
          removeBtn.onclick = () => {
            originales.splice(idx, 1);
            renderOriginales();
            actualizarMeta();
          };

          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = `${file.name} ‚Äî ${bytesToKB(file.size)} KB`;

          item.appendChild(img);
          item.appendChild(removeBtn);
          item.appendChild(badge);
          previewEl.appendChild(item);
        };
        reader.readAsDataURL(file);
      });
    }

    async function resizeToWebP(file) {
      const imgUrl = URL.createObjectURL(file);
      const img = await new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = imgUrl;
      });

      const targetW = 300, targetH = 180;
      const canvas = document.createElement('canvas');
      canvas.width = targetW; canvas.height = targetH;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, targetW, targetH);

      const ratio = Math.min(targetW / img.width, targetH / img.height);
      const newW = Math.round(img.width * ratio);
      const newH = Math.round(img.height * ratio);
      const offsetX = Math.floor((targetW - newW) / 2);
      const offsetY = Math.floor((targetH - newH) / 2);

      ctx.drawImage(img, offsetX, offsetY, newW, newH);
      URL.revokeObjectURL(imgUrl);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/webp', 0.8));
      return blob;
    }

    optimizeBtn.addEventListener('click', async () => {
      resetErrores();
      if (!originales.length) {
        setError('Sub√≠ im√°genes primero.');
        return;
      }

      optimizadas = [];
      for (const file of originales) {
        const blob = await resizeToWebP(file);
        const nameBase = file.name.replace(/\.(png|jpg|jpeg|gif|tiff|bmp)$/i, '');
        const finalName = `${nameBase}.webp`;
        optimizadas.push({ name: finalName, blob, size: blob.size, url: URL.createObjectURL(blob) });
      }

      renderOptimizadas();
      actualizarMeta();
      downloadAllBtn.disabled = optimizadas.length === 0;
      uploadBtn.disabled = optimizadas.length === 0;
    });

    function renderOptimizadas() {
      previewEl.innerHTML = '';
      optimizadas.forEach((item, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'preview-item';

        const img = document.createElement('img');
        img.src = item.url;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = '‚úñ';
        removeBtn.onclick = () => {
          URL.revokeObjectURL(item.url);
          optimizadas.splice(idx, 1);
          renderOptimizadas();
          actualizarMeta();
          downloadAllBtn.disabled = optimizadas.length === 0;
          uploadBtn.disabled = optimizadas.length === 0;
        };

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = `${item.name} ‚Äî ${bytesToKB(item.size)} KB`;

        wrap.appendChild(img);
        wrap.appendChild(removeBtn);
        wrap.appendChild(badge);
        previewEl.appendChild(wrap);
      });
    }

    downloadAllBtn.addEventListener('click', async () => {
      if (!optimizadas.length) {
        setError("No hay im√°genes optimizadas para descargar.");
        return;
      }
      const zip = new JSZip();
      for (const item of optimizadas) {
        const arrayBuffer = await item.blob.arrayBuffer();
        zip.file(item.name, arrayBuffer);
      }
      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "imagenes_optimizadas.zip");
    });

    // Versi√≥n async final que sube optimizadas al backend
    async function enviarOptimizado() {
      resetErrores();
      if (!optimizadas || !optimizadas.length) {
        setError("‚ö†Ô∏è Primero optimiz√° las im√°genes.");
        return false;
      }
      try {
        const resultados = await Promise.all(
          optimizadas.map(async (item) => {
            const formData = new FormData();
            formData.append("file", item.blob, item.name);
            const res = await fetch("/upload-image", { method: "POST", body: formData });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (!data.ok) {
              setError(`‚ö†Ô∏è Error al subir ${item.name}.`);
              return { ok: false };
            }
            console.log("üì§ Subida completa:", item.name, data.url || "");
            return { ok: true };
          })
        );
        if (resultados.every(r => !r.ok)) {
          setError("‚ùå No se pudo subir ninguna imagen.");
        }
      } catch (err) {
        setError("‚ö†Ô∏è Error inesperado al subir im√°genes.");
      }
      return false; // prevenir submit HTML est√°ndar
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</body>
</html>
