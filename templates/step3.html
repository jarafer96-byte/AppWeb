<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contenido del sitio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --gradient: linear-gradient(135deg, #8e2de2, #ff6f61);
      --dark-bg: #000;
      --card-bg: rgba(255,255,255,0.05);
      --text-light: #fff;
      --text-muted: #aaa;
    }

    body { 
      background-color: var(--dark-bg); 
      font-family: sans-serif; 
      color: var(--text-light);
      padding-bottom: 80px; /* Espacio para scroll en m√≥viles */
    }

    h2 { 
      color: var(--text-light); 
      font-size: 1.5rem; 
      margin-bottom: 1.5rem;
    }

    /* Contenedor principal */
    .container {
      max-width: 100%;
      padding-left: 12px;
      padding-right: 12px;
    }

    @media (min-width: 768px) {
      .container {
        max-width: 800px;
      }
    }

    @media (min-width: 1200px) {
      .container {
        max-width: 1200px;
      }
    }

    /* Inputs y textareas */
    .form-control {
      background-color: var(--card-bg);
      color: var(--text-light);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      font-size: 0.9rem;
      padding: 0.5rem 0.75rem;
    }

    .form-control::placeholder {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* Cards */
    .card {
      background-color: var(--card-bg);
      color: var(--text-light);
      border: none;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    /* Botones */
    .btn-gradient {
      background: var(--gradient);
      color: var(--text-light);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-weight: bold;
      font-size: 0.85rem;
      box-shadow: 0 0 10px rgba(255,255,255,0.3);
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn-gradient:hover {
      transform: scale(1.03);
      box-shadow: 0 0 15px rgba(255,255,255,0.5);
    }

    .btn-gradient-sm {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    /* Fila de producto - Responsive */
    .fila-producto {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      align-items: start;
      padding: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    @media (max-width: 768px) {
      .fila-producto {
        grid-template-columns: 1fr 1fr;
        grid-template-areas: 
          "nombre nombre"
          "descripcion descripcion"
          "precio talles"
          "imagen acciones";
      }
      
      .fila-producto .col-3,
      .fila-producto .col-2 {
        width: 100% !important;
        max-width: 100% !important;
        margin-bottom: 0.5rem;
      }
      
      .fila-producto .nombre-input {
        grid-area: nombre;
      }
      
      .fila-producto .descripcion-input {
        grid-area: descripcion;
      }
      
      .fila-producto .precio-input {
        grid-area: precio;
      }
      
      .fila-producto .talles-input {
        grid-area: talles;
      }
      
      .fila-producto .imagen-actions {
        grid-area: imagen-acciones;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    }

    /* √Årea de imagen en m√≥vil */
    .imagen-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .preview-imagen {
      width: 60px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(255,255,255,0.05);
      border-radius: 4px;
      overflow: hidden;
    }

    .preview-imagen img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* Botones de acci√≥n peque√±os */
    .btn-action {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      min-width: auto;
    }

    /* Header de grupos/subgrupos */
    .grupo-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background-color: rgba(255,255,255,0.03);
      border-radius: 8px 8px 0 0;
    }

    .grupo-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0;
      flex: 1;
      min-width: 200px;
    }

    .grupo-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Contador */
    .contador {
      font-weight: bold;
      color: #ff6f61;
    }

    /* Input de subgrupos */
    .subgrupo-input-container {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
      padding: 0 0.75rem 0.75rem;
    }

    .subgrupo-input {
      flex: 1;
      min-width: 150px;
    }

    /* Carrusel modal para m√≥viles */
    @media (max-width: 768px) {
      #modalCarrusel .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
      }
      
      #carouselGlobal {
        padding: 0 20px;
      }
      
      #carouselGlobal .row-cols-4 {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 0.25rem;
      }
      
      .thumb-wrapper {
        width: 100%;
        height: 80px;
      }
      
      .carousel-control-prev,
      .carousel-control-next {
        width: 30px;
        height: 80px;
      }
      
      .carousel-control-prev {
        left: -30px;
      }
      
      .carousel-control-next {
        right: -30px;
      }
    }

    /* Spinner */
    .loader {
      border: 6px solid rgba(255,255,255,0.1);
      border-top: 6px solid #ff6f61;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mensaje final */
    .mensaje-final {
      margin-top: 2rem;
      font-size: 0.85rem;
      text-align: center;
      color: #ccc;
      padding: 1rem;
      background-color: rgba(255,255,255,0.03);
      border-radius: 8px;
    }

    /* Bot√≥n Continuar flotante en m√≥viles */
    @media (max-width: 768px) {
      .floating-continue {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.9);
        padding: 1rem;
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
      }
      
      .floating-continue .btn-gradient {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
      }
      
      body {
        padding-bottom: 120px; /* Espacio para el bot√≥n flotante */
      }
    }

    /* Scroll suave para m√≥viles */
    .scrollable-container {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Ajustes espec√≠ficos para inputs peque√±os */
    .input-sm {
      padding: 0.35rem 0.5rem;
      font-size: 0.8rem;
      height: auto;
    }

    /* Grid para productos importados */
    .import-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    @media (min-width: 768px) {
      .import-actions {
        flex-direction: row;
        align-items: center;
        justify-content: center;
      }
    }

    /* Tooltip personalizado */
    .info-tooltip {
      font-size: 0.75rem;
      color: #888;
      margin-top: 0.25rem;
    }

    /* Ajustes para textareas */
    textarea.form-control {
      min-height: 60px;
      resize: vertical;
    }

    @media (max-width: 768px) {
      textarea.form-control {
        min-height: 45px;
      }
    }

    /* Estado de carga */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    /* Clases utilitarias */
    .text-tiny {
      font-size: 0.75rem;
    }

    .mb-1 {
      margin-bottom: 0.5rem !important;
    }

    .mb-2 {
      margin-bottom: 1rem !important;
    }

    .mb-3 {
      margin-bottom: 1.5rem !important;
    }

    .mt-1 {
      margin-top: 0.5rem !important;
    }

    .mt-2 {
      margin-top: 1rem !important;
    }

    .mt-3 {
      margin-top: 1.5rem !important;
    }

    .px-1 {
      padding-left: 0.5rem !important;
      padding-right: 0.5rem !important;
    }

    .py-1 {
      padding-top: 0.5rem !important;
      padding-bottom: 0.5rem !important;
    }
  </style>
</head>
<body>
<div class="container py-3 py-md-4">
  <h2 class="mb-3 text-center">Carg√° el contenido de tu sitio</h2>

  <!-- Importar productos -->
  <div class="import-actions mb-3">
    <input type="file" id="archivoProductos" 
           accept=".csv,.txt,.xls,.xlsx" 
           class="form-control w-100 w-md-50 mx-auto mb-2 mb-md-0">
    <button type="button" class="btn-gradient btn-gradient-sm" onclick="leerArchivoProductos()">
      üìÇ Importar productos
    </button>
  </div>

  <!-- Crear grupo -->
  <div class="mb-3 text-center">
    <input type="text" id="nombreGrupo" class="form-control w-100 w-md-50 mx-auto mb-2" 
           placeholder="Nombre del grupo (ej: Ropa Mujer)">
    <button type="button" class="btn-gradient btn-gradient-sm" onclick="crearGrupo()">
      + Crear grupo
    </button>
  </div>

  <form id="formulario" method="POST" action="/contenido" enctype="multipart/form-data"
        onsubmit="return confirmarContinuar()">
    
    <div class="scrollable-container" id="grupos-container">
      <div id="grupos"></div>
    </div>

    <!-- Bot√≥n continuar desktop -->
    <div class="text-center mt-3 d-none d-md-block">
      <button id="btnContinuar" type="submit" class="btn-gradient px-4 py-2">
        Continuar
      </button>
    </div>
  </form>
  
  <!-- Mensaje final -->
  <div class="mensaje-final mt-3">
    ¬øTen√©s mucho contenido? 
    <a href="#" style="color: #00c853; text-decoration: underline;">Cont√°ctanos para ayudarte</a>
    <br>
    <span class="text-tiny mt-1 d-block">
      ‚ö†Ô∏è Si contin√∫as, podr√≠as perder todo el contenido al intentar volver a esta p√°gina.
    </span>
  </div>
</div>

<!-- Bot√≥n continuar flotante m√≥vil -->
<div class="floating-continue d-md-none">
  <button id="btnContinuarMobile" type="button" class="btn-gradient" onclick="validarYEnviar()">
    Continuar
  </button>
</div>

<!-- Spinner -->
<div id="spinner" class="loading-overlay">
  <div class="loader"></div>
  <p class="mt-2">Procesando im√°genes‚Ä¶</p>
</div>

<!-- Modal carrusel -->
<div class="modal fade" id="modalCarrusel" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Eleg√≠ una imagen</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div style="padding: 0 10px;">
          <div id="carouselGlobal" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              <!-- thumbnails se insertan din√°micamente -->
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselGlobal" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselGlobal" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-gradient" onclick="confirmarImagen()">Usar esta imagen</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Variable para rastrear el √∫ltimo ID de grupo generado din√°micamente
  let ultimoGrupoId = 0;
  
  // Variables globales (se mantienen igual)
  let grupoId = 0;
  let contadorOrden = 1;
  let imagenSeleccionada = null;
  let filaActual = null;
  let imagenesUsadas = [];

  // üîë Ahora las im√°genes ya vienen con URL completa desde GCS
  const imagenesDisponibles = {{ imagenes_step0 | tojson | safe }};
  console.log("üß† imagenesDisponibles:", imagenesDisponibles);

  function eliminarProducto(boton) {
    const fila = boton.closest('.fila-producto');
    const grupo = boton.closest('.card');
    fila.remove();
    actualizarContador(grupo);
  }
    
  const LS_KEY = "step3_state";
  
  // Funci√≥n que arma el JSON y lo guarda en localStorage
  function saveState() {
    const state = { grupos: [], imagenesUsadas: [...imagenesUsadas] };

    document.querySelectorAll(".card:not(.subgrupo)").forEach(grupoCard => {
      const nombreGrupo = grupoCard.querySelector("h4")?.textContent?.trim() || "Sin nombre";

      const productosGrupo = [...grupoCard.querySelectorAll(".productos > .fila-producto")].map(fila => filaToObj(fila));

      const subgrupos = [...grupoCard.querySelectorAll(".subgrupo")].map(subCard => {
        const nombreSub = subCard.querySelector(".nombre-subgrupo")?.textContent?.trim() || "Sin subgrupo";
        const productosSub = [...subCard.querySelectorAll(".productos > .fila-producto")].map(fila => filaToObj(fila));
        return { nombre: nombreSub, productos: productosSub };
      });

      state.grupos.push({ nombre: nombreGrupo, productos: productosGrupo, subgrupos });
    });

    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  // Debounce wrapper
  const saveStateDebounced = (() => {
    let t;
    return function() {
      clearTimeout(t);
      t = setTimeout(() => saveState(), 200);
    }
  })();

  function confirmarContinuar() {
    return confirm("Se enviar√°n los datos, ¬ødese√°s continuar?");
  }
  
  // Utilidad para convertir fila en objeto
  function filaToObj(fila) {
    return {
      nombre: fila.querySelector("input[name='nombre']")?.value || "",
      descripcion: fila.querySelector("textarea[name='descripcion']")?.value || "",
      precio: fila.querySelector("input[name='precio']")?.value || "",
      talles: fila.querySelector("input[name='talles']")?.value || "",
      imagen_url: fila.querySelector("input[name='imagen_elegida']")?.value || "",
      imagen_basename: fila.querySelector("input[name='imagen_basename']")?.value || ""
    };
  }
  
  function generarFilasDesdeListas(listas) {
    listas.forEach(item => {
      const { grupo, subgrupo, cantidad, talles } = item;
      const nombreGrupo = grupo || "General";

      // Crear grupo si no existe
      let grupoCard = [...document.querySelectorAll(".card:not(.subgrupo)")].find(
        c => c.querySelector("h4")?.textContent.trim() === nombreGrupo
      );
      if (!grupoCard) {
        const inputGrupo = document.getElementById("nombreGrupo");
        if (inputGrupo) {
          inputGrupo.value = nombreGrupo;
          crearGrupo();
          grupoCard = [...document.querySelectorAll(".card:not(.subgrupo)")].find(
            c => c.querySelector("h4")?.textContent.trim() === nombreGrupo
          );
        }
      }

      // Crear subgrupo si corresponde
      let subgrupoCard = grupoCard;
      if (subgrupo) {
        const grupoIdx = grupoCard.id.split("_")[1];
        const inputSub = grupoCard.querySelector(`#inputSubgrupo_${grupoIdx}`);
        const btnCrearSub = grupoCard.querySelector("button[onclick^='crearSubgrupo']");
        if (inputSub && btnCrearSub) {
          inputSub.value = subgrupo;
          crearSubgrupo(btnCrearSub);
          subgrupoCard = [...grupoCard.querySelectorAll(".subgrupo")].find(
            s => s.querySelector(".nombre-subgrupo")?.textContent.trim() === subgrupo
          );
        }
      }

      // Crear filas seg√∫n cantidad
      const contenedor = subgrupoCard.querySelector(".productos");
      const cant = parseInt(cantidad, 10) || 1;
      for (let i = 0; i < cant; i++) {
        const fila = crearFila(subgrupo || "General", nombreGrupo);
        fila.querySelector("input[name='talles']").value = talles || "";
        contenedor.appendChild(fila);
      }
      actualizarContador(contenedor);
    });

    saveStateDebounced();
  }
  
  function crearGrupo() {
    const nombre = document.getElementById('nombreGrupo').value.trim();
    if (!nombre) return alert("Ingres√° un nombre para el grupo");

    grupoId++;
    ultimoGrupoId = grupoId;
    const ordenGrupo = grupoId;

    const grupo = document.createElement('div');
    grupo.className = 'card mb-3';
    grupo.id = 'grupo_' + grupoId;
    grupo.setAttribute('data-orden', ordenGrupo);

    grupo.innerHTML = `
      <div class="grupo-header">
        <h4 class="grupo-title mb-0">${nombre}</h4>
        <div class="grupo-actions">
          <button type="button" class="btn btn-sm btn-outline-light btn-action" onclick="editarNombreGrupo(this)">
            ‚úèÔ∏è
          </button>
          <button type="button" class="btn btn-sm btn-danger btn-action" onclick="eliminarGrupo(this)">
            ‚úï
          </button>
        </div>
      </div>
      
      <div class="card-body p-2">
        <div class="productos mb-2"></div>
        
        <!-- Bot√≥n para agregar fila directamente al grupo -->
        <div class="text-center mb-2">
          <button type="button" class="btn-gradient btn-gradient-sm" onclick="agregarFila(this)">
            + Agregar producto
          </button>
        </div>
        
        <div class="subgrupos"></div>
        
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="text-tiny text-muted">Productos: <span class="contador">0</span></div>
        </div>
        
        <!-- Crear subgrupo -->
        <div class="subgrupo-input-container">
          <input type="text" class="form-control input-sm subgrupo-input" 
                 placeholder="Nombre subgrupo" id="inputSubgrupo_${grupoId}">
          <button type="button" class="btn-gradient btn-gradient-sm" onclick="crearSubgrupo(this)">
            + Subgrupo
          </button>
        </div>
      </div>
    `;

    document.getElementById('grupos').appendChild(grupo);
    document.getElementById('nombreGrupo').value = '';
    
    saveStateDebounced();
  }
  
  function hydrateFila(filaData, filaEl) {
    console.log("üü¢ [Step3] hydrateFila ‚Üí", filaData);

    // Restaurar imagen elegida
    if (filaData.imagen_elegida) {
      filaEl.querySelector("input[name='imagen_elegida']").value = filaData.imagen_elegida;
      filaEl.querySelector(".preview-imagen").innerHTML =
        `<img src="${filaData.imagen_elegida}" style="width:100%;height:100%;object-fit:contain;">`;
    }

    // Restaurar basename
    if (filaData.imagen_basename) {
      let hiddenBase = filaEl.querySelector("input[name='imagen_basename']");
      if (!hiddenBase) {
        hiddenBase = document.createElement("input");
        hiddenBase.type = "hidden";
        hiddenBase.name = "imagen_basename";
        filaEl.appendChild(hiddenBase);
      }
      hiddenBase.value = filaData.imagen_basename;
    }
  }

  function editarNombreGrupo(btn) {
    const card = btn.closest('.card');
    const h4 = card.querySelector('.grupo-title');
    const valorActual = h4.textContent.trim();

    const input = document.createElement('input');
    input.type = 'text';
    input.value = valorActual;
    input.className = 'form-control form-control-sm d-inline-block w-auto';

    input.onblur = () => guardarNombreGrupo(card, input.value);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') input.blur();
    });

    h4.replaceWith(input);
    input.focus();
    saveStateDebounced();
  }

  function guardarNombreGrupo(card, nuevoNombre) {
    const h4 = document.createElement('h4');
    h4.className = 'grupo-title mb-0';
    h4.textContent = nuevoNombre || 'Sin nombre';

    const input = card.querySelector('input[type="text"]');
    if (input) input.replaceWith(h4);

    // ‚úÖ Actualizar hidden inputs de todas las filas dentro del grupo
    card.querySelectorAll('input[name="grupo"]').forEach(h => h.value = nuevoNombre);
    saveStateDebounced();
  }

  function actualizarContador(elemento) {
    const card = elemento.classList.contains('productos')
      ? elemento.closest('.card')
      : elemento;

    const contador = card.querySelector('.contador');
    const productos = card.querySelectorAll('.productos > .fila-producto');
    contador.textContent = productos.length;
  }

  function agregarSlide(items, makeActive) {
    const contenedor = document.querySelector("#carouselGlobal .carousel-inner");
    const div = document.createElement("div");
    div.className = "carousel-item" + (makeActive ? " active" : "");
    const row = document.createElement("div");
    row.className = "row row-cols-4 gx-2 gy-2";

    items.forEach(({ nombre, imagen_url }) => {
      const col = document.createElement("div");
      col.className = "col";
      col.innerHTML = `
        <div class="thumb-wrapper">
          <img src="${imagen_url}" class="imagen-carrusel" alt="${nombre}"
               data-nombre="${nombre}" data-url="${imagen_url}"
               loading="lazy"
               onclick="seleccionarImagen(this)">
        </div>`;
      row.appendChild(col);
    });

    // Rellenar hasta 8 columnas
    const faltantes = 8 - items.length;
    for (let i = 0; i < faltantes; i++) {
      const colInv = document.createElement("div");
      colInv.className = "col invisible";
      colInv.innerHTML = `<div class="thumb-wrapper"></div>`;
      row.appendChild(colInv);
    }

    div.appendChild(row);
    contenedor.appendChild(div);
  }
  
  function abrirCarrusel(btn) {
    filaActual = btn.closest('.fila-producto');
    const modal = new bootstrap.Modal(document.getElementById('modalCarrusel'));

    console.log("üü¢ [Step3] abrirCarrusel ‚Üí filaActual:", filaActual);

    // Si el carrusel est√° vac√≠o, inicializarlo
    if (!document.querySelector("#carouselGlobal .carousel-item")) {
      console.warn("‚ö†Ô∏è [Step3] Carrusel vac√≠o, inicializando...");
      inicializarCarrusel();
    }

    // Limpiar selecci√≥n previa
    document.querySelectorAll('#carouselGlobal .thumb-wrapper')
      .forEach(w => w.classList.remove('seleccionada'));

    // ‚úÖ Recuperar im√°genes usadas globalmente
    let usadasGlobal = JSON.parse(localStorage.getItem("imagenesUsadas") || "[]");
    if (!Array.isArray(usadasGlobal)) usadasGlobal = [];

    // Deshabilitar im√°genes ya usadas en todo el cat√°logo
    document.querySelectorAll('#carouselGlobal .carousel-item img').forEach(img => {
      const nombre = img.dataset.nombre;
      if (usadasGlobal.includes(nombre)) {
        img.classList.add("usada");
        img.style.opacity = "0.25";
        img.style.filter = "grayscale(100%) brightness(0.6)";
        img.style.pointerEvents = "none";
        console.log("üö´ [Step3] Imagen marcada como usada:", nombre);
      } else {
        img.classList.remove("usada");
        img.style.opacity = "1";
        img.style.filter = "none";
        img.style.pointerEvents = "auto";
      }
    });

    // Si la fila ya ten√≠a imagen elegida, remarcarla
    const hiddenBase = filaActual.querySelector("input[name='imagen_basename']");
    if (hiddenBase && hiddenBase.value) {
      const nombreActual = hiddenBase.value;
      console.log("üìå [Step3] Fila ya ten√≠a imagen:", nombreActual);
      const imgActual = document.querySelector(`#carouselGlobal img[data-nombre="${nombreActual}"]`);
      if (imgActual) {
        seleccionarImagen(imgActual);
        console.log("üéØ [Step3] Imagen marcada como seleccionada:", nombreActual);
      } else {
        console.warn("‚ö†Ô∏è [Step3] No se encontr√≥ imgActual para:", nombreActual);
      }
    } else {
      // Seleccionar la primera disponible si no hab√≠a nada
      const firstImg = document.querySelector("#carouselGlobal .carousel-item.active img:not(.usada)");
      if (firstImg) {
        console.log("‚úÖ [Step3] Seleccionando primera disponible:", firstImg.dataset.nombre);
        seleccionarImagen(firstImg);
      } else {
        console.warn("‚ö†Ô∏è [Step3] No hay imagen disponible para seleccionar");
      }
    }

    console.log("üìÇ [Step3] Abriendo carrusel para fila:", filaActual);
    modal.show();
  }

  function inicializarCarrusel() {
    const contenedor = document.querySelector("#carouselGlobal .carousel-inner");
    contenedor.innerHTML = ""; // limpiar carrusel

    cargarImagenesDesdeIndexedDB((count) => {
      if (count > 0) {
        console.log("üì¶ [Step3] Carrusel restaurado desde IndexedDB con", count, "im√°genes");
      } else {
        // Fallback: usar rutas finales guardadas en localStorage (ya son URLs completas de GCS)
        const imagenesFinales = JSON.parse(localStorage.getItem("imagenes_step0") || "[]");
        if (Array.isArray(imagenesFinales) && imagenesFinales.length) {
          let first = true, buffer = [];

          imagenesFinales.forEach(ruta => {
            if (!ruta) return;

            // üîë basename siempre ser√° el UUID.webp al final de la URL
            const basename = ruta.split("/").pop();
            const imagen_url = ruta;

            buffer.push({ nombre: basename, imagen_url });
            console.log("‚ûï [Step3] Imagen agregada al buffer:", { nombre: basename, imagen_url });

            if (buffer.length === 8) {
              agregarSlide(buffer, first);
              console.log("üñºÔ∏è [Step3] Slide agregado con 8 im√°genes");
              first = false;
              buffer = [];
            }
          });

          if (buffer.length) {
            agregarSlide(buffer, first);
            console.log("üñºÔ∏è [Step3] Slide final agregado con", buffer.length, "im√°genes");
          }
          console.log("üì¶ [Step3] Carrusel inicializado con im√°genes finales:", imagenesFinales.length);
        } else {
          console.warn("‚ö†Ô∏è [Step3] No hay im√°genes en localStorage.imagenes_step0");
        }
      }

      // Selecci√≥n inicial
      const firstImg = document.querySelector('#carouselGlobal .carousel-item.active img:not(.usada)');
      if (firstImg) {
        seleccionarImagen(firstImg);
        console.log("‚úÖ [Step3] Selecci√≥n inicial:", window.imagenSeleccionada, window.imagenSeleccionadaUrl);
      }
    });
  }

  function leerArchivoProductos() {
    const input = document.getElementById("archivoProductos");
    if (!input.files.length) {
      alert("‚ö†Ô∏è Seleccion√° un archivo primero");
      return;
    }

    const file = input.files[0];
    const ext = file.name.toLowerCase().split('.').pop();
    let filasAgregadas = 0;

    const procesarFila = (grupo, subgrupo, productoBase, descripcion, precio, talles, cantidadRaw) => {
      const cantidad = parseInt(cantidadRaw || "1", 10);

      // Lista de productos separados por coma
      let productos = productoBase ? productoBase.split(",").map(p => p.trim()).filter(Boolean) : [];

      // Caso 1: varios productos expl√≠citos ‚Üí se respetan tal cual
      if (productos.length > 1) {
        // no se aplica cantidad
      }
      // Caso 2: un solo producto + Filas > 1 ‚Üí numerar
      else if (productos.length === 1 && cantidad > 1) {
        const base = productos[0];
        productos = [];
        for (let i = 1; i <= cantidad; i++) {
          productos.push(`${base}${i}`);
        }
      }
      // Caso 3: sin producto pero con cantidad ‚Üí usar grupo como base
      else if (productos.length === 0 && cantidad > 0) {
        const base = grupo || "Gen√©rico";   // ‚ö†Ô∏è corregido: ya no usa subgrupo
        productos = [];
        for (let i = 1; i <= cantidad; i++) {
          productos.push(`${base}${i}`);
        }
      }

      // Expandir talles si existen
      const listaTalles = talles ? talles.split(",").map(t => t.trim()).filter(Boolean) : [];

      if (listaTalles.length > 0) {
        productos.forEach(prod => {
          listaTalles.forEach(talle => {
            agregarFilaImportada(prod, descripcion, precio, grupo, subgrupo, talle);
            filasAgregadas++;
          });
        });
      } else {
        productos.forEach(prod => {
          agregarFilaImportada(prod, descripcion, precio, grupo, subgrupo, talles);
          filasAgregadas++;
        });
      }
    };

    // üëâ CSV / TXT
    if (ext === "csv" || ext === "txt") {
      const reader = new FileReader();
      reader.onload = function(e) {
        const contenido = e.target.result;
        const lineas = contenido.split(/\r?\n/).filter(l => l.trim());
        const sep = lineas.some(l => l.includes(";")) ? ";" : ",";

        lineas.forEach((linea, idx) => {
          const partes = linea.split(sep).map(p => p.trim());
          const nombre      = partes[0] || "";
          const descripcion = partes[1] || "";
          const precio      = partes[2] || "";
          const grupo       = partes[3] || "";
          const subgrupo    = partes[4] || "";
          const talles      = partes[5] || "";
          const filas       = partes[6] || "1"; // opcional columna Filas

          if (!grupo) {
            console.warn("‚ö†Ô∏è L√≠nea descartada por falta de grupo:", partes);
            return;
          }

          procesarFila(grupo, subgrupo, nombre, descripcion, precio, talles, filas);
        });

        alert(filasAgregadas > 0
          ? `‚úÖ Productos importados: ${filasAgregadas}`
          : "‚ùå No se importaron filas desde CSV/TXT");
      };
      reader.readAsText(file);
    }

    // üëâ Excel XLS / XLSX
    else if (ext === "xls" || ext === "xlsx") {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws);

        rows.forEach((obj, idx) => {
          const grupo       = obj.Grupo       || obj.Categoria    || "";
          const subgrupo    = obj.Subgrupo    || obj.Subcategoria || "";
          const nombre      = obj.Nombre      || obj.Producto     || "";
          const descripcion = obj.Descripcion || "";
          const precio      = obj.Precio      || "";
          const talles      = obj.Talles      || "";
          const filas       = obj.Filas       || "1";

          if (!grupo) {
            console.warn("‚ö†Ô∏è Fila descartada por falta de grupo:", obj);
            return;
          }

          procesarFila(grupo, subgrupo, nombre, descripcion, precio, talles, filas);
        });

        alert(filasAgregadas > 0
          ? `‚úÖ Productos importados desde Excel: ${filasAgregadas}`
          : "‚ùå No se importaron filas desde Excel");
      };
      reader.readAsArrayBuffer(file);
    }

    else {
      alert("‚ö†Ô∏è Formato no soportado. Sub√≠ CSV, TXT o Excel (.xls/.xlsx)");
    }
  }

  function agregarFilaImportada(nombre, descripcion, precio, grupo, subgrupo, talles) {
    // Buscar o crear grupo
    let grupoCard = [...document.querySelectorAll(".card:not(.subgrupo)")].find(
      c => c.querySelector("h4")?.textContent.trim() === grupo
    );
    if (!grupoCard) {
      const inputGrupo = document.getElementById("nombreGrupo");
      if (inputGrupo) {
        inputGrupo.value = grupo;
        crearGrupo();
        grupoCard = [...document.querySelectorAll(".card:not(.subgrupo)")].find(
          c => c.querySelector("h4")?.textContent.trim() === grupo
        );
      }
    }

    // Buscar o crear subgrupo (solo si se especifica)
    let subgrupoCard = null;
    if (subgrupo) {
      subgrupoCard = grupoCard && [...grupoCard.querySelectorAll(".subgrupo")].find(
        s => s.querySelector("strong")?.textContent.trim() === subgrupo
      );
      if (!subgrupoCard && grupoCard) {
        const grupoIdx = grupoCard.id.split("_")[1];
        const inputSub = grupoCard.querySelector(`#inputSubgrupo_${grupoIdx}`);
        const btnCrearSub = grupoCard.querySelector("button[onclick^='crearSubgrupo']");
        if (inputSub && btnCrearSub) {
          inputSub.value = subgrupo;
          crearSubgrupo(btnCrearSub);
          subgrupoCard = [...grupoCard.querySelectorAll(".subgrupo")].find(
            s => s.querySelector("strong")?.textContent.trim() === subgrupo
          );
        }
      }
    }

    // üëâ Si no hay subgrupo, usamos directamente el grupo como contenedor
    if (!subgrupoCard) {
      subgrupoCard = grupoCard;
    }

    if (!subgrupoCard) {
      console.warn("‚ö†Ô∏è No se pudo crear/ubicar grupo/subgrupo:", grupo, subgrupo);
      return;
    }

    // Crear fila y rellenar datos
    const fila = crearFila(subgrupo || grupo, grupo);
    fila.querySelector("input[name='nombre']").value = nombre;
    fila.querySelector("textarea[name='descripcion']").value = descripcion;
    fila.querySelector("input[name='precio']").value = precio;
    fila.querySelector("input[name='talles']").value = talles;

    // üëâ Insertar fila en el contenedor correcto
    const contenedor = subgrupoCard.querySelector(".productos");
    if (contenedor) {
      contenedor.appendChild(fila);
    } else {
      subgrupoCard.appendChild(fila);
    }

    actualizarContador(subgrupoCard);
    saveStateDebounced();
  }

  function ensureDB(callback) {
      const request = indexedDB.open("imagenesDB", 3);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("imagenes")) {
          db.createObjectStore("imagenes");
          console.log("üì¶ Store 'imagenes' creado (upgrade)");
        }
      };
      request.onsuccess = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("imagenes")) {
          console.warn("‚ö†Ô∏è DB sin store. Borrando y recreando‚Ä¶");
          db.close();
          const del = indexedDB.deleteDatabase("imagenesDB");
          del.onsuccess = () => {
            const re = indexedDB.open("imagenesDB", 2);
            re.onupgradeneeded = ev => ev.target.result.createObjectStore("imagenes");
            re.onsuccess = ev => callback(ev.target.result);
          };
          del.onerror = () => { console.error("‚ùå No se pudo borrar la DB"); callback(db); };
        } else {
          callback(db);
        }
      };
      request.onerror = e => console.error("‚ùå Error abriendo IndexedDB:", e.target.error);
    }
    
  function cargarImagenesDesdeIndexedDB(done) {
    console.log("üöÄ [IndexedDB] Iniciando carga de im√°genes desde IndexedDB");

    ensureDB(db => {
      const tx = db.transaction("imagenes", "readonly");
      const store = tx.objectStore("imagenes");
      const lista = JSON.parse(localStorage.getItem("imagenesLista") || "[]");
      console.log("üìå [IndexedDB] Lista de nombres en localStorage.imagenesLista:", lista);

      let first = true, buffer = [];
      let count = 0;

      lista.forEach(nombreOriginal => {
        console.log("‚û°Ô∏è [IndexedDB] Procesando nombre:", nombreOriginal);
        const getReq = store.get(nombreOriginal);

        getReq.onsuccess = e => {
          const blob = e.target.result;
          if (blob) {
            console.log("‚úÖ [IndexedDB] Blob encontrado para:", nombreOriginal);

            // üîë Usar mapping para obtener nombre final (UUID.webp)
            const mapping = JSON.parse(localStorage.getItem("imagenes_mapping") || "{}");
            const nombreGenerado = mapping[nombreOriginal];
            console.log("üìå [IndexedDB] Mapping lookup:", nombreOriginal, "‚Üí", nombreGenerado);

            let imagen_url;
            if (nombreGenerado && nombreGenerado !== nombreOriginal) {
              // ‚úÖ Construir URL p√∫blica de GCS con email codificado
              const bucket = "mpagina";
              const email = localStorage.getItem("email") || "anonimo";
              const email_encoded = email.replace("@", "%40");
              console.log("üìå [IndexedDB] Email usado para URL:", email_encoded);
              imagen_url = `https://storage.googleapis.com/${bucket}/${email_encoded}/${nombreGenerado}`;
              console.log("üîó [IndexedDB] URL construida con UUID:", imagen_url);

              buffer.push({ nombre: nombreGenerado, imagen_url });
            } else {
              // ‚ö†Ô∏è Mapping no tiene UUID ‚Üí intentar usar rutas finales de step0
              const rutasStep0 = JSON.parse(localStorage.getItem("imagenes_step0") || "[]");
              const rutaUUID = rutasStep0.find(r => r.includes(nombreOriginal.split(".")[0])) || null;

              if (rutaUUID) {
                const basename = rutaUUID.split("/").pop();
                console.log("üîÑ [IndexedDB] Fallback a imagenes_step0:", rutaUUID);
                buffer.push({ nombre: basename, imagen_url: rutaUUID });
              } else {
                imagen_url = "/static/img/fallback.webp";
                console.warn("‚ö†Ô∏è [IndexedDB] No se encontr√≥ UUID para", nombreOriginal, "‚Üí usando fallback gen√©rico");
                buffer.push({ nombre: nombreOriginal, imagen_url });
              }
            }

            count++;
            console.log("üì¶ [IndexedDB] Buffer actualizado:", buffer);

            if (buffer.length === 8) {
              agregarSlide(buffer, first);
              console.log("üñºÔ∏è [IndexedDB] Slide agregado con 8 im√°genes");
              first = false;
              buffer = [];
            }
          } else {
            console.warn("‚ö†Ô∏è [IndexedDB] No se encontr√≥ blob para:", nombreOriginal);
          }
        };

        getReq.onerror = err => console.error("‚ùå [IndexedDB] Error leyendo imagen:", nombreOriginal, err.target.error);
      });

      tx.oncomplete = () => {
        if (buffer.length) {
          agregarSlide(buffer, first);
          console.log("üñºÔ∏è [IndexedDB] Slide final agregado con", buffer.length, "im√°genes");
        }
        console.log("üìä [IndexedDB] Total im√°genes cargadas:", count);
        done(count); // cantidad cargada desde IndexedDB
      };
    });
  }
  
  function crearSubgrupo(btn) {
    const grupo = btn.closest('.card');
    const nombreGrupo = grupo.querySelector('h4')?.textContent?.trim() || 'General';
    const subgruposContenedor = grupo.querySelector('.subgrupos');
    const input = grupo.querySelector('input[id^="inputSubgrupo"]');
    const nombreSubgrupo = input.value.trim();
    if (!nombreSubgrupo) return alert("Ingres√° un nombre para el subgrupo");

    const subgrupo = document.createElement('div');
    subgrupo.className = 'card p-2 mb-2 subgrupo';
    subgrupo.innerHTML = `
      <div class="grupo-header">
        <strong class="grupo-title text-tiny">${nombreSubgrupo}</strong>
        <div class="grupo-actions">
          <button class="btn btn-sm btn-outline-light btn-action" onclick="editarNombreSubgrupo(this)">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger btn-action" onclick="eliminarSubgrupo(this)">‚úï</button>
        </div>
      </div>
      <div class="card-body p-1">
        <div class="productos mb-1"></div>
        <div class="text-center mb-1">
          <button type="button" class="btn-gradient btn-gradient-sm" onclick="agregarFila(this)">
            + Producto
          </button>
        </div>
        <div class="text-end text-tiny text-muted">Productos: <span class="contador">0</span></div>
      </div>
    `;
    subgruposContenedor.appendChild(subgrupo);
    input.value = '';

    const contenedor = subgrupo.querySelector('.productos');
    const fila = crearFila(nombreSubgrupo, nombreGrupo);
    contenedor.appendChild(fila);

    actualizarContador(subgrupo);

    // ‚úÖ Guardar estado despu√©s de crear el subgrupo y su primera fila
    saveStateDebounced();
  }

  function editarNombreSubgrupo(btn) {
    const card = btn.closest('.subgrupo');
    const strong = card.querySelector('.grupo-title');
    const valorActual = strong.textContent.trim();

    const input = document.createElement('input');
    input.type = 'text';
    input.value = valorActual;
    input.className = 'form-control form-control-sm d-inline-block w-auto';

    input.onblur = () => guardarNombreSubgrupo(card, input.value);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') input.blur();
    });

    strong.replaceWith(input);
    input.focus();
    saveStateDebounced();
  }

  function guardarNombreSubgrupo(card, nuevoNombre) {
    const strong = document.createElement('strong');
    strong.className = 'grupo-title text-tiny';
    strong.textContent = nuevoNombre || 'Sin subgrupo';

    const input = card.querySelector('input[type="text"]');
    if (input) input.replaceWith(strong);

    // ‚úÖ Actualizar hidden inputs de todas las filas dentro del subgrupo
    card.querySelectorAll('input[name="subgrupo"]').forEach(h => h.value = nuevoNombre);
    saveStateDebounced();
  }

  function crearFila(nombreSubgrupo, nombreGrupo = 'General') {
    const fila = document.createElement('div');
    fila.className = 'fila-producto';

    fila.innerHTML = `
      <div class="col-3 nombre-input">
        <input type="text" name="nombre" class="form-control input-sm" placeholder="Nombre" required>
      </div>
      <div class="col-3 descripcion-input">
        <textarea name="descripcion" class="form-control input-sm" rows="1" placeholder="Descripci√≥n (opcional)"></textarea>
      </div>
      <div class="col-2 precio-input">
        <input type="text" name="precio" class="form-control input-sm" placeholder="$" required>
      </div>
      <div class="col-2 talles-input">
        <input type="text" name="talles" class="form-control input-sm" placeholder="Talles (opcional)">
      </div>
      <div class="col-2 imagen-actions">
        <div class="preview-imagen"></div>
        <div class="d-flex flex-column gap-1">
          <button type="button" class="btn btn-sm btn-gradient btn-action" onclick="abrirCarrusel(this)">
            Imagen
          </button>
          <button type="button" class="btn btn-sm btn-danger btn-action" onclick="eliminarFila(this)">
            ‚úï
          </button>
        </div>
        <input type="hidden" name="grupo" value="${nombreGrupo}">
        <input type="hidden" name="subgrupo" value="${nombreSubgrupo}">
        <input type="hidden" name="orden" value="${contadorOrden++}">
        <input type="hidden" name="imagen_elegida" value="">
      </div>
    `;

    return fila;
  }

  function agregarFila(btn) {
    const subgrupo = btn.closest('.subgrupo');
    const grupo = btn.closest('.card:not(.subgrupo)');
    let contenedor, nombreSubgrupo, nombreGrupo;

    if (subgrupo) {
      contenedor = subgrupo.querySelector('.productos');
      nombreSubgrupo = subgrupo.querySelector('strong')?.textContent?.trim() || 'Sin subgrupo';
      nombreGrupo = grupo.querySelector('h4')?.textContent?.trim() || 'General';
    } else {
      contenedor = grupo.querySelector('.productos');
      nombreSubgrupo = 'General';
      nombreGrupo = grupo.querySelector('h4')?.textContent?.trim() || 'General';
    }

    const fila = crearFila(nombreSubgrupo, nombreGrupo);
    contenedor.appendChild(fila);

    actualizarContador(contenedor);
    saveStateDebounced();
  }

  function eliminarSubgrupo(btn) {
    const subgrupo = btn.closest('.subgrupo');

    // liberar im√°genes del subgrupo
    let usadas = JSON.parse(localStorage.getItem("imagenesUsadas") || "[]");
    if (!Array.isArray(usadas)) usadas = [];

    subgrupo.querySelectorAll('.fila-producto').forEach(fila => {
      const hiddenBase = fila.querySelector('input[name="imagen_basename"]');
      const basename = hiddenBase?.value || "";
      if (!basename) return;

      // quitar del array global
      usadas = usadas.filter(n => n !== basename);

      // liberar en carrusel
      const img = document.querySelector(`#carouselGlobal img[data-nombre="${basename}"]`);
      if (img) {
        img.classList.remove('usada');
        img.style.opacity = "1";
        img.style.filter = "none";
        img.style.pointerEvents = "auto";
      }
    });

    localStorage.setItem("imagenesUsadas", JSON.stringify(usadas));
    marcarImagenesUsadas();

    subgrupo.remove();
    saveStateDebounced();
  }

  function eliminarFila(btn) {
    const fila = btn.closest('.fila-producto');
    const contenedor = btn.closest('.card').querySelector('.productos');

    const hiddenBase = fila.querySelector('input[name="imagen_basename"]');
    const basename = hiddenBase ? hiddenBase.value : "";

    if (basename) {
      // Liberar imagen en carrusel
      document.querySelectorAll('#carouselGlobal .carousel-item img').forEach(img => {
        if (img.dataset.nombre === basename) {
          img.classList.remove('usada');
          img.style.opacity = "1";
          img.style.filter = "none";
          img.style.pointerEvents = "auto";
          console.log(`üîì [Step3] Imagen liberada: ${basename}`);
        }
      });

      // üîß CORRECCI√ìN: Actualizar la variable GLOBAL `imagenesUsadas`
      // Primero obtener el array actual
      let usadasActuales = JSON.parse(localStorage.getItem("imagenesUsadas") || "[]");
      
      // Filtrar para quitar la imagen eliminada
      usadasActuales = usadasActuales.filter(n => n !== basename);
      
      // üîß Actualizar tanto localStorage como la variable global
      localStorage.setItem("imagenesUsadas", JSON.stringify(usadasActuales));
      imagenesUsadas = usadasActuales; // Esto sincroniza la variable global

      console.log(`üîÑ [Step3] imagenesUsadas actualizado (quitado ${basename}):`, imagenesUsadas);
    }

    // Eliminar fila si hay m√°s de una
    if (contenedor.querySelectorAll('.fila-producto').length > 1) {
      fila.remove();
      actualizarContador(contenedor);
      console.log("‚úÖ [Step3] Fila eliminada");
    } else {
      alert("No se puede eliminar la √∫ltima fila");
      console.warn("‚ö†Ô∏è [Step3] Intento de eliminar la √∫ltima fila bloqueado");
    }

    saveStateDebounced();
  }

  function eliminarGrupo(btn) {
    const grupo = btn.closest('.card');

    // Obtener array actual de im√°genes usadas
    let usadasActuales = JSON.parse(localStorage.getItem("imagenesUsadas") || "[]");
    
    // üîé Buscar todas las filas dentro del grupo
    grupo.querySelectorAll('.fila-producto').forEach(fila => {
      const hiddenBase = fila.querySelector('input[name="imagen_basename"]');
      const basename = hiddenBase ? hiddenBase.value : "";

      if (basename) {
        // Liberar imagen en carrusel
        document.querySelectorAll('#carouselGlobal .carousel-item img').forEach(img => {
          if (img.dataset.nombre === basename) {
            img.classList.remove('usada');
            img.style.opacity = "1";
            img.style.filter = "none";
            img.style.pointerEvents = "auto";
            console.log(`üîì [Step3] Imagen liberada al eliminar grupo: ${basename}`);
          }
        });

        // Quitar de la lista local
        usadasActuales = usadasActuales.filter(n => n !== basename);
      }
    });

    // üîß Actualizar tanto localStorage como variable global
    localStorage.setItem("imagenesUsadas", JSON.stringify(usadasActuales));
    imagenesUsadas = usadasActuales; // Sincronizar variable global

    // üóëÔ∏è Eliminar el grupo
    grupo.remove();
    console.log("‚úÖ [Step3] Grupo eliminado");

    saveStateDebounced();
  }
  
  function seleccionarImagen(img) {
    // Quitar selecci√≥n previa
    document.querySelectorAll('#carouselGlobal .thumb-wrapper').forEach(w => w.classList.remove('seleccionada'));

    // Marcar nuevo wrapper
    const wrapper = img.closest('.thumb-wrapper');
    if (wrapper) wrapper.classList.add('seleccionada');

    // Guardar selecci√≥n en variables globales
    window.imagenSeleccionada = img.dataset.nombre;
    window.imagenSeleccionadaUrl = img.dataset.url;

    console.log("üñ±Ô∏è Imagen clickeada:", img.src);
    console.log("‚úÖ Imagen seleccionada:", window.imagenSeleccionada);
    console.log("üîó URL seleccionada:", window.imagenSeleccionadaUrl);

    // Feedback visual
    document.querySelectorAll('#carouselGlobal .imagen-carrusel').forEach(el => {
      el.style.outline = "";
    });
    img.style.outline = "3px solid #00c853"; // verde para destacar
  }
  
  function confirmarImagen() {
    console.log("üü¢ [Step3] confirmarImagen ‚Üí seleccionada:", window.imagenSeleccionada, 
                "url:", window.imagenSeleccionadaUrl, 
                "filaActual:", filaActual);

    if (!window.imagenSeleccionada || !window.imagenSeleccionadaUrl || !filaActual) {
      console.warn("‚ö†Ô∏è confirmarImagen: faltan datos", {
        seleccionada: window.imagenSeleccionada,
        url: window.imagenSeleccionadaUrl,
        fila: filaActual
      });
      return;
    }

    let imagenFinal = window.imagenSeleccionadaUrl;
    const basename = window.imagenSeleccionada;

    // üîé Normalizar: si la URL es blob, reemplazar por ruta real usando mapping
    if (imagenFinal.startsWith("blob:")) {
      const mapping = JSON.parse(localStorage.getItem("imagenes_mapping") || "{}");
      const nombreGenerado = mapping[basename];

      console.log("üîé [Step3] Buscando basename en mapping:", basename, "‚Üí", nombreGenerado);

      if (nombreGenerado) {
        // ‚úÖ Construir URL p√∫blica de GCS
        const bucket = "mpagina"; // tu bucket
        const email = localStorage.getItem("email") || "anonimo";
        console.log("üìå [Step3] Email usado para construir URL:", email);
        imagenFinal = `https://storage.googleapis.com/${bucket}/${email}/${nombreGenerado}`;
        console.log("üîÑ [Step3] Blob reemplazado usando mapping:", basename, "‚Üí", imagenFinal);
      } else {
        console.error("‚ùå [Step3] No se encontr√≥ mapping para basename", basename);
        imagenFinal = "/static/img/fallback.webp"; // fallback seguro
      }
    }

    console.log("‚úÖ [Step3] Imagen final confirmada:", imagenFinal);

    // üíæ Guardar en hidden inputs
    const hiddenUrl = filaActual.querySelector("input[name='imagen_elegida']");
    if (hiddenUrl) {
      hiddenUrl.value = imagenFinal;
      console.log("üíæ [Step3] Guardado en hidden imagen_elegida:", imagenFinal);
    } else {
      console.warn("‚ö†Ô∏è [Step3] No se encontr√≥ hidden imagen_elegida en filaActual");
    }

    let hiddenBase = filaActual.querySelector("input[name='imagen_basename']");
    if (!hiddenBase) {
      hiddenBase = document.createElement("input");
      hiddenBase.type = "hidden";
      hiddenBase.name = "imagen_basename";
      filaActual.appendChild(hiddenBase);
      console.log("‚ûï [Step3] Creado hidden imagen_basename");
    }
    hiddenBase.value = basename;
    console.log("üíæ [Step3] Guardado en hidden imagen_basename:", basename);

    // üñºÔ∏è Preview
    filaActual.querySelector(".preview-imagen").innerHTML =
      `<img src="${imagenFinal}" style="width:100%;height:100%;object-fit:contain;">`;
    console.log("üñºÔ∏è [Step3] Preview actualizada con:", imagenFinal);

    // üìå Marcar como usada y persistir GLOBAL (siempre basename)
    let imagenesUsadas = JSON.parse(localStorage.getItem("imagenesUsadas") || "[]");
    if (!Array.isArray(imagenesUsadas)) imagenesUsadas = [];

    if (!imagenesUsadas.includes(basename)) {
      imagenesUsadas.push(basename);
      localStorage.setItem("imagenesUsadas", JSON.stringify(imagenesUsadas));
      console.log("üìå [Step3] imagenesUsadas actualizado:", imagenesUsadas);
    } else {
      console.log("‚ÑπÔ∏è [Step3] basename ya estaba en imagenesUsadas:", basename);
    }

    marcarImagenesUsadas();

    // üìÇ Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalCarrusel'));
    if (modal) {
      modal.hide();
      console.log("üìÇ [Step3] Modal cerrado");
    } else {
      console.warn("‚ö†Ô∏è [Step3] No se encontr√≥ instancia de modalCarrusel");
    }

    saveStateDebounced();
    console.log("üíæ [Step3] Estado guardado (debounced). localStorage.email:", localStorage.getItem("email"));
  }
  
  console.log("üìå [Template] sessionEmail recibido desde Flask:", "{{ email }}");
  window.sessionEmail = "{{ email }}"; 
  
  function loadState() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) {
      console.log("üßπ [Step3] No hay estado previo en localStorage");
      return;
    }

    try {
      const state = JSON.parse(raw);
      console.log("‚ôªÔ∏è [Step3] Estado cargado desde localStorage:", state);

      // Limpiar UI actual
      document.getElementById("grupos").innerHTML = "";

      // üîé Normalizar im√°genes usadas: siempre basenames, sin blobs ni URLs completas
      imagenesUsadas = (state.imagenesUsadas || [])
        .map(n => n ? n.split("/").pop() : "")
        .filter(n => n && !n.startsWith("blob:"));

      // Reconstruir grupos
      (state.grupos || []).forEach(g => {
        console.log(`üìÇ [Step3] Reconstruyendo grupo: ${g.nombre}`);

        // Crear grupo
        document.getElementById("nombreGrupo").value = g.nombre;
        crearGrupo();
        const grupoCard = [...document.querySelectorAll(".card:not(.subgrupo)")].at(-1);

        // Productos del grupo (ordenados)
        const contGrupo = grupoCard.querySelector(".productos");
        (g.productos || [])
          .sort((a, b) => (a.orden || 0) - (b.orden || 0))
          .forEach(p => {
            const fila = crearFila("General", g.nombre);
            hydrateFila(fila, p);
            contGrupo.appendChild(fila);
          });
        actualizarContador(contGrupo);

        // Subgrupos
        (g.subgrupos || []).forEach(sg => {
          console.log(`   ‚Ü≥ Subgrupo: ${sg.nombre}`);
          const grupoIdx = grupoCard.id.split("_")[1];
          const inputSub = grupoCard.querySelector(`#inputSubgrupo_${grupoIdx}`);
          inputSub.value = sg.nombre;
          crearSubgrupo(grupoCard.querySelector("button[onclick^='crearSubgrupo']"));

          const subCard = [...grupoCard.querySelectorAll(".subgrupo")].find(
            s => s.querySelector(".grupo-title")?.textContent.trim() === sg.nombre
          );
          const contSub = subCard.querySelector(".productos");
          (sg.productos || [])
            .sort((a, b) => (a.orden || 0) - (b.orden || 0))
            .forEach(p => {
              const fila = crearFila(sg.nombre, g.nombre);
              hydrateFila(fila, p);
              contSub.appendChild(fila);
            });
          actualizarContador(subCard);
        });
      });

      // ‚úÖ Marcar im√°genes usadas en carrusel (comparando siempre basenames)
      document.querySelectorAll('#carouselGlobal .carousel-item img').forEach(img => {
        const nombre = img.dataset.nombre;
        if (imagenesUsadas.includes(nombre)) {
          img.classList.add('usada');
          img.style.opacity = "0.25";
          img.style.filter = "grayscale(100%) brightness(0.6)";
          img.style.pointerEvents = "none";
          console.log(`üñºÔ∏è [Step3] Imagen marcada como usada: ${nombre}`);
        } else {
          img.classList.remove('usada');
          img.style.opacity = "1";
          img.style.filter = "none";
          img.style.pointerEvents = "auto";
        }
      });

    } catch (e) {
      console.error("‚ùå [Step3] Error al cargar estado:", e);
    }
  }
  
  function iniciarStep3() {
    // üßπ Siempre limpiar el estado viejo de Step3
    localStorage.removeItem("step3_state");
    imagenesUsadas = [];

    // üîé Log inicial: ver qu√© trae window.sessionEmail
    console.log("üìå [Step3] Valor inicial window.sessionEmail:", window.sessionEmail);

    // ‚úÖ Guardar email de sesi√≥n en localStorage para que GCS use la carpeta correcta
    if (window.sessionEmail) {
      localStorage.setItem("email", window.sessionEmail);
      console.log("üîë [Step3] Email seteado en localStorage:", window.sessionEmail);
    } else {
      console.warn("‚ö†Ô∏è [Step3] No se encontr√≥ sessionEmail, usando 'anonimo'");
      localStorage.setItem("email", "anonimo");
    }

    // üîé Verificar inmediatamente qu√© qued√≥ en localStorage
    console.log("üìå [Step3] localStorage.email actual:", localStorage.getItem("email"));

    // üì¶ Ver si existe estructura nueva desde Step2-5
    const listasStep2_5 = JSON.parse(localStorage.getItem("listas_step2-5") || "null");

    if (listasStep2_5) {
      console.log("‚ôªÔ∏è [Step3] Usando listas_step2-5 para generar filas:", listasStep2_5);
      generarFilasDesdeListas(listasStep2_5);

      // Una vez usadas, las borramos para no repetir
      localStorage.removeItem("listas_step2-5");
      console.log("üóëÔ∏è [Step3] listas_step2-5 eliminadas de localStorage");
    } else {
      console.log("üßπ [Step3] No hay listas_step2-5, empezando vac√≠o");
      document.getElementById("grupos").innerHTML = "";
    }

    // üîé Log final: confirmar estado despu√©s de iniciar
    console.log("‚úÖ [Step3] iniciarStep3 completado. Email en localStorage:", localStorage.getItem("email"), 
                "imagenesUsadas:", imagenesUsadas);
  }

  function marcarImagenesUsadas() {
    let usadas = JSON.parse(localStorage.getItem("imagenesUsadas") || "[]");
    if (!Array.isArray(usadas)) usadas = [];

    document.querySelectorAll('#carouselGlobal .carousel-item img').forEach(img => {
      const estaUsada = usadas.includes(img.dataset.nombre);
      img.classList.toggle('usada', estaUsada);
      img.style.opacity = estaUsada ? "0.25" : "1";
      img.style.filter = estaUsada ? "grayscale(100%) brightness(0.6)" : "none";
      img.style.pointerEvents = estaUsada ? "none" : "auto";
    });
  }

  function validarYEnviar() {
    const grupos = document.querySelectorAll('.card:not(.subgrupo)');
    if (grupos.length === 0) {
      alert('Agreg√° al menos un grupo antes de continuar');
      return;
    }

    let hayContenidoValido = false;
    let imagenesInvalidas = false;
    let filasInvalidas = [];

    grupos.forEach(grupo => {
      const filas = grupo.querySelectorAll('.fila-producto');
      filas.forEach((fila, index) => {
        const nombre = fila.querySelector('input[name="nombre"]');
        const precio = fila.querySelector('input[name="precio"]');
        const inputImagen = fila.querySelector('input[name="imagen_elegida"]');

        const nombreValido = nombre && nombre.value.trim();
        const precioValido = precio && precio.value.trim();
        const imagenValida = inputImagen && inputImagen.value.trim() !== "";

        if (nombreValido && precioValido && imagenValida) {
          hayContenidoValido = true;
        }
        if ((nombreValido || precioValido) && !imagenValida) {
          imagenesInvalidas = true;
          filasInvalidas.push(index + 1);
        }
      });
    });

    if (!hayContenidoValido) {
      alert('Complet√° al menos una fila con nombre, precio e imagen antes de continuar');
      return;
    }

    if (imagenesInvalidas) {
      alert(`‚ö†Ô∏è Hay ${filasInvalidas.length} fila(s) con nombre/precio pero sin imagen seleccionada. Revisalas antes de continuar.`);
      return;
    }

    // Mostrar spinner y limpiar estado antes de enviar
    document.getElementById('spinner').style.display = 'flex';
    localStorage.removeItem("step3_state"); // ‚úÖ limpiar cache del paso
    
    // Enviar formulario
    document.getElementById('formulario').submit();
  }
  
  function guardarProductoLocal(producto) {
    let productos = JSON.parse(localStorage.getItem("productos")) || [];
    productos.push(producto);
    localStorage.setItem("productos", JSON.stringify(productos));
    console.log("‚úÖ Producto guardado en localStorage:", producto);
  }

  window.addEventListener("load", () => {
    console.log("üöÄ [Step3] Inicializando...");

    // üßπ Inicializar Step3 (limpia estado viejo y usa listas_step2-5 si existen)
    iniciarStep3();

    // üî¢ Contador de orden
    contadorOrden = 1;

    // üì• Cargar im√°genes desde IndexedDB
    cargarImagenesDesdeIndexedDB(count => {
      console.log("üì• [Step3] Im√°genes cargadas desde IndexedDB:", count);

      if (count === 0) {
        console.warn("‚ö†Ô∏è [Step3] IndexedDB vac√≠o, inicializando carrusel con fallback a sesi√≥n");
        inicializarCarrusel();
      }

      // üîë Inicializar lista de im√°genes usadas desde localStorage
      imagenesUsadas = JSON.parse(localStorage.getItem("imagenesUsadas") || "[]");
      console.log("üü¢ [Step3] imagenesUsadas al cargar:", imagenesUsadas);

      // Tambi√©n conviene loguear las rutas reales guardadas en Step0
      const rutasStep0 = JSON.parse(localStorage.getItem("imagenes_step0") || "[]");
      console.log("üü¢ [Step3] imagenes_step0 al cargar:", rutasStep0);

      // Intentar restaurar estado guardado (si no ven√≠s de Step2-5)
      loadState();
      console.log("üíæ [Step3] Estado restaurado desde localStorage");

      // ‚úÖ volver a marcar im√°genes usadas
      marcarImagenesUsadas();
    });

    // Configurar botones de continuar
    const btnContinuar = document.getElementById("btnContinuar");
    const btnContinuarMobile = document.getElementById("btnContinuarMobile");
    
    if (btnContinuar) {
      btnContinuar.addEventListener("click", function(e) {
        e.preventDefault();
        validarYEnviar();
      });
    }
    
    if (btnContinuarMobile) {
      btnContinuarMobile.addEventListener("click", function(e) {
        e.preventDefault();
        validarYEnviar();
      });
    }
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>
