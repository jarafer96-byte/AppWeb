<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Step 2-5 - Generar XLS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { background:#000; font-family:sans-serif; color:white; }
    h2 { color:white; font-weight:bold; }
    .card { background-color:rgba(255,255,255,0.05); border-radius:12px; padding:20px; }
    .form-control { background-color:rgba(255,255,255,0.05); color:white; border:none; border-radius:8px; }
    .form-control::placeholder { color:#aaa; }
    .btn-gradient { background:linear-gradient(135deg,#8e2de2,#ff6f61); color:white; border:none; padding:10px 24px; border-radius:50px; font-weight:bold; }
    .btn-gradient:hover { transform:scale(1.05); }
  </style>
</head>
<body>
<div class="container py-5">
  <h2 class="mb-4 text-center">Generar catálogo en Excel</h2>

  <form class="card mb-4" onsubmit="generarXLS(event)">
    <div id="listas-container">
      <!-- 5 filas iniciales -->
      <div class="mb-2 d-flex flex-row align-items-center gap-3">
        <span class="fw-bold">#1</span>
        <input type="text" name="grupo_1" class="form-control" placeholder="Grupo (ej: Ropa Mujer)">
        <input type="text" name="subgrupo_1" class="form-control" placeholder="Subgrupo (opcional)">
        <input type="text" name="producto_1" class="form-control" placeholder="Producto base (ej: Pantalón)">
        <input type="number" name="filas_1" class="form-control" min="1" value="1" style="width:100px;">
        <input type="text" name="talles_1" class="form-control" placeholder="Talles (ej: S,M,L)" style="width:160px;">
      </div>
    </div>
    <button type="button" class="btn-gradient mt-2" onclick="agregarFila()">+ Agregar fila</button>
    <button type="submit" class="btn-gradient mt-3">Descargar XLS</button>
  </form>

  <!-- Ejemplo -->
  <div class="mt-4 card">
    <h4>Ejemplo de salida:</h4>
    <table class="table table-dark table-striped">
      <thead>
        <tr><th>Grupo</th><th>Subgrupo</th><th>Producto</th><th>Talle</th></tr>
      </thead>
      <tbody>
        <tr><td>Ropa Mujer</td><td>Pantalones</td><td>Pantalón1</td><td>S</td></tr>
        <tr><td>Ropa Mujer</td><td>Pantalones</td><td>Pantalón1</td><td>M</td></tr>
        <tr><td>Mochilas</td><td></td><td>Mochila1</td><td>S</td></tr>
        <tr><td>Mochilas</td><td>Adulto</td><td>Mochila2</td><td>S-M-L</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
function agregarFila() {
  const container = document.getElementById('listas-container');
  const index = container.children.length + 1;
  const div = document.createElement('div');
  div.className = "mb-2 d-flex flex-row align-items-center gap-3";
  div.innerHTML = `
    <span class="fw-bold">#${index}</span>
    <input type="text" name="grupo_${index}" class="form-control" placeholder="Grupo">
    <input type="text" name="subgrupo_${index}" class="form-control" placeholder="Subgrupo (opcional)">
    <input type="text" name="producto_${index}" class="form-control" placeholder="Producto base">
    <input type="number" name="filas_${index}" class="form-control" min="1" value="1" style="width:100px;">
    <input type="text" name="talles_${index}" class="form-control" placeholder="Talles (ej: S,M,L)" style="width:160px;">
  `;
  container.appendChild(div);
}

function generarXLS(e) {
  e.preventDefault();
  const container = document.getElementById('listas-container');
  const rows = [];

  container.querySelectorAll('div').forEach((fila, idx) => {
    const grupo = fila.querySelector(`[name="grupo_${idx+1}"]`)?.value.trim() || "";
    const subgrupo = fila.querySelector(`[name="subgrupo_${idx+1}"]`)?.value.trim() || "";
    const productoBase = fila.querySelector(`[name="producto_${idx+1}"]`)?.value.trim() || "";
    const cantidad = parseInt(fila.querySelector(`[name="filas_${idx+1}"]`)?.value || "1", 10);
    const tallesRaw = fila.querySelector(`[name="talles_${idx+1}"]`)?.value.trim() || "";

    if (!grupo) return;

    let productos = [];
    if (productoBase) {
      for (let i = 1; i <= cantidad; i++) {
        productos.push(`${productoBase}${i}`);
      }
    } else {
      const base = subgrupo || grupo;
      for (let i = 1; i <= cantidad; i++) {
        productos.push(`${base}${i}`);
      }
    }

    let listaTalles = [];
    if (tallesRaw.includes(",")) {
      listaTalles = tallesRaw.split(",").map(t => t.trim()).filter(Boolean);
    } else {
      listaTalles = [tallesRaw];
    }

    productos.forEach(prod => {
      listaTalles.forEach(talle => {
        rows.push({ Grupo: grupo, Subgrupo: subgrupo, Producto: prod, Talle: talle });
      });
    });
  });

  // Crear XLS
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Catálogo");
  XLSX.writeFile(wb, "catalogo.xlsx");
}
</script>
</body>
</html>
