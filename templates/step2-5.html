<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Armar plantilla de productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
 <style>
  body {
    background-color: #000;
    font-family: sans-serif;
    color: white;
  }

  h2 {
    color: white;
    text-align: center;
    margin-bottom: 30px;
  }
/* A√±adir despu√©s de las reglas existentes de .col-talle y .col-filas */
.col-talle { width: 180px; }
.col-filas { width: 100px; }
.col-stock { width: 100px; } /* NUEVO */

/* Para m√≥vil */
@media (max-width: 768px) {
  .col-talle, .col-filas, .col-stock { width: 100% !important; }
}
  .card {
    background-color: rgba(255, 255, 255, 0.05);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
  }

  .form-control {
    background-color: rgba(255, 255, 255, 0.05);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 15px;
  }

  .form-control::placeholder { color: #aaa; }

  .form-control:focus {
    background-color: rgba(255, 255, 255, 0.08);
    color: white;
    box-shadow: 0 0 0 2px rgba(255, 111, 97, 0.5);
  }

  .btn-gradient {
    background: linear-gradient(135deg, #8e2de2, #ff6f61);
    color: white;
    border: none;
    padding: 12px 28px;
    border-radius: 50px;
    font-weight: bold;
    box-shadow: 0 0 10px rgba(255,255,255,0.3);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: inline-block;
    text-decoration: none;
    cursor: pointer;
  }

  .btn-gradient:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255,255,255,0.5);
    color: white;
  }

  .btn-outline-light {
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    background: transparent;
    padding: 8px 20px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .btn-outline-light:hover {
    background-color: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
  }

  .btn-sm { padding: 6px 15px; font-size: 0.9em; }

  .table th {
    background-color: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.2);
    color: #ff6f61;
  }

  .table td {
    border-color: rgba(255,255,255,0.1);
    vertical-align: middle;
  }

  .badge {
    background: linear-gradient(135deg, #8e2de2, #ff6f61);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8em;
  }

  .alert-custom {
    background-color: rgba(13, 110, 253, 0.1);
    border-left: 4px solid #0d6efd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .example-box {
    background-color: rgba(255,255,255,0.03);
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    border-left: 3px solid #28a745;
  }

  .col-talle { width: 180px; }
  .col-filas { width: 100px; }

  /* üî• RESPONSIVO PARA M√ìVIL */
  @media (max-width: 768px) {
    .container { padding: 0 15px !important; }

    h2 { font-size: 1.5rem; margin-bottom: 20px; }

    .card { padding: 15px !important; margin-bottom: 15px; }

    .row .col-md-6 { width: 100%; margin-bottom: 15px; }

    .table-responsive {
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table { font-size: 13px; margin-bottom: 0; }
    .table th, .table td { padding: 8px 6px; white-space: nowrap; }

    .fila-entrada {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      background: rgba(255,255,255,0.03);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px !important;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .fila-entrada > div { width: 100% !important; padding: 0 !important; }

    .fila-entrada input {
      width: 100% !important;
      padding: 10px 12px;
      font-size: 16px; /* evita zoom en iOS */
      margin-bottom: 8px;
    }

    .fila-entrada .col-md-1 { text-align: right; margin-top: 5px; }

    .fila-entrada button.btn-sm { padding: 6px 12px; font-size: 0.9em; }

    .d-flex.gap-3 {
      flex-direction: column;
      flex-wrap: wrap;
      gap: 12px !important;
    }

    .d-flex.gap-3 button {
      width: 100%;
      text-align: center;
      padding: 12px;
    }

    .text-center .btn-gradient {
      width: 100%;
      padding: 14px;
      font-size: 1.1em;
    }

    .col-talle, .col-filas { width: 100% !important; }

    .badge { font-size: 0.7em; padding: 4px 8px; }

    .alert-custom { padding: 12px; font-size: 0.9em; }

    .text-center .btn-gradient.mb-3 { width: 100%; padding: 12px; }

    ol { padding-left: 20px; }
    ol li { margin-bottom: 10px; font-size: 0.9em; }

    .form-control { margin-bottom: 10px; }
  }

  /* Pantallas muy peque√±as */
  @media (max-width: 360px) {
    .container { padding: 0 10px !important; }
    h2 { font-size: 1.3rem; }
    h4 { font-size: 1.1rem; }
    .fila-entrada { padding: 12px; }
    .table { font-size: 12px; }
  }
</style>
</head>
<body>
<div class="container py-5 px-3 px-md-5">
  <h2> Armar plantilla de productos</h2>

  <!-- Alerta informativa -->
  <div class="alert-custom">
    <strong>¬øYa ten√©s un Excel?</strong> Si ya ten√©s tu archivo con productos, pod√©s subirlo directamente en el siguiente paso y saltar este.
  </div>

  <!-- Bot√≥n para saltar -->
  <div class="text-center mb-4">
    <a href="/contenido" class="btn-gradient mb-3 w-100 w-md-auto">Saltar este paso e ir a cargar contenido</a>
    <p class="text-white">Si no ten√©s Excel, cre√° uno f√°cilmente aqu√≠:</p>
  </div>

  <!-- Formulario principal -->
  <div class="card">
    <h4 class="mb-4">üìù Crear estructura de productos</h4>

    <!-- Instrucciones -->
    <div class="mb-4">
      <p>Complet√° cada fila para definir grupos, subgrupos y productos. Luego gener√° el Excel.</p>
      <div class="row">
        <div class="col-md-6 mb-3 mb-md-0">
          <div class="example-box">
            <strong>Ejemplo 1 (sin subgrupo):</strong><br>
            Grupo: <span class="badge">Mochilas</span><br>
            Producto: <span class="badge">Mochila</span><br>
            Filas: <span class="badge">2</span><br>
            Talle: <span class="badge">S,M,L</span><br>
            ‚Üí Crear√° 2 productos en el grupo "Mochilas" con talle S,M,L
          </div>
        </div>
        <div class="col-md-6">
          <div class="example-box">
            <strong>Ejemplo 2 (con subgrupo):</strong><br>
            Grupo: <span class="badge">Mochilas</span><br>
            Subgrupo: <span class="badge">Ni√±os</span><br>
            Producto: <span class="badge">Mochila</span><br>
            Filas: <span class="badge">2</span><br>
            Talle: <span class="badge">XS,S</span><br>
            ‚Üí Crear√° 2 productos en el subgrupo "Ni√±os" con talle XS,S
          </div>
        </div>
      </div>
    </div>

    <!-- Filas de entrada -->
    <div id="filas-container">
      <div class="row mb-3 align-items-center fila-entrada">
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Grupo (ej: Ropa Mujer)" data-field="grupo" required>
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Subgrupo (opcional)" data-field="subgrupo">
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Producto (ej: Pantal√≥n)" data-field="producto" required>
        </div>
        <div class="col-md-3 col-talle">
          <input type="text" class="form-control" placeholder="Talle (ej: S,M,L o 38,40,42)" data-field="talle">
        </div>
        <div class="col-md-2 col-filas">
          <input type="number" class="form-control" placeholder="Filas" data-field="filas" min="1" value="1">
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-light btn-sm" onclick="eliminarFila(this)" style="display:none;">‚úï</button>
        </div>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="d-flex gap-3 mt-4 flex-wrap">
      <button type="button" class="btn-gradient w-100 w-md-auto" onclick="agregarFila()">+ Agregar otra fila</button>
      <button type="button" class="btn btn-outline-light w-100 w-md-auto" onclick="limpiarFormulario()">Limpiar todo</button>
      <button type="button" class="btn btn-outline-light w-100 w-md-auto" onclick="probarVistaPrevia()">Ver vista previa</button>
    </div>

    <!-- Bot√≥n para generar Excel -->
    <div class="text-center mt-5">
      <button type="button" class="btn-gradient px-5 w-100 w-md-auto" onclick="generarExcel()">Generar Excel</button>
      <p class="mt-2 text-white">El Excel generado ser√° compatible con el importador del siguiente paso.</p>
    </div>
  </div>

  <!-- Vista previa -->
  <div id="vista-previa-container" class="card" style="display:none;">
    <h4 class="mb-3">üëÅÔ∏è Vista previa del Excel</h4>
    <div class="table-responsive">
      <table class="table table-dark">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Precio</th>
            <th>Grupo</th>
            <th>Subgrupo</th>
            <th>Talles</th>
            <th>Filas</th>
          </tr>
        </thead>
        <tbody id="vista-previa-body"></tbody>
      </table>
    </div>
    <div class="mt-4 text-center">
      <p>‚úÖ Este formato es exactamente lo que el siguiente paso necesita.</p>
      <a href="/contenido" class="btn-gradient w-100 w-md-auto">Continuar al siguiente paso</a>
    </div>
  </div>

  <!-- Informaci√≥n adicional -->
  <div class="card">
    <h4 class="mb-3">‚ÑπÔ∏è ¬øC√≥mo funciona?</h4>
    <ol>
      <li><strong>Grupo</strong>: Obligatorio. Es la categor√≠a principal.</li>
      <li><strong>Subgrupo</strong>: Opcional. Para organizar dentro del grupo.</li>
      <li><strong>Producto</strong>: Obligatorio. El nombre base del producto.</li>
      <li><strong>Talle</strong>: Opcional. Talles separados por comas.</li>
      <li><strong>Filas</strong>: Cantidad de veces que se repetir√° este producto.</li>
    </ol>
    <p class="mt-3"><strong>üí° Tip:</strong> Pod√©s dejar Descripci√≥n y Precio vac√≠os en el Excel, y llenarlos despu√©s en el paso 3.</p>
  </div>
</div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let contadorFilas = 1;

   function agregarFila() {
  contadorFilas++;
  const container = document.getElementById('filas-container');
  const nuevaFila = document.createElement('div');
  nuevaFila.className = 'row mb-3 align-items-center fila-entrada';
  nuevaFila.innerHTML = `
    <div class="col-md-2">
      <input type="text" class="form-control" placeholder="Grupo (ej: Ropa Mujer)" data-field="grupo" required>
    </div>
    <div class="col-md-2">
      <input type="text" class="form-control" placeholder="Subgrupo (opcional)" data-field="subgrupo">
    </div>
    <div class="col-md-2">
      <input type="text" class="form-control" placeholder="Producto (ej: Pantal√≥n)" data-field="producto" required>
    </div>
    <div class="col-md-3 col-talle">
      <input type="text" class="form-control" placeholder="Talle (ej: S,M,L)" data-field="talle">
    </div>
    <div class="col-md-1 col-filas">
      <input type="number" class="form-control" placeholder="Filas" data-field="filas" min="1" value="1">
    </div>
    <div class="col-md-1 col-stock"> <!-- NUEVO: Campo Stock -->
      <input type="number" class="form-control" placeholder="Stock" data-field="stock" min="0" value="0">
    </div>
    <div class="col-md-1">
      <button type="button" class="btn btn-outline-light btn-sm" onclick="eliminarFila(this)">‚úï</button>
    </div>
  `;
  container.appendChild(nuevaFila);
}

    // Eliminar fila
    function eliminarFila(btn) {
      const filas = document.querySelectorAll('.fila-entrada');
      if (filas.length > 1) {
        btn.closest('.fila-entrada').remove();
      }
    }

    // Limpiar formulario
    function limpiarFormulario() {
      document.querySelectorAll('.fila-entrada').forEach(fila => {
        fila.querySelectorAll('input').forEach(input => {
          if (input.dataset.field === 'filas') {
            input.value = '1';
          } else {
            input.value = '';
          }
        });
      });
    }

function recolectarDatos() {
  const datos = [];
  document.querySelectorAll('.fila-entrada').forEach(fila => {
    const grupo = fila.querySelector('[data-field="grupo"]').value.trim();
    const subgrupo = fila.querySelector('[data-field="subgrupo"]').value.trim();
    const producto = fila.querySelector('[data-field="producto"]').value.trim();
    const talle = fila.querySelector('[data-field="talle"]').value.trim();
    const filasInput = parseInt(fila.querySelector('[data-field="filas"]').value) || 1;
    const stock = parseInt(fila.querySelector('[data-field="stock"]').value) || 0; // NUEVO

    if (grupo && producto) {
      // Crear una entrada por cada fila solicitada
      for (let i = 0; i < filasInput; i++) {
        datos.push({
          grupo,
          subgrupo, // Puede estar vac√≠o
          producto, // Mismo nombre para todas las filas (sin n√∫mero)
          talle,    // Talles (puede estar vac√≠o)
          stock,    // NUEVO: Stock para cada producto
          filas: 1  // Siempre 1 porque cada entrada es una fila
        });
      }
    }
  });
  return datos;
}

function probarVistaPrevia() {
  const datos = recolectarDatos();
  if (datos.length === 0) {
    alert('Por favor, complet√° al menos una fila con Grupo y Producto.');
    return;
  }

  const tbody = document.getElementById('vista-previa-body');
  tbody.innerHTML = '';

  datos.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.producto}</td>
      <td></td>
      <td></td>
      <td>${item.grupo}</td>
      <td>${item.subgrupo || ''}</td>
      <td>${item.talle || ''}</td>
      <td>1</td>
      <td>${item.stock}</td> <!-- NUEVO: Columna Stock -->
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('vista-previa-container').style.display = 'block';
  
  // Scroll a la vista previa
  document.getElementById('vista-previa-container').scrollIntoView({ behavior: 'smooth' });
}
    
function generarExcel() {
  const datos = recolectarDatos();
  if (datos.length === 0) {
    alert('No hay datos para generar el Excel. Complet√° al menos una fila.');
    return;
  }

  // Crear hoja de c√°lculo
  // üî• IMPORTANTE: Estos encabezados deben coincidir EXACTAMENTE con lo que step3 espera
  const hojaDatos = [
    // Encabezados (EXACTAMENTE como step3 los espera con stock)
    ['Nombre', 'Descripci√≥n', 'Precio', 'Grupo', 'Subgrupo', 'Talles', 'Stock', 'Filas']
    // Nota: Stock ahora est√° en posici√≥n 7, Filas en posici√≥n 8 (√≠ndices 6 y 7)
  ];

  // Agregar filas de datos
  datos.forEach(item => {
    hojaDatos.push([
      item.producto,    // Nombre
      '',               // Descripci√≥n (vac√≠a)
      '',               // Precio (vac√≠o)
      item.grupo,       // Grupo
      item.subgrupo,    // Subgrupo (puede estar vac√≠o)
      item.talle,       // Talles (puede estar vac√≠o)
      item.stock,       // NUEVO: Stock
      '1'               // Filas (siempre 1)
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(hojaDatos);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Productos');

  // Formatear columnas
  const colAnchos = [
    { wch: 20 }, // Nombre
    { wch: 30 }, // Descripci√≥n
    { wch: 10 }, // Precio
    { wch: 15 }, // Grupo
    { wch: 15 }, // Subgrupo
    { wch: 15 }, // Talles
    { wch: 10 }, // NUEVO: Stock
    { wch: 8 }   // Filas
  ];
  ws['!cols'] = colAnchos;

  // Generar nombre de archivo
  const fecha = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  XLSX.writeFile(wb, `productos_${fecha}.xlsx`);

  // Mostrar vista previa
  probarVistaPrevia();

  // Mostrar mensaje de √©xito
  alert(`‚úÖ Excel generado exitosamente!\n\nSe crearon ${datos.length} productos.\n\nPod√©s subir este archivo en el siguiente paso.`);
}
    // Inicializar con algunas filas y mejoras para m√≥vil
    window.addEventListener('load', () => {
      // Agregar 3 filas m√°s
      for (let i = 0; i < 3; i++) {
        agregarFila();
      }

      // Mostrar botones de eliminar en todas las filas excepto la primera
      document.querySelectorAll('.fila-entrada').forEach((fila, index) => {
        if (index > 0) {
          const btnEliminar = fila.querySelector('button');
          if (btnEliminar) btnEliminar.style.display = 'inline-block';
        }
      });

      // üî• MEJORAS ESPEC√çFICAS PARA M√ìVIL
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        console.log("üì± Modo m√≥vil activado - Ajustando interfaz...");
        
        // Ajustar placeholder m√°s cortos para m√≥vil
        document.querySelectorAll('.fila-entrada input[placeholder]').forEach(input => {
          const placeholder = input.getAttribute('placeholder');
          if (placeholder && placeholder.length > 20) {
            // Acortar placeholders largos
            if (placeholder.includes('Grupo')) input.setAttribute('placeholder', 'Grupo');
            if (placeholder.includes('Subgrupo')) input.setAttribute('placeholder', 'Subgrupo (opc)');
            if (placeholder.includes('Producto')) input.setAttribute('placeholder', 'Producto');
            if (placeholder.includes('Talle')) input.setAttribute('placeholder', 'Talles (opc)');
            if (placeholder.includes('Filas')) input.setAttribute('placeholder', 'Cantidad');
          }
        });
        
        // Mostrar menos filas iniciales en m√≥vil
        const filasIniciales = document.querySelectorAll('.fila-entrada');
        if (filasIniciales.length > 2) {
          // Ocultar filas extras (mantener solo 2 visibles)
          for (let i = 2; i < filasIniciales.length; i++) {
            filasIniciales[i].style.display = 'none';
          }
          
          // Agregar mensaje para agregar m√°s filas
          const container = document.getElementById('filas-container');
          const msg = document.createElement('div');
          msg.className = 'text-center mt-3 mb-4';
          msg.innerHTML = '<p class="text-white-50" style="font-size: 0.9em;">Hay ' + (filasIniciales.length - 2) + ' filas ocultas. Us√° "Agregar otra fila" cuando necesites m√°s.</p>';
          container.appendChild(msg);
          
          // Ajustar la funci√≥n agregarFila() para mostrar filas ocultas
          const originalAgregarFila = agregarFila;
          agregarFila = function() {
            // Primero verificar si hay filas ocultas
            const filasOcultas = document.querySelectorAll('.fila-entrada[style*="display: none"]');
            if (filasOcultas.length > 0) {
              // Mostrar la primera fila oculta
              filasOcultas[0].style.display = '';
              
              // Si era la √∫ltima fila oculta, remover el mensaje
              if (filasOcultas.length === 1) {
                const msg = container.querySelector('.text-center.mt-3');
                if (msg) msg.remove();
              } else {
                // Actualizar el mensaje
                const msg = container.querySelector('.text-center.mt-3 p');
                if (msg) msg.textContent = 'Hay ' + (filasOcultas.length - 1) + ' filas ocultas. Us√° "Agregar otra fila" cuando necesites m√°s.';
              }
            } else {
              // Si no hay filas ocultas, usar la funci√≥n original
              originalAgregarFila();
            }
          };
        }
      }
    });

    // Validar entrada en tiempo real (mejorado para m√≥vil/desktop)
    document.addEventListener('input', function(e) {
      if (e.target.matches('[data-field="grupo"], [data-field="producto"]')) {
        const fila = e.target.closest('.fila-entrada');
        const grupo = fila.querySelector('[data-field="grupo"]').value.trim();
        const producto = fila.querySelector('[data-field="producto"]').value.trim();
        
        if (grupo && producto) {
          e.target.style.border = '2px solid #28a745';
          // Solo agregar fondo en m√≥vil para mejor visibilidad
          if (window.innerWidth <= 768) {
            e.target.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
          }
        } else {
          e.target.style.border = '';
          e.target.style.backgroundColor = '';
        }
      }
    });
  </script>
</body>
</html>
