<!-- Reemplazar esta secci√≥n en el HTML de step2-5 -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Armar plantilla de productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Mantener los estilos actuales... */
    .col-color { width: 180px; }
  </style>
</head>
<body>
<div class="container py-5 px-3 px-md-5">
  <h2>Armar plantilla de productos</h2>

  <!-- Alerta informativa -->
  <div class="alert-custom">
    <strong>Importante:</strong> El Excel generado ser√° 100% compatible con el siguiente paso. Pod√©s completar precio y descripci√≥n luego.
  </div>

  <!-- Bot√≥n para saltar -->
  <div class="text-center mb-4">
    <a href="/contenido" class="btn-gradient mb-3 w-100 w-md-auto">Saltar este paso e ir a cargar contenido</a>
    <p class="text-white">Cre√° tu Excel autom√°ticamente aqu√≠:</p>
  </div>

  <!-- Formulario principal -->
  <div class="card">
    <h4 class="mb-4">üìù Crear estructura de productos</h4>

    <!-- Instrucciones mejoradas -->
    <div class="mb-4">
      <p>Complet√° cada fila. El Excel generado tendr√° <strong>TODOS</strong> los campos que step3 necesita:</p>
      <div class="row">
        <div class="col-md-6 mb-3 mb-md-0">
          <div class="example-box">
            <strong>Ejemplo 1 - Ropa con talles:</strong><br>
            Grupo: <span class="badge">Ropa Mujer</span><br>
            Subgrupo: <span class="badge">Pantalones</span><br>
            Producto: <span class="badge">Jean Slim</span><br>
            Talle: <span class="badge">36,38,40,42</span><br>
            Color: <span class="badge">Azul,Negro</span><br>
            Stock: <span class="badge">20</span><br>
            Filas: <span class="badge">2</span><br>
            ‚Üí Crear√° 2 filas en Excel listas para importar
          </div>
        </div>
        <div class="col-md-6">
          <div class="example-box">
            <strong>Ejemplo 2 - Accesorios sin talles:</strong><br>
            Grupo: <span class="badge">Accesorios</span><br>
            Subgrupo: <span class="badge">Bolsos</span><br>
            Producto: <span class="badge">Bolso Cuero</span><br>
            Talle: <span class="badge">(vac√≠o)</span><br>
            Color: <span class="badge">Marr√≥n,Negro,Rojo</span><br>
            Stock: <span class="badge">15</span><br>
            Filas: <span class="badge">1</span><br>
            ‚Üí 1 producto con 3 variantes de color
          </div>
        </div>
      </div>
    </div>

    <!-- Filas de entrada ACTUALIZADA -->
    <div id="filas-container">
      <div class="row mb-3 align-items-center fila-entrada">
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Grupo*" data-field="grupo" required>
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Subgrupo" data-field="subgrupo">
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Producto*" data-field="producto" required>
        </div>
        <div class="col-md-2 col-talle">
          <input type="text" class="form-control" placeholder="Talles (S,M,L)" data-field="talle">
        </div>
        <div class="col-md-2 col-color">
          <input type="text" class="form-control" placeholder="Colores (Rojo,Azul)" data-field="color">
        </div>
        <div class="col-md-1">
          <input type="number" class="form-control" placeholder="Stock" data-field="stock" min="0" value="0">
        </div>
        <div class="col-md-1 col-filas">
          <input type="number" class="form-control" placeholder="Filas" data-field="filas" min="1" value="1">
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-outline-light btn-sm" onclick="eliminarFila(this)" style="display:none;">‚úï</button>
        </div>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="d-flex gap-3 mt-4 flex-wrap">
      <button type="button" class="btn-gradient w-100 w-md-auto" onclick="agregarFila()">+ Agregar otra fila</button>
      <button type="button" class="btn btn-outline-light w-100 w-md-auto" onclick="limpiarFormulario()">Limpiar todo</button>
      <button type="button" class="btn btn-outline-light w-100 w-md-auto" onclick="probarVistaPrevia()">Ver vista previa</button>
    </div>

    <!-- Bot√≥n para generar Excel -->
    <div class="text-center mt-5">
      <button type="button" class="btn-gradient px-5 w-100 w-md-auto" onclick="generarExcel()">üì• Generar Excel completo</button>
      <p class="mt-2 text-white">El Excel incluir√° todos los campos: Nombre, Descripci√≥n, Precio, Grupo, Subgrupo, Talles, Colores, Stock, Filas</p>
    </div>
  </div>

  <!-- Vista previa ACTUALIZADA -->
  <div id="vista-previa-container" class="card" style="display:none;">
    <h4 class="mb-3">üëÅÔ∏è Vista previa del Excel (100% compatible con step3)</h4>
    <div class="table-responsive">
      <table class="table table-dark">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Precio</th>
            <th>Grupo</th>
            <th>Subgrupo</th>
            <th>Talles</th>
            <th>Colores</th>
            <th>Stock</th>
            <th>Filas</th>
          </tr>
        </thead>
        <tbody id="vista-previa-body"></tbody>
      </table>
    </div>
    <div class="mt-4 text-center">
      <p>‚úÖ <strong>Formato perfecto para importar en step3</strong></p>
      <a href="/contenido" class="btn-gradient w-100 w-md-auto">Ir a cargar este Excel en step3</a>
    </div>
  </div>

  <!-- Informaci√≥n adicional ACTUALIZADA -->
  <div class="card">
    <h4 class="mb-3">üìã Campos del Excel generado</h4>
    <ol>
      <li><strong>Nombre</strong>: Nombre del producto (ej: "Jean Slim Fit")</li>
      <li><strong>Descripci√≥n</strong>: (Vac√≠o) Pod√©s completarlo en step3</li>
      <li><strong>Precio</strong>: (Vac√≠o) Pod√©s completarlo en step3</li>
      <li><strong>Grupo</strong>: Categor√≠a principal (ej: "Ropa Mujer")</li>
      <li><strong>Subgrupo</strong>: Subcategor√≠a (ej: "Pantalones")</li>
      <li><strong>Talles</strong>: Separados por comas (ej: "S,M,L,XL")</li>
      <li><strong>Colores</strong>: Separados por comas (ej: "Negro,Azul,Rojo")</li>
      <li><strong>Stock</strong>: Cantidad inicial (ej: "10")</li>
      <li><strong>Filas</strong>: Cantidad de productos id√©nticos (ej: "1")</li>
    </ol>
    <p class="mt-3"><strong>üí° Tip avanzado:</strong> Si especific√°s talles Y colores, step3 autom√°ticamente calcular√° todas las combinaciones posibles.</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  let contadorFilas = 1;

  function agregarFila() {
    contadorFilas++;
    const container = document.getElementById('filas-container');
    const nuevaFila = document.createElement('div');
    nuevaFila.className = 'row mb-3 align-items-center fila-entrada';
    nuevaFila.innerHTML = `
      <div class="col-md-2">
        <input type="text" class="form-control" placeholder="Grupo*" data-field="grupo" required>
      </div>
      <div class="col-md-2">
        <input type="text" class="form-control" placeholder="Subgrupo" data-field="subgrupo">
      </div>
      <div class="col-md-2">
        <input type="text" class="form-control" placeholder="Producto*" data-field="producto" required>
      </div>
      <div class="col-md-2 col-talle">
        <input type="text" class="form-control" placeholder="Talles (S,M,L)" data-field="talle">
      </div>
      <div class="col-md-2 col-color">
        <input type="text" class="form-control" placeholder="Colores (Rojo,Azul)" data-field="color">
      </div>
      <div class="col-md-1">
        <input type="number" class="form-control" placeholder="Stock" data-field="stock" min="0" value="0">
      </div>
      <div class="col-md-1 col-filas">
        <input type="number" class="form-control" placeholder="Filas" data-field="filas" min="1" value="1">
      </div>
      <div class="col-md-1">
        <button type="button" class="btn btn-outline-light btn-sm" onclick="eliminarFila(this)">‚úï</button>
      </div>
    `;
    container.appendChild(nuevaFila);
  }

  function eliminarFila(btn) {
    const filas = document.querySelectorAll('.fila-entrada');
    if (filas.length > 1) {
      btn.closest('.fila-entrada').remove();
    }
  }

  function limpiarFormulario() {
    document.querySelectorAll('.fila-entrada').forEach(fila => {
      fila.querySelectorAll('input').forEach(input => {
        if (input.dataset.field === 'filas') {
          input.value = '1';
        } else if (input.dataset.field === 'stock') {
          input.value = '0';
        } else {
          input.value = '';
        }
      });
    });
  }

  function recolectarDatos() {
    const datos = [];
    document.querySelectorAll('.fila-entrada').forEach(fila => {
      const grupo = fila.querySelector('[data-field="grupo"]').value.trim();
      const subgrupo = fila.querySelector('[data-field="subgrupo"]').value.trim();
      const producto = fila.querySelector('[data-field="producto"]').value.trim();
      const talle = fila.querySelector('[data-field="talle"]').value.trim();
      const color = fila.querySelector('[data-field="color"]').value.trim();
      const stock = fila.querySelector('[data-field="stock"]').value.trim();
      const filas = parseInt(fila.querySelector('[data-field="filas"]').value) || 1;

      if (grupo && producto) {
        // Crear m√∫ltiples filas seg√∫n la cantidad especificada
        for (let i = 0; i < filas; i++) {
          datos.push({
            grupo,
            subgrupo,
            producto: producto,
            talle: talle,
            color: color,
            stock: stock || '0',
            filas: 1
          });
        }
      }
    });
    return datos;
  }

  function probarVistaPrevia() {
    const datos = recolectarDatos();
    if (datos.length === 0) {
      alert('Por favor, complet√° al menos una fila con Grupo y Producto.');
      return;
    }

    const tbody = document.getElementById('vista-previa-body');
    tbody.innerHTML = '';

    datos.forEach((item, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.producto}</td>
        <td class="text-muted">(vac√≠o)</td>
        <td class="text-muted">(vac√≠o)</td>
        <td>${item.grupo}</td>
        <td>${item.subgrupo || '<span class="text-muted">-</span>'}</td>
        <td>${item.talle || '<span class="text-muted">-</span>'}</td>
        <td>${item.color || '<span class="text-muted">-</span>'}</td>
        <td>${item.stock}</td>
        <td>1</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('vista-previa-container').style.display = 'block';
    document.getElementById('vista-previa-container').scrollIntoView({ behavior: 'smooth' });
  }

  function generarExcel() {
    const datos = recolectarDatos();
    if (datos.length === 0) {
      alert('No hay datos para generar el Excel. Complet√° al menos una fila.');
      return;
    }

    // üî• ENCABEZADOS EXACTOS como step3 los espera
    const hojaDatos = [
      // IMPORTANTE: Este orden debe coincidir con lo que step3 espera en leerArchivoProductos()
      ['Nombre', 'Descripci√≥n', 'Precio', 'Grupo', 'Subgrupo', 'Talles', 'Colores', 'Stock', 'Filas']
    ];

    // üî• DATOS en el MISMO orden
    datos.forEach((item) => {
      hojaDatos.push([
        item.producto,          // Nombre
        '',                     // Descripci√≥n (vac√≠a)
        '',                     // Precio (vac√≠o)
        item.grupo,             // Grupo
        item.subgrupo,          // Subgrupo
        item.talle,             // Talles
        item.color,             // Colores (NUEVO)
        item.stock,             // Stock
        '1'                     // Filas (siempre 1 porque ya repetimos)
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(hojaDatos);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Productos');

    // üî• Agregar hoja de instrucciones
    const instrucciones = [
      ['INSTRUCCIONES PARA IMPORTAR EN STEP3'],
      [''],
      ['1. Guard√° este archivo Excel'],
      ['2. En step3, us√° el bot√≥n "üìÇ Importar lista de productos"'],
      ['3. Seleccion√° este archivo'],
      ['4. Las filas se crear√°n autom√°ticamente con:'],
      ['   ‚Ä¢ Grupo y Subgrupo ya definidos'],
      ['   ‚Ä¢ Talles y Colores pre-cargados'],
      ['   ‚Ä¢ Stock inicial establecido'],
      ['5. Solo falta:'],
      ['   ‚Ä¢ Asignar im√°genes a cada producto'],
      ['   ‚Ä¢ Completar precios (opcional aqu√≠)'],
      ['   ‚Ä¢ Agregar descripciones (opcional)'],
      [''],
      ['FORMATO DE CAMPOS:'],
      ['‚Ä¢ Talles: S,M,L,XL (separados por comas)'],
      ['‚Ä¢ Colores: Rojo,Azul,Verde (separados por comas)'],
      ['‚Ä¢ Stock: N√∫mero entero (0 si no hay stock)'],
      [''],
      ['‚ö†Ô∏è IMPORTANTE:'],
      ['Si hay Talles Y Colores, step3 calcular√° autom√°ticamente'],
      ['todas las combinaciones posibles.']
    ];
    
    const wsInst = XLSX.utils.aoa_to_sheet(instrucciones);
    XLSX.utils.book_append_sheet(wb, wsInst, 'Instrucciones');

    // Formatear columnas
    const colAnchos = [
      { wch: 25 }, // Nombre
      { wch: 30 }, // Descripci√≥n
      { wch: 12 }, // Precio
      { wch: 15 }, // Grupo
      { wch: 15 }, // Subgrupo
      { wch: 15 }, // Talles
      { wch: 15 }, // Colores
      { wch: 10 }, // Stock
      { wch: 8 }   // Filas
    ];
    ws['!cols'] = colAnchos;

    // üî• Guardar lista en localStorage para step3
    const listaSimplificada = datos.map(item => ({
      grupo: item.grupo,
      subgrupo: item.subgrupo,
      cantidad: 1,
      talles: item.talle,
      colores: item.color,
      stock: item.stock
    }));
    
    localStorage.setItem('listas_step2-5', JSON.stringify(listaSimplificada));
    console.log('üìã Lista guardada para step3:', listaSimplificada);

    // Generar nombre de archivo
    const fecha = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `productos_completo_${fecha}.xlsx`);

    // Mostrar vista previa
    probarVistaPrevia();

    // Mostrar mensaje de √©xito
    alert(`‚úÖ Excel generado exitosamente!\n\n‚Ä¢ ${datos.length} filas creadas\n‚Ä¢ Campos: Nombre, Grupo, Subgrupo, Talles, Colores, Stock\n‚Ä¢ Listo para importar en step3\n\nLa lista se guard√≥ autom√°ticamente. Pod√©s ir a step3 ahora.`);
  }

  // Inicializar con algunas filas
  window.addEventListener('load', () => {
    // Agregar 2 filas de ejemplo
    for (let i = 0; i < 2; i++) {
      agregarFila();
    }

    // Poblar primera fila con ejemplo
    const primeraFila = document.querySelector('.fila-entrada');
    if (primeraFila) {
      primeraFila.querySelector('[data-field="grupo"]').value = 'Ropa Mujer';
      primeraFila.querySelector('[data-field="subgrupo"]').value = 'Pantalones';
      primeraFila.querySelector('[data-field="producto"]').value = 'Jean Slim';
      primeraFila.querySelector('[data-field="talle"]').value = '36,38,40,42';
      primeraFila.querySelector('[data-field="color"]').value = 'Azul,Negro';
      primeraFila.querySelector('[data-field="stock"]').value = '20';
    }

    // Mostrar botones de eliminar en todas las filas excepto la primera
    document.querySelectorAll('.fila-entrada').forEach((fila, index) => {
      if (index > 0) {
        const btnEliminar = fila.querySelector('button');
        if (btnEliminar) btnEliminar.style.display = 'inline-block';
      }
    });
  });
</script>
</body>
</html>
