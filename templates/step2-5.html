<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Armar plantilla de productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ESTILOS PARA EL SISTEMA VISUAL */
    .color-selector {
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .color-chip {
      display: inline-flex;
      align-items: center;
      padding: 8px 15px;
      margin: 5px;
      border-radius: 25px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
      user-select: none;
      min-width: 100px;
      justify-content: space-between;
    }
    
    .color-chip.seleccionado {
      border-color: #ff6f61 !important;  /* Contorno rojo/naranja cuando est√° activo */
      background: rgba(255,255,255,0.1);
      transform: scale(1.05);
    }
    
    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .stock-badge {
      background: rgba(0,0,0,0.3);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
      font-size: 0.85em;
      font-weight: bold;
    }
    
    .talle-container {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .talle-chip {
      display: inline-block;
      padding: 8px 15px;
      margin: 4px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      cursor: pointer;
      min-width: 40px;
      text-align: center;
      transition: all 0.2s;
    }
    
    .talle-chip.seleccionado {
      border-color: #ff6f61 !important;  /* Contorno rojo/naranja para talle seleccionado */
      background: rgba(255, 111, 97, 0.1);
      transform: scale(1.1);
    }
    
    .color-tag {
      font-size: 0.8em;
      opacity: 0.8;
      margin-left: 5px;
    }
    
    .color-creator {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 10px;
      margin-top: 15px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .color-chip {
        min-width: 80px;
        padding: 6px 10px;
        font-size: 0.9em;
      }
      
      .talle-chip {
        padding: 6px 10px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="text-white mb-4">Sistema Visual de Variantes</h2>
  
  <!-- FORMULARIO PRINCIPAL -->
  <div class="row mb-4">
    <div class="col-md-3">
      <input type="text" class="form-control mb-2" placeholder="Grupo" id="grupoInput">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control mb-2" placeholder="Subgrupo" id="subgrupoInput">
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control mb-2" placeholder="Producto" id="productoInput">
    </div>
  </div>
  
  <!-- SECCI√ìN COLORES -->
  <div class="card bg-dark text-white mb-4">
    <div class="card-body">
      <h5 class="mb-3">üé® Seleccion√° colores y stock</h5>
      
      <!-- Color picker -->
      <div class="color-creator mb-4">
        <div class="row g-2">
          <div class="col-2">
            <input type="color" class="form-control form-control-color" 
                   id="colorPicker" title="Elegir color" style="height: 38px;">
          </div>
          <div class="col-3">
            <input type="text" class="form-control" id="colorNombre" 
                   placeholder="Nombre (ej: Rojo)">
          </div>
          <div class="col-2">
            <input type="number" class="form-control" id="colorStock" 
                   placeholder="Stock" min="0" value="0">
          </div>
          <div class="col-5">
            <input type="text" class="form-control" id="colorTalles" 
                   placeholder="Talles para este color (ej: S,M,L)">
          </div>
          <div class="col-12 mt-2">
            <button class="btn btn-gradient w-100" onclick="agregarColor()">
              + Agregar este color
            </button>
          </div>
        </div>
      </div>
      
      <!-- Chips de colores -->
      <div class="color-selector">
        <h6 class="text-white-50 mb-3">Colores agregados:</h6>
        <div id="coloresContainer" class="mb-4">
          <!-- Se llena din√°micamente -->
        </div>
      </div>
      
      <!-- Talles por color seleccionado -->
      <div class="talle-container" id="talleContainer" style="display: none;">
        <h6 id="talleTitulo" class="text-white-50 mb-3">üìè Talles disponibles para: <span id="colorSeleccionadoNombre"></span></h6>
        <div id="tallesContainer">
          <!-- Se llena din√°micamente seg√∫n color -->
        </div>
        <div class="mt-3">
          <small class="text-white-50">Hac√© clic en los talles para marcarlos como disponibles para este color.</small>
        </div>
      </div>
    </div>
  </div>
  
  <!-- BOT√ìN PARA GENERAR EXCEL -->
  <div class="text-center">
    <button class="btn btn-gradient btn-lg" onclick="generarExcel()">
      üì• Generar Excel
    </button>
    <p class="text-white-50 mt-2">El Excel incluir√° todas las variantes definidas visualmente</p>
  </div>
  
  <!-- PREVIEW DE DATOS -->
  <div class="card bg-dark text-white mt-4" id="previewCard" style="display: none;">
    <div class="card-body">
      <h5>üìã Vista previa de variantes</h5>
      <pre id="dataPreview" class="text-white" style="white-space: pre-wrap; font-size: 0.9em;"></pre>
    </div>
  </div>
</div>

<script>
  // DATOS
  let coloresData = []; // [{nombre, hex, stock, talles}]
  let colorSeleccionadoIndex = -1;
  let tallesDisponibles = ['XS','S','M','L','XL','XXL','XXXL','36','38','40','42','44','46','48'];
  
  // FUNCIONES
  function agregarColor() {
    const nombre = document.getElementById('colorNombre').value.trim();
    const hex = document.getElementById('colorPicker').value;
    const stock = parseInt(document.getElementById('colorStock').value) || 0;
    const tallesTexto = document.getElementById('colorTalles').value.trim();
    
    if (!nombre) {
      alert('Ingres√° un nombre para el color');
      return;
    }
    
    // Convertir texto de talles a array
    const tallesArray = tallesTexto 
      ? tallesTexto.split(',').map(t => t.trim()).filter(t => t)
      : [];
    
    // Agregar a datos
    coloresData.push({
      nombre,
      hex,
      stock,
      talles: tallesArray,
      tallesSeleccionados: [...tallesArray] // Copia inicial
    });
    
    // Actualizar UI
    actualizarColoresUI();
    limpiarFormularioColor();
    
    // Mostrar preview
    mostrarPreview();
  }
  
  function actualizarColoresUI() {
    const container = document.getElementById('coloresContainer');
    container.innerHTML = '';
    
    coloresData.forEach((color, index) => {
      const chip = document.createElement('div');
      chip.className = `color-chip ${index === colorSeleccionadoIndex ? 'seleccionado' : ''}`;
      chip.style.borderColor = color.hex; // Contorno del color
      chip.innerHTML = `
        <div style="display: flex; align-items: center;">
          <div class="color-preview" style="background-color:${color.hex}"></div>
          <span>${color.nombre}</span>
          <span class="stock-badge">${color.stock}</span>
        </div>
        ${color.talles.length > 0 ? 
          `<small class="text-white-50">(${color.talles.length} talles)</small>` : 
          `<small class="text-white-50">(sin talles)</small>`
        }
      `;
      
      chip.addEventListener('click', () => seleccionarColor(index));
      container.appendChild(chip);
    });
  }
  
  function seleccionarColor(index) {
    colorSeleccionadoIndex = index;
    actualizarColoresUI();
    mostrarTallesParaColor();
  }
  
  function mostrarTallesParaColor() {
    const container = document.getElementById('talleContainer');
    const titulo = document.getElementById('talleTitulo');
    const tallesContainer = document.getElementById('tallesContainer');
    
    if (colorSeleccionadoIndex === -1 || !coloresData[colorSeleccionadoIndex]) {
      container.style.display = 'none';
      return;
    }
    
    const color = coloresData[colorSeleccionadoIndex];
    container.style.display = 'block';
    document.getElementById('colorSeleccionadoNombre').textContent = color.nombre;
    
    // Crear chips de talle
    tallesContainer.innerHTML = '';
    
    tallesDisponibles.forEach(talle => {
      const chip = document.createElement('div');
      chip.className = `talle-chip ${color.tallesSeleccionados.includes(talle) ? 'seleccionado' : ''}`;
      chip.textContent = talle;
      chip.style.borderColor = color.hex; // Contorno del color del talle!
      
      chip.addEventListener('click', () => {
        const index = color.tallesSeleccionados.indexOf(talle);
        if (index === -1) {
          // Agregar talle
          color.tallesSeleccionados.push(talle);
        } else {
          // Quitar talle
          color.tallesSeleccionados.splice(index, 1);
        }
        
        // Actualizar UI
        chip.classList.toggle('seleccionado');
        mostrarPreview();
      });
      
      tallesContainer.appendChild(chip);
    });
  }
  
  function limpiarFormularioColor() {
    document.getElementById('colorNombre').value = '';
    document.getElementById('colorStock').value = '0';
    document.getElementById('colorTalles').value = '';
    // Mantener el color picker como est√°
  }
  
  function mostrarPreview() {
    const preview = document.getElementById('dataPreview');
    const card = document.getElementById('previewCard');
    
    if (coloresData.length === 0) {
      card.style.display = 'none';
      return;
    }
    
    let texto = `Producto: ${document.getElementById('productoInput').value || 'Sin nombre'}\n`;
    texto += `Grupo: ${document.getElementById('grupoInput').value || 'Sin grupo'}\n`;
    texto += `Subgrupo: ${document.getElementById('subgrupoInput').value || 'Sin subgrupo'}\n\n`;
    texto += 'üé® VARIANTES DEFINIDAS:\n';
    
    coloresData.forEach(color => {
      texto += `\n‚ñ∏ ${color.nombre} (Stock: ${color.stock})\n`;
      texto += `   Talles: ${color.tallesSeleccionados.length > 0 ? color.tallesSeleccionados.join(', ') : 'Sin talles definidos'}\n`;
      
      // Calcular stock por talle si hay m√∫ltiples talles
      if (color.tallesSeleccionados.length > 0) {
        const stockPorTalle = Math.floor(color.stock / color.tallesSeleccionados.length);
        const sobra = color.stock % color.tallesSeleccionados.length;
        
        texto += `   Stock por talle: `;
        color.tallesSeleccionados.forEach((talle, i) => {
          const stockTalle = stockPorTalle + (i < sobra ? 1 : 0);
          texto += `${talle}=${stockTalle} `;
        });
      }
    });
    
    preview.textContent = texto;
    card.style.display = 'block';
  }
  
  function generarExcel() {
    const grupo = document.getElementById('grupoInput').value.trim();
    const subgrupo = document.getElementById('subgrupoInput').value.trim();
    const producto = document.getElementById('productoInput').value.trim();
    
    if (!grupo || !producto) {
      alert('Complet√° Grupo y Producto antes de generar el Excel');
      return;
    }
    
    if (coloresData.length === 0) {
      alert('Agreg√° al menos un color');
      return;
    }
    
    // Crear hoja de Excel
    const hojaDatos = [
      ['Nombre', 'Descripci√≥n', 'Precio', 'Grupo', 'Subgrupo', 'Talles', 'Colores', 'Stock', 'Filas']
    ];
    
    // Crear una fila por cada combinaci√≥n color-talle
    coloresData.forEach(color => {
      if (color.tallesSeleccionados.length === 0) {
        // Producto sin talles (solo color)
        hojaDatos.push([
          `${producto} (${color.nombre})`,
          '',
          '',
          grupo,
          subgrupo,
          '',
          color.nombre,
          color.stock,
          '1'
        ]);
      } else {
        // Productos con talles
        color.tallesSeleccionados.forEach(talle => {
          // Calcular stock para este talle espec√≠fico
          const stockPorTalle = Math.floor(color.stock / color.tallesSeleccionados.length);
          const indexTalle = color.tallesSeleccionados.indexOf(talle);
          const sobra = color.stock % color.tallesSeleccionados.length;
          const stockFinal = stockPorTalle + (indexTalle < sobra ? 1 : 0);
          
          hojaDatos.push([
            `${producto} (${talle} - ${color.nombre})`,
            '',
            '',
            grupo,
            subgrupo,
            talle,
            color.nombre,
            stockFinal,
            '1'
          ]);
        });
      }
    });
    
    // Generar Excel
    const XLSX = window.XLSX;
    const ws = XLSX.utils.aoa_to_sheet(hojaDatos);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Productos');
    
    // Formatear columnas
    const colAnchos = [
      { wch: 30 }, { wch: 25 }, { wch: 12 }, { wch: 15 }, 
      { wch: 15 }, { wch: 10 }, { wch: 12 }, { wch: 8 }, { wch: 6 }
    ];
    ws['!cols'] = colAnchos;
    
    // Guardar
    const fecha = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    XLSX.writeFile(wb, `productos_${fecha}.xlsx`);
    
    alert(`‚úÖ Excel generado con ${hojaDatos.length - 1} variantes`);
  }
  
  // INICIALIZAR CON ALGUNOS COLORES DE EJEMPLO
  window.addEventListener('load', () => {
    // Cargar ejemplo inicial
    coloresData = [
      {
        nombre: 'Rojo',
        hex: '#dc3545',
        stock: 4,
        talles: ['S','M','L','XL'],
        tallesSeleccionados: ['S','M','L','XL']
      },
      {
        nombre: 'Blanco',
        hex: '#ffffff',
        stock: 2,
        talles: ['M','XL'],
        tallesSeleccionados: ['M','XL']
      },
      {
        nombre: 'Negro',
        hex: '#000000',
        stock: 5,
        talles: ['S','L'],
        tallesSeleccionados: ['S','L']
      }
    ];
    
    // Poblar inputs de ejemplo
    document.getElementById('grupoInput').value = 'Ropa Mujer';
    document.getElementById('subgrupoInput').value = 'Pantalones';
    document.getElementById('productoInput').value = 'Jean Slim';
    
    // Actualizar UI
    actualizarColoresUI();
    seleccionarColor(0); // Seleccionar primer color
    mostrarPreview();
  });
</script>

<!-- Incluir biblioteca XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>
