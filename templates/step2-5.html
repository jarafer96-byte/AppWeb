<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Step2-5 - Armar catÃ¡logo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; }
    h2 { color:#fff; font-weight:bold; }
    .card { background-color:rgba(255,255,255,0.05); border-radius:12px; padding:20px; }
    .form-control { background-color:rgba(255,255,255,0.05); color:#fff; border:none; border-radius:8px; }
    .form-control::placeholder { color:#aaa; }
    .btn-gradient { background:linear-gradient(135deg,#8e2de2,#ff6f61); color:#fff; border:none; padding:10px 24px; border-radius:50px; font-weight:bold; }
    .btn-gradient:hover { transform:scale(1.05); }
  </style>
</head>
<body>
<div class="container py-5">
  <h2 class="mb-4 text-center">Step2-5 - Armar catÃ¡logo</h2>

  <form class="card mb-4" onsubmit="prepararStep3DesdeForm()">
    <div id="listas-container">
      <!-- 5 filas iniciales -->
      <div class="mb-2 d-flex flex-row align-items-center gap-3">
        <span class="fw-bold">#1</span>
        <input type="text" name="grupo_1" class="form-control" placeholder="Grupo (ej: Ropa Mujer)">
        <input type="text" name="subgrupo_1" class="form-control" placeholder="Subgrupo (opcional)">
        <input type="number" name="filas_1" class="form-control" min="1" value="1" style="width:100px;">
        <input type="text" name="talles_1" class="form-control" placeholder="Talles (ej: S,M,L)" style="width:160px;">
      </div>
    </div>
    <button type="button" class="btn-gradient mt-2" onclick="agregarFila()">+ Agregar fila</button>
    <button type="submit" class="btn-gradient mt-3">Guardar y continuar</button>
  </form>
</div>

<script>
function agregarFila() {
  const container = document.getElementById('listas-container');
  const index = container.children.length + 1;
  const div = document.createElement('div');
  div.className = "mb-2 d-flex flex-row align-items-center gap-3";
  div.innerHTML = `
    <span class="fw-bold">#${index}</span>
    <input type="text" name="grupo_${index}" class="form-control" placeholder="Grupo">
    <input type="text" name="subgrupo_${index}" class="form-control" placeholder="Subgrupo (opcional)">
    <input type="number" name="filas_${index}" class="form-control" min="1" value="1" style="width:100px;">
    <input type="text" name="talles_${index}" class="form-control" placeholder="Talles (ej: S,M,L)" style="width:160px;">
  `;
  container.appendChild(div);
}

function prepararStep3DesdeForm() {
  const filas = [];
  const container = document.getElementById('listas-container');

  container.querySelectorAll('div').forEach((fila, idx) => {
    const grupo = fila.querySelector(`[name="grupo_${idx+1}"]`)?.value.trim() || "";
    const subgrupo = fila.querySelector(`[name="subgrupo_${idx+1}"]`)?.value.trim() || "";
    const cantidad = parseInt(fila.querySelector(`[name="filas_${idx+1}"]`)?.value || "1", 10);
    const tallesRaw = fila.querySelector(`[name="talles_${idx+1}"]`)?.value.trim() || "";
    const productoBase = subgrupo || grupo;

    if (!grupo) return;

    let productos = [];
    if (cantidad > 1) {
      for (let i = 1; i <= cantidad; i++) {
        productos.push(`${productoBase}${i}`);
      }
    } else {
      productos.push(productoBase);
    }

    // Manejo de talles â†’ SOLO coma expande
    let listaTalles = [];
    if (tallesRaw.includes(",")) {
      listaTalles = tallesRaw.split(",").map(t => t.trim()).filter(Boolean);
    } else {
      listaTalles = [tallesRaw]; // texto plano
    }

    productos.forEach(prod => {
      listaTalles.forEach(talle => {
        filas.push({
          grupo,
          subgrupo, // puede ser vacÃ­o, Step3 lo toma como "General"
          nombre: prod,
          descripcion: "",
          precio: "",
          talles: talle,
          cantidad: 1,
          orden: filas.length + 1
        });
      });
    });
  });

  localStorage.setItem("listas_step2-5", JSON.stringify(filas));
  console.log("ðŸ’¾ [Step2-5] Guardada estructura:", filas);

  alert("âœ… Datos guardados. Ahora podÃ©s continuar a Step3.");
}
</script>
</body>
</html>
