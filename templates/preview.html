<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vista previa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Vista previa para redes sociales -->
  <meta property="og:title" content="{{ config.titulo }}">
  <meta property="og:description" content="{{ config.descripcion }}">
  <meta property="og:image" content="{{ config.imagen_destacada }}">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="{{ config.url }}">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Google Fonts disponibles -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Playfair+Display&family=Fira+Code&family=Raleway&family=Quicksand&family=Pacifico&family=Source+Serif+4&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  {% set estilo = config.estilo_visual.lower() %}
  {% if 'claro' in estilo or 'esferas' in estilo or 'blanco' in estilo %}
    {% set modo_visual = 'modo-claro' %}
  {% else %}
    {% set modo_visual = 'modo-oscuro' %}
  {% endif %}

<style>
body {
  font-family: {{ config.fuente | safe }};
  {% if config.estilo_visual %}
  background-image: url("/static/img/{{ config.estilo_visual }}.jpeg");
  {% else %}
  background-color: #121212; /* fallback seguro */
  {% endif %}
  background-size: cover; background-repeat: no-repeat; background-attachment: fixed; background-position: center; padding-top: 70px;
}

h1, h2, h3, .btn, .card { font-family: {{ config.fuente | safe }}; }

body::before { content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: -1; }

.fade-reorder { opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; }

.fade-reorder.show { opacity: 1; transform: scale(1); }

.show { opacity: 1; transform: scale(1); transition: opacity 0.3s ease, transform 0.3s ease; }

.fondo-animado { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -2; background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08), transparent 40%), radial-gradient(circle at 80% 70%, rgba(255,255,255,0.06), transparent 40%); animation: moverFondo 40s ease-in-out infinite; background-size: 200% 200%; pointer-events: none; }

html { scroll-behavior: auto; }

.card { transition: transform 0.3s ease, box-shadow 0.3s ease; border-radius: 12px; overflow: hidden; will-change: transform, box-shadow; padding: 12px; }

.card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

.modo-oscuro .card:hover { box-shadow: 0 8px 20px rgba(255,255,255,0.2); }

.modo-claro .card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

.card-img-top { width: 100%; max-width: 300px; height: auto; display: block; margin-left: auto; margin-right: auto; }

.card-body { padding: 10px; }

.card-title { font-size: 1rem; }

.card-text { font-size: 0.9rem; }

.modo-claro .card { background-color: #fff; color: #333; border: none; }

.modo-oscuro .card { background-color: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.2); }

.color-principal { color: inherit; /* o un color fijo, ej. #ff6f61 */ }

.bg-principal { background-color: transparent; /* o un color fijo */ }

.modo-oscuro { color: white; }

.modo-claro { color: #333; }

.barra-navegacion { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); display: flex; justify-content: center; gap: 16px; padding: 12px 20px; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); }

.barra-navegacion button { font-family: {{ config.fuente | safe }}; font-weight: 600; font-size: 16px; padding: 10px 20px; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }

/* Animaciones */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

@keyframes moverFondo { 0% { background-position: 0% 0%; } 50% { background-position: 100% 100%; } 100% { background-position: 0% 0%; } }

.barra-navegacion button:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); box-shadow: 0 0 8px rgba(255, 255, 255, 0.3); }

.barra-wrapper { z-index: 1000; }

.panel-grupos { position: fixed; max-height: 50vh; overflow-y: auto; left: 0; right: 0; z-index: 906; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); padding: 1px 0; text-align: center; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); }

.panel-grupos button { font-family: {{ config.fuente | safe }}; font-weight: 600; margin: 6px; padding: 2px 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 30px; background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s ease; }

.panel-grupos button:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); box-shadow: 0 0 8px rgba(255, 255, 255, 0.3); }

.oculta { display: none !important; }

.logo { height: 10vw; max-height: 380px; filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px white); transition: filter 0.3s ease; animation: pulsoLogo 4s ease-in-out infinite; }

@keyframes pulsoLogo { 0%, 100% { filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px none); } 50% { filter: brightness(1.8) contrast(1.3) drop-shadow(0 0 20px none); } }

.descripcion-emprendimiento { background-color: rgba(0, 0, 0, 0.5); color: white; padding: 20px; border-radius: 10px; display: inline-block; max-width: 800px; white-space: pre-line; text-align: center; text-indent: 20px; font-size: 16px; line-height: 1.6; box-shadow: 0 0 6px rgba(255,255,255,0.3); }

.btn-grupo { position: relative; padding: 8px 16px; margin: 5px; border-radius: 20px; font-weight: bold; background-color: rgba(0, 0, 0, 0.5); color: white; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 0 6px rgba(255,255,255,0.3); transition: all 0.3s ease; overflow: hidden; }

.modo-claro .btn-grupo { background-color: transparent; color: white; border: none; }

.modo-oscuro .btn-grupo { background-color: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 0 4px rgba(255,255,255,0.1); }

.btn-grupo::before { content: ""; position: absolute; inset: 0; border-radius: 20px; z-index: -1; }

.modo-claro .btn-grupo::before { background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08), transparent 70%); }

.modo-oscuro .btn-grupo::before { background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05), transparent 70%); }

.btn-grupo:hover { background-color: #fff; color: #333; transform: scale(1.05); box-shadow: 0 0 8px none; }

.btn-grupo.active { box-shadow: none; }

.btn-whatsapp { background-color: #25D366; border: none; padding: 8px 16px; color: white; border-radius: 5px; font-size: 14px; }

.btn-volver-arriba { background-color: white; color: black; border: none; font-size: 20px; box-shadow: 0 0 6px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; -webkit-tap-highlight-color: transparent; }

.btn-volver-arriba:hover { background-color: #f0f0f0; transform: scale(1.1); }

.btn-volver-arriba:focus, .btn-volver-arriba:active, .btn-volver-arriba:visited { outline: none; box-shadow: none; background-color: white; color: black; }

.grupo-section.active { display: block !important; }

/* Bloque de grupo */
.grupo-section { display: block; min-height: 100vh; margin: 20px 0; padding: 15px; border: 2px solid #333; border-radius: 6px; background: #fafafa; }

/* T√≠tulo de grupo */
.grupo-section > h3 { margin: 0 0 10px; font-size: 1.4rem; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; }

/* Bloque de subgrupo dentro del grupo */
.subgrupo-bloque { margin: 15px 0; padding: 10px; border: 1px dashed #666; border-radius: 4px; background: #fff; }

/* T√≠tulo de subgrupo */
.subgrupo-bloque > h4 { margin: 0 0 8px; font-size: 1.1rem; font-weight: 600; color: #444; border-bottom: 1px dotted #aaa; padding-bottom: 4px; }

.subgrupo-bloque .card-producto { margin-bottom: 12px; }

.social-icons { margin-top: 40px; display: flex; justify-content: center; gap: 20px; }

.social-icons img { width: 40px; transition: transform 0.3s ease; filter: drop-shadow(0 0 3px white); }

.social-icons img:hover { transform: scale(1.1); filter: drop-shadow(0 0 0 transparent); }

.bloque-ubicacion { background-color: rgba(0, 0, 0, 0.5); color: white; padding: 12px 16px; border-radius: 10px; text-align: center; max-width: 600px; margin: 20px auto 0; box-shadow: 0 0 6px rgba(255,255,255,0.3); }

#carrito { position: fixed; bottom: 80px; right: 20px; padding: 15px; border-radius: 10px; width: 300px; z-index: 999; display: none; }

.modo-oscuro #carrito { background-color: rgba(0,0,0,0.85); color: white; border: 1px solid white; box-shadow: 0 0 10px white; }

.modo-claro #carrito { background-color: #fff; color: #333; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.2); }

#toggleCarrito { position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 10px 14px; border-radius: 50px; font-weight: bold; box-shadow: 0 0 5px white; }

.modo-oscuro #toggleCarrito { background-color: transparent; color: black; border: none; }

.modo-claro #toggleCarrito { background-color: transparent; color: white; border: none; }

.panel-subcategorias { position: fixed; max-height: 50vh; overflow-y: auto; left: 0; right: 0; z-index: 908; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); padding: 1px 0; text-align: center; box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }

.panel-subcategorias button { font-family: {{ config.fuente | safe }}; font-weight: 600; margin: 6px; padding: 1px 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 30px; background: rgba(255, 255, 255, 0.05); color: white; box-shadow: 0 0 6px rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s ease; }

.panel-subcategorias button:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); }

@media (min-width: 1024px) { .logo { width: 150px; height: 150px; max-height: none; } }

.barra-navegacion { padding: 8px 10px; gap: 8px; }

.barra-navegacion button { font-size: 14px; padding: 8px 15px; }

.panel-grupos { padding: 1px 0; max-height: 50vh; overflow-y: auto; }

.panel-grupos button { font-size: 13px; padding: 1px 6px; border-radius: 8px; }

.panel-subcategorias { padding: 1px 0; max-height: 50vh; overflow-y: auto; }

.panel-subcategorias button { font-size: 13px; padding: 1px 6px; border-radius: 8px; }

.productos-container { margin-top: 30px; }
.logo-wrapper {
  margin-top: 20px;   /* espacio fijo arriba */
  margin-bottom: 20px;/* espacio fijo abajo */
}
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

@keyframes moverFondo { 0% { background-position: 0% 0%; } 50% { background-position: 100% 100%; } 100% { background-position: 0% 0%; } }

</style>
</head>
<body class="container py-5 {{ modo_visual }}">
  
{% if config.logo %}
  <div class="text-center my-5 logo-wrapper">
    <img src="{{ url_for('static', filename='img/' + config.logo) }}"
         alt="Logo"
         class="img-fluid logo mx-auto d-block"
         loading="lazy">
  </div>
{% endif %}

{% if config.sobre_mi %}
  <div class="text-center mb-4">
    <div class="descripcion-emprendimiento">
       {{ config.sobre_mi | replace('\n', '<br>') | safe }}
    </div>
  </div>
{% endif %} 

  <div class="text-center my-4">
    <select id="ordenPrecio" class="form-select w-auto d-inline-block">
      <option value="asc">Precio: Menor a mayor</option>
      <option value="desc">Precio: Mayor a menor</option>
    </select>
  </div>
  
  <div class="barra-wrapper">
    <nav class="barra-navegacion">
      <button id="btnProductos" onclick="mostrarTodos()">Productos</button>
      <button id="btnContacto" onclick="irAContacto()">Contacto</button>
    </nav>

    <!-- Panel de grupos: ahora vac√≠o, se llena con JS -->
    <div id="panelGrupos" class="panel-grupos oculta">
      <!-- Los botones de grupo se generan din√°micamente desde la API -->
    </div>
  </div>

  <!-- Panel de subcategor√≠as: tambi√©n se llena con JS -->
  <div id="panelSubcategorias" class="panel-subcategorias oculta"></div>
  <!-- Contenedor principal de productos -->
<div id="productos" class="row productos-container"></div>


  <button id="volverArriba" class="btn btn-volver-arriba" 
          style="position: fixed; bottom: 20px; left: 20px; display: none; z-index: 1000;">
    ‚Üë
  </button>

<div id="contenedor-grupos"></div>
  
<div id="paginacion" class="text-center mt-3"></div>

<div class="text-center mt-5">
  <a href="/descargar" class="btn btn-primary px-5">
    Descargar sitio
  </a>
</div>

<div class="social-icons">
  {% if config.facebook %}
    <a href="{{ config.facebook }}" target="_blank">
      <img src="/static/img/facebook.png" alt="Facebook" loading="lazy">
    </a>
  {% endif %}
  {% if config.instagram %}
    <a href="{{ config.instagram }}" target="_blank">
      <img src="/static/img/instagram.png" alt="Instagram" loading="lazy">
    </a>
  {% endif %}
  {% if config.whatsapp %}
    <a href="{{ config.whatsapp }}" target="_blank">
      <img src="/static/img/whatsapp.png" alt="WhatsApp" loading="lazy">
    </a>
  {% endif %}
</div>

{% if config.ubicacion %}
  <div id="ubicacion" class="bloque-ubicacion text-center mt-4">
    <p style="margin-bottom: 6px;">
      üìç {{ config.ubicacion }}
    </p>
    {% if config.link_mapa %}
      <a href="{{ config.link_mapa }}" target="_blank" style="text-decoration: none;">
        <span style="margin-right: 6px;">‚ûú</span>
        <img src="/static/img/map.png" alt="Ver en Google Maps" style="width: 30px;" loading="lazy">
      </a>
    {% endif %}
  </div>
{% endif %}
  
<form onsubmit="loginAdmin(event)" class="mt-4 text-center">
  <input type="text" id="usuario_login" placeholder="Usuario" required>
  <input type="password" id="clave_login" placeholder="Contrase√±a" required>
  <button type="submit">Entrar</button>
</form>
<div class="text-center mt-4" id="logoutAdminWrapper" style="display:none;">
  <button type="button" class="btn btn-danger" onclick="salirAdmin()">üö™ Salir de Admin</button>
</div>
  
{% if modoAdmin %}
  <div class="text-center mt-4">
    <form action="/logout-admin" method="post">
      <button type="submit" class="btn btn-danger">üö™ Salir de Admin</button>
    </form>
  </div>
{% endif %}
  
<button id="toggleCarrito">üõí</button>

<div id="carrito">
  <h5>üõí Tu carrito</h5>
  <ul id="listaCarrito"></ul>
  <p><strong>Total:</strong> $<span id="totalCarrito">0</span></p>
  <div class="d-grid gap-2">
    <button class="btn btn-sm btn-danger" onclick="vaciarCarrito()">Vaciar carrito</button>

    {% if config.mercado_pago and config.public_key %}
      <button id="btn_pagar" class="btn btn-sm btn-primary" onclick="pagarConMercadoPago()">Pagar con Mercado Pago</button>
    {% else %}
      <a id="enviarCarrito" class="btn btn-sm btn-success" target="_blank">Enviar por WhatsApp</a>
    {% endif %}
  </div>
</div>

<!-- Aviso flotante de precio actualizado -->
<div id="avisoPrecio" class="alert alert-success text-center" role="alert"
     style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Precio actualizado
</div>

<!-- Aviso flotante de talle actualizado -->
<div id="avisoTalle" class="alert alert-info text-center" role="alert"
     style="display: none; position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Talle actualizado
</div>

  <script>
const configWhatsApp = "{{ config.whatsapp }}";
// Si hay sesi√≥n (preview), usa ese email.
// Si no hay sesi√≥n (index est√°tico), usa el email fijo del due√±o.
const EMAIL_VENDEDOR = "{{ session.get('email') or 'usuario@ejemplo.com' }}";

const URL_BACKEND = "https://mpagina.onrender.com"; // Tu URL central

  // Mostrar/ocultar bot√≥n volver arriba
  window.addEventListener('scroll', () => {
    const btn = document.getElementById('volverArriba');
    btn.style.display = window.scrollY > 300 ? 'block' : 'none';
    btn.style.backgroundColor = 'white';
    btn.style.color = 'black';
  });

  document.getElementById('volverArriba').onclick = () => {
    window.scrollTo({ top: 0, behavior: 'auto' });
  };
    
// Configuraci√≥n de paginaci√≥n
const itemsPorPagina = 12;
let totalPaginas = 0;

 function salirAdmin() {
    window.modoAdmin = false;
    // refrescar productos para que se oculten los botones ‚úé
    if (window.todosLosProductos) {
      const cont = document.getElementById("productos");
      cont.innerHTML = "";
      window.todosLosProductos.forEach(p => cont.appendChild(renderProducto(p)));
    }
    document.getElementById("logoutAdminWrapper").style.display = "none";
  }

  // Mostrar el bot√≥n solo si modoAdmin est√° activo
  if (window.modoAdmin) {
    document.getElementById("logoutAdminWrapper").style.display = "block";
  }
    
function renderPagina(pagina, productosFiltrados) {
  const cont = document.getElementById("productos"); // üëà agregar esto
  totalPaginas = Math.ceil(productosFiltrados.length / itemsPorPagina);

  const inicio = (pagina - 1) * itemsPorPagina;
  const fin = inicio + itemsPorPagina;
  const productosPagina = productosFiltrados.slice(inicio, fin);

  cont.innerHTML = "";
  productosPagina.forEach(p => cont.appendChild(renderProducto(p)));
}


function renderPaginacion(productosFiltrados) {
  const pagDiv = document.getElementById("paginacion");
  pagDiv.innerHTML = "";
  totalPaginas = Math.ceil(productosFiltrados.length / itemsPorPagina);

  for (let i = 1; i <= totalPaginas; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = "btn btn-light mx-1";
    btn.onclick = () => renderPagina(i, productosFiltrados);
    pagDiv.appendChild(btn);
  }
}

// Construir la URL con las constantes definidas arriba
const urlProductos = `${URL_BACKEND}/api/productos?usuario=${encodeURIComponent(EMAIL_VENDEDOR)}`;

fetch(urlProductos)
  .then(r => {
    if (!r.ok) {
      throw new Error("HTTP " + r.status);
    }
    return r.json();
  })
  .then(lista => {
    window.todosLosProductos = Array.isArray(lista) ? lista : [];
    console.log("üåê Productos recibidos de la API:", window.todosLosProductos.length, window.todosLosProductos);

    const cont = document.getElementById("productos");
    const contGrupos = document.getElementById("panelGrupos");
    const contSub = document.getElementById("panelSubcategorias");

    if (!cont) {
      console.warn("‚ö†Ô∏è No existe #productos en el DOM");
      return;
    }
    if (!contGrupos || !contSub) {
      console.warn("‚ö†Ô∏è Faltan paneles #panelGrupos o #panelSubcategorias en el DOM");
    }

    const grupos = [...new Set(window.todosLosProductos.map(p => p.grupo).filter(Boolean))];
    console.log("üìÇ Grupos detectados:", grupos);

    if (contGrupos) {
      contGrupos.innerHTML = ""; // limpiar antes de insertar
      grupos.forEach(g => {
        const btn = document.createElement("button");
        btn.className = "btn-grupo";
        btn.textContent = g;
        btn.addEventListener("click", (e) => {
          console.log("üü¢ Click en bot√≥n grupo:", g);
          mostrarGrupo(g, e);
        });
        contGrupos.appendChild(btn);
        console.log("‚ûï Bot√≥n grupo creado:", g);
      });
    }

    // Render inicial: primer grupo y subgrupo
    const primerGrupo = grupos[0];
    const subgruposPrimer = [...new Set(window.todosLosProductos
      .filter(p => p.grupo === primerGrupo)
      .map(p => p.subgrupo).filter(Boolean))];

    console.log("üéØ Primer grupo:", primerGrupo);
    console.log("üìÇ Subgrupos del primer grupo:", subgruposPrimer);

    if (primerGrupo) {
      mostrarGrupo(primerGrupo, null, true);
      if (subgruposPrimer.length > 0) {
        console.log("‚û°Ô∏è Render inicial con subgrupo:", subgruposPrimer[0]);
        filtrarSubcategoria(primerGrupo, subgruposPrimer[0]);
      }
    }

    console.log("‚úÖ Render inicial completado");
  })
  .catch(err => {
    console.error("Error cargando productos:", err);
    const cont = document.getElementById("productos");
    if (cont) cont.innerHTML = "<p>Error al cargar productos.</p>";
  });
    
function mostrarGrupo(nombre, event, auto = false) {
  console.log("üü¶ mostrarGrupo llamado con:", { nombre, auto });

  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }

  // Resetear botones de grupo
  document.querySelectorAll('.btn-grupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) {
    event.target.classList.add('active');
    console.log("üëâ Bot√≥n de grupo marcado:", event.target.textContent);
  }

  const panel = document.getElementById('panelSubcategorias');
  if (!panel) {
    console.warn("‚ö†Ô∏è No existe #panelSubcategorias en el DOM");
    return;
  }
  panel.innerHTML = "";

  // Normalizar y guardar grupo activo
  const grupoCanon = String(nombre || "").trim();
  window.currentGrupo = grupoCanon.toLowerCase();
  console.log("üéØ Grupo activo (canon):", grupoCanon);

  const productosGrupo = (window.todosLosProductos || []).filter(
    p => String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase()
  );
  console.log("üì¶ Productos encontrados para grupo:", productosGrupo.length);

  const subcategorias = [...new Set(
    productosGrupo.map(p => p.subgrupo).filter(s => s && String(s).toLowerCase() !== 'general')
  )];
  console.log("üìÇ Subcategor√≠as detectadas:", subcategorias);

  // Crear botones de subgrupo
  subcategorias.forEach(sub => {
    const btn = document.createElement('button');
    btn.textContent = sub;
    btn.className = 'btn-subgrupo';
    btn.addEventListener("click", (e) => mostrarSubgrupo(sub, e));
    panel.appendChild(btn);
    console.log("‚ûï Bot√≥n subgrupo creado:", sub);
  });

  // üîÅ Usar paginaci√≥n en lugar de volcar todo
  renderPagina(1, productosGrupo);
  renderPaginacion(productosGrupo);

  if (subcategorias.length > 0) {
    if (!auto) {
      panel.classList.remove('oculta');
      console.log("üìÇ Panel subcategorias visible");
    } else {
      panel.classList.add('oculta');
      console.log("üìÇ Panel subcategorias oculto (auto)");
    }
  } else {
    panel.classList.add('oculta');
    console.log("üìÇ Grupo sin subcategor√≠as");
  }

  console.log("‚úÖ Productos renderizados con paginaci√≥n en #productos");
  window.scrollTo({ top: 0, behavior: 'auto' });
}
window.mostrarGrupo = mostrarGrupo;

// Extra: log de clicks en botones
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("btn-grupo")) {
    console.log("üü¢ Click en bot√≥n grupo:", e.target.textContent);
  }
  if (e.target.classList.contains("btn-subgrupo")) {
    console.log("üü¢ Click en bot√≥n subgrupo:", e.target.textContent);
  }
});

function filtrarSubcategoria(grupo, subgrupo) {
  console.log("üü® filtrarSubcategoria llamada con:", { grupo, subgrupo });

  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }
  cont.innerHTML = "";

  const grupoCanon = String(grupo || "").trim();
  const subCanon = String(subgrupo || "").trim();
  console.log("üéØ Grupo canon:", grupoCanon, " | Subgrupo canon:", subCanon || `General_${grupoCanon}`);

  // Filtrar productos
  let productosFiltrados;
  if (subCanon) {
    productosFiltrados = window.todosLosProductos.filter(p =>
      String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
      String(p.subgrupo || "").toLowerCase() === subCanon.toLowerCase()
    );
  } else {
    const subgrupoGeneral = `General_${grupoCanon}`;
    productosFiltrados = window.todosLosProductos.filter(p =>
      String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
      String(p.subgrupo || "").toLowerCase() === subgrupoGeneral.toLowerCase()
    );
  }

  console.log("üì¶ Productos filtrados:", productosFiltrados.length);

  // üîÅ Usar paginaci√≥n en lugar de volcar todo
  renderPagina(1, productosFiltrados);
  renderPaginacion(productosFiltrados);

  console.log("‚úÖ Productos renderizados con paginaci√≥n en #productos");
  console.log("üì• Hijos actuales en #productos:", cont.children.length);

  window.scrollTo({ top: 0, behavior: 'auto' });
}
window.filtrarSubcategoria = filtrarSubcategoria;


window.onload = function() {
  const panelSubcategorias = document.getElementById('panelSubcategorias');
  const panelGrupos = document.getElementById('panelGrupos');
  panelSubcategorias.classList.add('oculta');
  panelGrupos.classList.add('oculta');

  document.getElementById('toggleCarrito').onclick = function() {
    const carritoDiv = document.getElementById('carrito');
    if (!carritoDiv) return;
    carritoDiv.style.display = carritoDiv.style.display === 'none' ? 'block' : 'none';
  };
};

let carrito = [];

function agregarAlCarritoDOM(nombre, idPrecioSpan, idCantidad, id_base, grupo = "", subgrupo = "") {
  const cantidadInput = document.getElementById(idCantidad);
  const precioSpan = document.getElementById(idPrecioSpan);
  const talleSelect = document.getElementById("talle_" + id_base);

  const cantidad = parseInt(cantidadInput?.value) || 1;
  const precio = parseFloat(precioSpan?.textContent?.trim()) || 0;
  const talleElegido = talleSelect?.value || "Sin talle";

  const existente = carrito.find(item => item.id_base === id_base && item.talle === talleElegido);
  if (existente) {
    existente.cantidad += cantidad;
  } else {
    const nuevoItem = { nombre, precio, cantidad, id_base, talle: talleElegido, grupo, subgrupo };
    carrito.push(nuevoItem);
  }

  actualizarCarrito();
}

async function pagarConMercadoPago() {
  try {
    if (!carrito.length) {
      alert("Tu carrito est√° vac√≠o");
      return;
    }

    const response = await fetch(`${URL_BACKEND}/pagar`, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        carrito,
        email_vendedor: EMAIL_VENDEDOR,
        url_retorno: window.location.href
      })
    });

    const data = await response.json();

    if (data.preference_id) {
      // ‚úÖ Checkout Pro con SDK
      mp.checkout({
        preference: { id: data.preference_id },
        autoOpen: true
      });
    } else if (data.init_point) {
      // ‚úÖ Fallback cl√°sico
      window.location.href = data.init_point;
    } else {
      alert("Error al generar el pago: " + (data.error || "desconocido"));
    }
  } catch (err) {
    console.error("‚ö†Ô∏è Error al conectar con backend central:", err);
    alert("Error interno al intentar pagar");
  }
}

function editarPrecio(id) {
  const span = document.getElementById("precio_" + id);
  if (!span) return;

  const valorActual = span.textContent.replace("$", "").trim();

  const input = document.createElement("input");
  input.type = "number";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "80px";
  input.id = "input_precio_" + id;

  input.onblur = () => guardarPrecio(id);

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") input.blur(); // dispara onblur
  });

  span.replaceWith(input);
  input.focus();
}

function guardarPrecio(id) {
  const input = document.getElementById("input_precio_" + id);
  if (!input) return;

  const nuevoValor = parseFloat(input.value);
  if (isNaN(nuevoValor)) {
    alert("‚ùå El precio ingresado no es v√°lido");
    return;
  }

  fetch('/actualizar-precio', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, nuevoPrecio: nuevoValor })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const span = document.createElement("span");
        span.id = "precio_" + id;
        const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        span.textContent = "$" + fmt.format(nuevoValor);
        span.className = input.className;
        span.classList.add("text-success");
        input.replaceWith(span);
        setTimeout(() => span.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoPrecio === "function") mostrarAvisoPrecio();
      } else {
        alert("‚ùå No se pudo actualizar el precio en el servidor");
      }
    })
    .catch(() => {
      alert("‚ùå Error de conexi√≥n al guardar el precio");
    });
}

function loginAdmin(event) {
  event.preventDefault();

  const usuario = document.getElementById("usuario_login").value.trim();
  const clave = document.getElementById("clave_login").value.trim();

  if (!usuario || !clave) {
    alert("‚ùå Usuario y clave requeridos");
    return;
  }

  const btn = event.target.querySelector('button[type="submit"]');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Entrando...';
  }

  fetch("https://mpagina.onrender.com/login-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok" && data.token) {
        alert("‚úÖ Acceso concedido");
        // redirigir al preview din√°mico con token en la URL
        location.href = `https://mpagina.onrender.com/preview?token=${data.token}`;
      } else {
        alert("‚ùå " + data.message);
      }
    })
    .catch(() => {
      alert("‚ùå Error al intentar login");
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Entrar';
      }
    });
}
    
function editarTalles(id) {
  const select = document.getElementById("talle_" + id);
  if (!select) return;

  const opciones = Array.from(select.options).map(opt => opt.value).filter(Boolean);
  const valorActual = opciones.join(", ");

  const input = document.createElement("input");
  input.type = "text";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "200px";
  input.id = "input_talles_" + id;

  input.onblur = () => guardarTalles(id);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") input.blur(); });

  select.replaceWith(input);
  input.focus();
}

function guardarTalles(id) {
  const input = document.getElementById("input_talles_" + id);
  if (!input) return;

  const nuevosTalles = input.value.split(",").map(t => t.trim()).filter(t => t);

  fetch('/actualizar-talles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, talles: nuevosTalles })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const nuevoSelect = document.createElement("select");
        nuevoSelect.id = "talle_" + id;
        nuevoSelect.className = "form-select form-select-sm w-auto d-inline-block";

        if (nuevosTalles.length > 0) {
          nuevosTalles.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            nuevoSelect.appendChild(opt);
          });
        } else {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Sin talles";
          nuevoSelect.appendChild(opt);
        }

        input.replaceWith(nuevoSelect);
        nuevoSelect.classList.add("text-success");
        setTimeout(() => nuevoSelect.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoTalle === "function") mostrarAvisoTalle();
      } else {
        alert("‚ùå No se pudo actualizar los talles en el servidor");
      }
    })
    .catch(() => {
      alert("‚ùå Error de conexi√≥n al guardar los talles");
    });
}

function actualizarFirestore(id, datos) {
  if (!id || typeof datos !== "object" || Object.keys(datos).length === 0) {
    return;
  }

  fetch("/actualizar-firestore", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, ...datos })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        if (typeof mostrarAvisoFirestore === "function") mostrarAvisoFirestore();
      } else {
        mostrarAviso("‚ùå " + (data.error || "No se pudo actualizar Firestore"));
      }
    })
    .catch(() => {
      mostrarAviso("‚ùå Error de conexi√≥n al guardar los datos");
    });
}

function guardarProducto(producto) {
  fetch('/guardar-producto', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ producto })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok') {
        mostrarAviso("‚úÖ Producto guardado correctamente");
        cargarProductos(); // refresca cat√°logo despu√©s de guardar
      } else {
        mostrarAviso("‚ùå " + (data.error || "Error al guardar producto"));
      }
    })
    .catch(() => {
      mostrarAviso("‚ùå Error de conexi√≥n");
    });
}

function cargarProductos(emailUsuario = null) {
  let url = "https://mpagina.onrender.com/api/productos";
  if (emailUsuario) {
    url += "?usuario=" + encodeURIComponent(emailUsuario);
  }

  fetch(url)
    .then(res => {
      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }
      return res.json();
    })
    .then(productos => {
      if (Array.isArray(productos)) {
        renderizarProductos(productos);
      } else if (productos.error) {
        mostrarAviso("‚ùå " + productos.error);
      } else {
        mostrarAviso("‚ùå Respuesta inv√°lida del servidor");
      }
    })
    .catch(err => {
      console.error("Error cargando productos:", err);
      mostrarAviso("‚ùå Error al cargar productos");
    });
}

function mostrarAvisoPrecio() {
  const aviso = document.getElementById("avisoPrecio");
  if (!aviso) return;
  aviso.style.display = "block";
  setTimeout(() => {
    aviso.style.display = "none";
  }, 2000);
}

function eliminarProducto(id_base, talle, event) {
  if (event?.stopPropagation) event.stopPropagation();
  carrito = carrito.filter(p => !(p.id_base === id_base && p.talle === talle));
  actualizarCarrito();
}
    
function mostrarSubgrupo(subgrupo, event) {
  console.log("üü© mostrarSubgrupo llamada con:", subgrupo);

  // Buscar el grupo actualmente activo (bot√≥n marcado)
  const grupoActivoBtn = document.querySelector('.btn-grupo.active');
  const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;
  console.log("üéØ Grupo activo detectado:", grupoActivo);

  if (!grupoActivo) {
    console.warn("‚ö†Ô∏è No hay grupo activo para mostrar subgrupo:", subgrupo);
    return;
  }

  // Resetear botones de subgrupo
  document.querySelectorAll('.btn-subgrupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) {
    event.target.classList.add('active');
    console.log("üëâ Bot√≥n subgrupo marcado:", event.target.textContent);
  }

  // Actualizar estado can√≥nico
  const grupoCanon = String(grupoActivo).trim();
  const subCanon = String(subgrupo || "").trim();

  window.currentGrupo = grupoCanon.toLowerCase();
  window.currentSub = subCanon.toLowerCase();
  console.log("üìå Estado can√≥nico actualizado:", { currentGrupo: window.currentGrupo, currentSub: window.currentSub });

  // Filtrar y renderizar productos del grupo + subgrupo
  console.log("‚û°Ô∏è Llamando a filtrarSubcategoria con:", { grupoCanon, subCanon });
  filtrarSubcategoria(grupoCanon, subCanon);

  // Logs extra para verificar DOM y estilos
  const cont = document.getElementById("productos");
  if (cont) {
    console.log("üì• Hijos actuales en #productos despu√©s de mostrarSubgrupo:", cont.children.length);
    console.log("üß© HTML actual de #productos:", cont.innerHTML.slice(0, 300) + "...");
    const style = window.getComputedStyle(cont);
    console.log("üëÅÔ∏è Estilo de #productos:", { display: style.display, visibility: style.visibility });
  }
}
window.mostrarSubgrupo = mostrarSubgrupo;

// Extra: log de clicks en botones de subgrupo
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("btn-subgrupo")) {
    console.log("üü¢ Click detectado en bot√≥n subgrupo:", e.target.textContent);
  }
});


function vaciarCarrito() {
  carrito = [];
  actualizarCarrito();
}

function actualizarPrecioEnCarrito(nombre, nuevoPrecio) {
  let cambio = false;
  carrito.forEach(item => {
    if (item.nombre === nombre && item.precio !== nuevoPrecio) {
      item.precio = nuevoPrecio;
      cambio = true;
    }
  });
  if (cambio) actualizarCarrito();
}

function sincronizarPreciosDelCarrito() {
  carrito.forEach(item => {
    const idPrecio = "precio_" + (item.id_base || item.nombre.replace(/ /g, "_"));
    const precioSpan = document.getElementById(idPrecio);
    if (precioSpan) {
      const precioActual = parseFloat(precioSpan.textContent);
      if (!isNaN(precioActual)) {
        item.precio = precioActual;
      }
    }
  });
}

function actualizarCarrito() {
  sincronizarPreciosDelCarrito();

  const lista = document.getElementById('listaCarrito');
  const total = document.getElementById('totalCarrito');
  const link = document.getElementById('enviarCarrito');
  if (!lista || !total) return;

  lista.innerHTML = '';
  let suma = 0;

  if (carrito.length === 0) {
    lista.innerHTML = "<li>üõí Carrito vac√≠o</li>";
    total.textContent = "0.00";
    if (link) link.href = configWhatsApp;
    return;
  }

  const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    suma += subtotal;

    lista.insertAdjacentHTML("beforeend", `
      <li style="display: flex; justify-content: space-between; align-items: center;">
        <span>${item.nombre}${item.talle ? ' (' + item.talle + ')' : ''} x ${item.cantidad} - $${fmt.format(subtotal)}</span>
        <button onclick="eliminarProducto('${item.id_base}', '${item.talle}', event)" 
                style="background: none; border: none; color: red; font-weight: bold; font-size: 16px; cursor: pointer;">
          ‚ùå
        </button>
      </li>`);
  });

  total.textContent = fmt.format(suma);

  const mensaje = encodeURIComponent(
    `Hola, quiero consultar por:\n` +
    carrito.map(i => `- ${i.nombre}${i.talle ? ' (' + i.talle + ')' : ''} x ${i.cantidad}: $${fmt.format(i.precio * i.cantidad)}`).join('\n') +
    `\nTotal estimado: $${fmt.format(suma)}`
  );

  if (link) {
    link.href = configWhatsApp + '?text=' + mensaje;
  }
}

function mostrarTodos() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');

  if (!panelGrupos || !panelSub) return;

  panelGrupos.classList.toggle('oculta');

  if (!panelSub.classList.contains('oculta')) {
    panelSub.classList.add('oculta');
  }
}
window.mostrarTodos = mostrarTodos; 
    
function irAContacto() {
  const contacto = document.getElementById('ubicacion');
  if (contacto) contacto.scrollIntoView({ behavior: 'auto' });
}
window.irAContacto = irAContacto; // si us√°s m√≥dulos
    
function renderProducto(p) {
  console.log("üõí renderProducto llamado con:", p);

  const card = document.createElement("div");
  card.className = "col-lg-4 col-md-6 col-sm-12 mb-4 fade-reorder";

  // Generar contenido de talles
  let tallesHTML = `
    <div class="mb-2">
      <label class="form-label mb-1" style="font-size: 14px;"><strong>Talle:</strong></label>
      <select id="talle_${p.id_base}" class="form-select form-select-sm w-auto d-inline-block">
        ${
          Array.isArray(p.talles) && p.talles.length
            ? p.talles.map(t => `<option value="${t}">${t}</option>`).join("")
            : `<option disabled selected>Sin talles disponibles</option>`
        }
      </select>
      ${window.modoAdmin ? `
        <button type="button" class="btn btn-sm btn-outline-primary ms-2"
          onclick="editarTalles('${p.id_base}')">‚úé Editar</button>` : ""}
    </div>
  `;

  card.innerHTML = `
    <div class="card p-3 h-100">
      <img src="${p.imagen_url || '/static/img/fallback.webp'}"
           alt="${p.nombre}" loading="lazy"
           style="width:300px;height:180px;object-fit:contain;border-radius:4px;">
      <div class="card-body">
        <h5 class="card-title">${p.nombre}</h5>
        <p class="card-text">${p.descripcion || ""}</p>
        <p>
          <strong>Precio:</strong> 
          $<span id="precio_${p.id_base}">${p.precio}</span>
          ${window.modoAdmin ? `
            <button type="button" class="btn btn-sm btn-outline-primary ms-2"
              onclick="editarPrecio('${p.id_base}')">‚úé Editar</button>` : ""}
        </p>
        ${tallesHTML}
        ${configWhatsApp ? `<a href="${configWhatsApp}" class="btn btn-whatsapp">Contactar por WhatsApp</a>` : ""}
        <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
          <label class="mb-0" style="font-size: 14px;">Cantidad:</label>
          <input type="number" min="1" max="100" value="1"
                 id="cantidad_${p.id_base}"
                 class="form-control form-control-sm" style="width: 70px;">
          <button type="button" class="btn btn-secondary"
            onclick="agregarAlCarritoDOM('${p.nombre}', 'precio_${p.id_base}', 'cantidad_${p.id_base}', '${p.id_base}', '${p.grupo}', '${p.subgrupo}')">
            Agregar al carrito
          </button>
        </div>
      </div>
    </div>
  `;

  // üîÅ Animaci√≥n
  requestAnimationFrame(() => card.classList.add("show"));
  setTimeout(() => card.classList.remove("fade-reorder"), 50);

  console.log("‚úÖ renderProducto devuelve card:", card);
  return card;
}
    
function ajustarPosicionesPaneles() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');
  const barraNav = document.querySelector('.barra-navegacion');

  if (!panelGrupos || !panelSub) {
    console.warn("‚ö†Ô∏è No existen paneles en el DOM");
    return;
  }

  console.log("üîß ajustando posiciones de paneles...");

  if (!panelGrupos.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    panelGrupos.style.top = alturaBarra + 'px';
    panelGrupos.style.position = 'fixed';
    panelGrupos.style.left = '0';
    panelGrupos.style.right = '0';
    console.log("üìê Panel grupos ‚Üí top:", panelGrupos.style.top, "alturaBarra:", alturaBarra);
  }

  if (!panelSub.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    const alturaGrupos = panelGrupos ? panelGrupos.offsetHeight : 0;
    const margenAdicional = 19;
    const desplazamientoArriba = -20;
    const topCalc = alturaBarra + alturaGrupos + margenAdicional + desplazamientoArriba;
    panelSub.style.top = topCalc + 'px';
    panelSub.style.position = 'fixed';
    panelSub.style.left = '0';
    panelSub.style.right = '0';
    console.log("üìê Panel subcategorias ‚Üí top:", panelSub.style.top, 
                "alturaBarra:", alturaBarra, "alturaGrupos:", alturaGrupos);
  } else {
    panelSub.style.top = '';
    console.log("üìÇ Panel subcategorias oculto");
  }

  // Extra: log de estilos calculados
  const styleGrupos = window.getComputedStyle(panelGrupos);
  const styleSub = window.getComputedStyle(panelSub);
  console.log("üëÅÔ∏è Estilo panelGrupos:", { display: styleGrupos.display, top: styleGrupos.top });
  console.log("üëÅÔ∏è Estilo panelSub:", { display: styleSub.display, top: styleSub.top });
}


document.addEventListener("DOMContentLoaded", () => {
  // Ajustar posiciones al cargar y al redimensionar
  window.addEventListener("load", ajustarPosicionesPaneles);
  window.addEventListener("resize", ajustarPosicionesPaneles);

  // Bot√≥n Productos
  const btnProductos = document.getElementById("btnProductos");
  if (btnProductos) {
    btnProductos.addEventListener("click", () => {
      const panelGrupos = document.getElementById("panelGrupos");
      if (panelGrupos) panelGrupos.classList.remove("oculta");

      // Ajustar posiciones despu√©s de mostrar
      setTimeout(ajustarPosicionesPaneles, 0);
    });
  }

  // Bot√≥n Subcategor√≠as
  const btnSubcategorias = document.getElementById("btnSubcategorias");
  if (btnSubcategorias) {
    btnSubcategorias.addEventListener("click", () => {
      const panelSub = document.getElementById("panelSubcategorias");
      if (panelSub) panelSub.classList.remove("oculta");

      // Ajustar posiciones despu√©s de mostrar
      setTimeout(ajustarPosicionesPaneles, 0);
    });
  }

  // Delegaci√≥n de eventos para botones de grupo din√°micos
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("btn-grupo")) {
      setTimeout(ajustarPosicionesPaneles, 0);
    }

    // ‚úÖ Cerrar carrito al hacer clic fuera
    const carritoDiv = document.getElementById("carrito");
    const toggleBtn = document.getElementById("toggleCarrito");
    if (carritoDiv && toggleBtn) {
      const visible = carritoDiv.style.display === "block";
      const clicFueraCarrito = !carritoDiv.contains(e.target) && !toggleBtn.contains(e.target);
      if (visible && clicFueraCarrito) {
        carritoDiv.style.display = "none";
      }
    }

    // ‚úÖ Ocultar paneles al hacer clic fuera
    const panelGrupos = document.getElementById("panelGrupos");
    const panelSub = document.getElementById("panelSubcategorias");
    if (panelGrupos && panelSub) {
      const esClickDentroGrupos = panelGrupos.contains(e.target);
      const esClickDentroSub = panelSub.contains(e.target);
      const esBotonGrupo = e.target.classList.contains("btn-grupo");
      const esBotonNavegacion = !!e.target.closest(".barra-navegacion");

      if (!esClickDentroGrupos && !esClickDentroSub && !esBotonGrupo && !esBotonNavegacion) {
        panelGrupos.classList.add("oculta");
        panelSub.classList.add("oculta");
      }
    }
  });

  // üëâ Ordenar por precio
  const ordenSelect = document.getElementById("ordenPrecio");
  if (ordenSelect) {
    ordenSelect.addEventListener("change", (e) => {
      const valor = e.target.value; // "asc" o "desc"
      console.log("üîÑ Evento change en ordenPrecio, valor seleccionado:", valor);

      const grupoActivoBtn = document.querySelector(".btn-grupo.active");
      const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;
      console.log("üéØ Grupo activo detectado:", grupoActivo);

      const subActivoBtn = document.querySelector(".btn-subgrupo.active");
      const subActivo = subActivoBtn ? subActivoBtn.textContent.trim() : null;
      console.log("üéØ Subgrupo activo detectado:", subActivo);

      let productosFiltrados = window.todosLosProductos;
      console.log("üì¶ Total productos en memoria:", productosFiltrados.length);

      if (grupoActivo) {
        productosFiltrados = productosFiltrados.filter(
          p => p.grupo?.toLowerCase() === grupoActivo.toLowerCase()
        );
        console.log("üì¶ Productos filtrados por grupo:", productosFiltrados.length, productosFiltrados);
      }
      if (subActivo) {
        productosFiltrados = productosFiltrados.filter(
          p => p.subgrupo?.toLowerCase() === subActivo.toLowerCase()
        );
        console.log("üì¶ Productos filtrados por subgrupo:", productosFiltrados.length, productosFiltrados);
      }

      productosFiltrados.sort((a, b) => {
        const pa = parseFloat(a.precio) || 0;
        const pb = parseFloat(b.precio) || 0;
        return valor === "asc" ? pa - pb : pb - pa;
      });
      console.log("üìä Productos ordenados por precio:", valor, productosFiltrados);

      const cont = document.getElementById("productos");
      if (!cont) {
        console.warn("‚ö†Ô∏è No existe #productos en el DOM");
        return;
      }

      cont.innerHTML = "";
      console.log("üßπ Contenedor #productos limpiado");

      // üîë Usar tu funci√≥n original de renderizado
      productosFiltrados.forEach((p, idx) => {
        console.log(`‚û°Ô∏è Renderizando producto #${idx + 1}:`, p);
        const card = renderProducto(p); // üëà esta funci√≥n debe devolver la card completa
        cont.appendChild(card);
        console.log("üõí Card insertada en #productos:", p.nombre);
        console.log("üì• Hijos actuales en #productos:", cont.children.length);
        console.log("üß© HTML parcial de la card:", card.innerHTML.slice(0, 200) + "...");
        setTimeout(() => {
          card.classList.remove("fade-reorder");
          console.log("‚ú® Animaci√≥n aplicada a card:", p.nombre);
        }, 50);
      });

      console.log("‚úÖ Renderizado completo en ordenPrecio, hijos finales en #productos:", cont.children.length);

      const style = window.getComputedStyle(cont);
      console.log("üëÅÔ∏è Estilo de #productos:", { display: style.display, visibility: style.visibility });
    });
  }
});

// üëâ Nueva funci√≥n ordenarGrupo
function ordenarGrupo(valor) {
  console.log("üîÑ ordenarGrupo llamada con:", valor);

  const cont = document.getElementById("productos");
  if (!cont) return;

  const grupoCanon = window.currentGrupo;
  const subCanon = window.currentSub;

  let productosFiltrados = window.todosLosProductos.filter(p =>
    String(p.grupo || "").toLowerCase() === grupoCanon.toLowerCase() &&
    String(p.subgrupo || "").toLowerCase() === subCanon.toLowerCase()
  );

  productosFiltrados.sort((a, b) => {
    const pa = Number(a.precio) || 0;
    const pb = Number(b.precio) || 0;
    return valor === "asc" ? pa - pb : pb - pa;
  });
  console.log("üìä Productos ordenados:", valor, productosFiltrados);

  cont.innerHTML = "";

  const grupoDiv = document.createElement("div");
  grupoDiv.className = "grupo-section";
  grupoDiv.innerHTML = `<h3>${grupoCanon}</h3>`;

  const subDiv = document.createElement("div");
  subDiv.className = "subgrupo-bloque";
  subDiv.innerHTML = `<h4>${subCanon}</h4>`;

  productosFiltrados.forEach(p => {
    const card = renderProducto(p);
    subDiv.appendChild(card);

    requestAnimationFrame(() => card.classList.add("show"));
    setTimeout(() => card.classList.remove("fade-reorder"), 50);

    console.log("üõí Card insertada en subgrupo:", p.nombre);
  });

  grupoDiv.appendChild(subDiv);
  cont.appendChild(grupoDiv);
  console.log("‚úÖ Bloque renderizado en ordenarGrupo, hijos finales:", cont.children.length);
}

window.ordenarGrupo = ordenarGrupo;




// Bot√≥n Productos (SOLO cierra los paneles)
const btnProductos = document.getElementById('btnProductos');
if (btnProductos) {
  btnProductos.addEventListener('click', (e) => {
    e.stopPropagation(); // Evita conflictos con otros clicks

    // Solo ocultamos los paneles
    document.getElementById('panelGrupos').classList.add('oculta');
    document.getElementById('panelSubcategorias').classList.add('oculta');
    
    // Eliminamos mostrarTodos() y scrollTo() para no alterar la vista
  });
}

   
</script>
<script type="module">
const usarFirestore = {{ 'true' if config.usarFirestore else 'false' }};
const email = "{{ session.get('email') or '' }}";

setTimeout(() => {
  if (!window.todosLosProductos || window.todosLosProductos.length === 0) return;

  const primerGrupo = [...new Set(window.todosLosProductos.map(p => p.grupo))][0];
  if (!primerGrupo) return;

  const primerGrupoId = primerGrupo.trim().toLowerCase().replace(/\s+/g, '_');
  const primerGrupoDiv = document.getElementById('grupo_' + primerGrupoId);
  if (primerGrupoDiv) primerGrupoDiv.classList.add('active');

  const subgrupos = [...new Set(window.todosLosProductos
    .filter(p => p.grupo === primerGrupo)
    .map(p => p.subgrupo))];

  // Normalizar: si no hay subgrupo, usar General_{grupo}
  let primerSubgrupoNombre = subgrupos[0]?.trim();
  if (!primerSubgrupoNombre) {
    primerSubgrupoNombre = `General_${primerGrupo}`;
  }

  if (primerGrupoId && primerSubgrupoNombre) {
    filtrarSubcategoria(primerGrupo, primerSubgrupoNombre);
  }
}, 100);

   
</script>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
  const PUBLIC_KEY = "{{ config.public_key or '' }}";
  let mp = null;

  if (PUBLIC_KEY) {
    mp = new MercadoPago(PUBLIC_KEY, { locale: 'es-AR' });
  }

  const pagarBtn = document.getElementById('btn_pagar');
  if (pagarBtn && !PUBLIC_KEY) {
    pagarBtn.disabled = true;
  }

  console.log("PUBLIC_KEY:", PUBLIC_KEY);
</script>
<script>
  // Si Flask inyecta modoAdmin, √∫salo. Si no, fuerza false.
  window.modoAdmin = {{ modoAdmin|default(false)|tojson }};
</script> 
</body>
</html>
