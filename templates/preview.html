
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vista previa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Vista previa para redes sociales -->
  <meta property="og:title" content="{{ config.titulo }}">
  <meta property="og:description" content="{{ config.descripcion }}">
  <meta property="og:image" content="{{ config.imagen_destacada }}">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="{{ config.url }}">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Google Fonts disponibles -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Playfair+Display&family=Fira+Code&family=Raleway&family=Quicksand&family=Pacifico&family=Source+Serif+4&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  {% set estilo = config.estilo_visual.lower() %}
  {% if 'claro' in estilo or 'esferas' in estilo or 'blanco' in estilo %}
    {% set modo_visual = 'modo-claro' %}
  {% else %}
    {% set modo_visual = 'modo-oscuro' %}
  {% endif %}

  <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos.css') }}">

</head>
<body class="container py-5 {{ modo_visual }}">
  <div class="barra-wrapper">
    <nav class="barra-navegacion">
      <button id="btnProductos" onclick="mostrarTodos()">Productos</button>
      <button id="btnContacto" onclick="irAContacto()">Contacto</button>
    </nav>
    <div id="panelGrupos" class="panel-grupos oculto">
      {% for grupo in grupos.keys() %}
        <button class="btn-grupo" onclick="mostrarGrupo('{{ grupo }}', event)">
          {{ grupo }}
        </button>
      {% endfor %}
    </div>
  </div>

  <div id="panelSubcategorias" class="panel-subcategorias oculto"></div>

  <button id="volverArriba" class="btn btn-volver-arriba" style="position: fixed; bottom: 20px; left: 20px; display: none; z-index: 1000;">
    ‚Üë
  </button>

  {% if config.logo %}
    <img src="{{ url_for('static', filename='img/' + config.logo) }}"
         alt="Logo"
         class="img-fluid logo">
  {% endif %}

  {% if modoAdminIntentado and not modoAdmin %}
    <div id="login-admin" class="container mt-4">
      <h3 class="text-center">üîê Ingres√° tu clave de administrador</h3>
      <form id="form-login-admin" class="text-center">
        <input type="text" id="usuario_login" placeholder="Usuario" required>
        <input type="password" id="clave_login" placeholder="Contrase√±a" required>
        <button type="submit" style="margin-top: 10px;">Entrar</button> <!-- ‚úÖ Este es el que faltaba -->
      </form>
    </div>
  {% endif %}

  {% if modoAdmin %}
    <div class="text-center mt-3">
      <a href="/logout-admin" class="btn btn-sm btn-outline-light">üîì Salir del modo administrador</a>
    </div>
  {% endif %}

  <div class="text-center my-4">
    <select id="ordenPrecio" class="form-select w-auto d-inline-block">
      <option value="asc">Precio: Menor a mayor</option>
      <option value="desc">Precio: Mayor a menor</option>
    </select>
  </div>


  {% if config.sobre_mi %}
    <div class="text-center mb-4">
      <div class="descripcion-emprendimiento">
        {{ config.sobre_mi | replace('\n', '<br>') | safe }}
      </div>
    </div>
  {% endif %}

{% include "partials/productos.html" %}

  <div id="contenedor-grupos"></div>

  <div class="text-center mt-5">
    <a href="/descargar" class="btn btn-primary px-5">
      Descargar sitio
    </a>
  </div>

  <div class="social-icons">
    {% if config.facebook %}
      <a href="{{ config.facebook }}" target="_blank">
        <img src="/static/img/facebook.png" alt="Facebook">
      </a>
    {% endif %}
    {% if config.instagram %}
      <a href="{{ config.instagram }}" target="_blank">
        <img src="/static/img/instagram.png" alt="Instagram">
      </a>
    {% endif %}
    {% if config.whatsapp %}
      <a href="{{ config.whatsapp }}" target="_blank">
        <img src="/static/img/whatsapp.png" alt="WhatsApp">
      </a>
    {% endif %}
  </div>

  {% if config.ubicacion %}
    <div id="ubicacion" class="bloque-ubicacion text-center mt-4">
      <p style="margin-bottom: 6px;">
        üìç {{ config.ubicacion }}
      </p>
      {% if config.link_mapa %}
        <a href="{{ config.link_mapa }}" target="_blank" style="text-decoration: none;">
          <span style="margin-right: 6px;">‚ûú</span>
          <img src="/static/img/map.png" alt="Ver en Google Maps" style="width: 30px;">
        </a>
      {% endif %}
    </div>
  {% endif %}

  <button id="toggleCarrito">üõí</button>

  <div id="carrito">
    <h5>üõí Tu carrito</h5>
    <ul id="listaCarrito"></ul>
    <p><strong>Total:</strong> $<span id="totalCarrito">0</span></p>
    <div class="d-grid gap-2">
  <button class="btn btn-sm btn-danger" onclick="vaciarCarrito()">Vaciar carrito</button>

  {% if config.mercado_pago %}
    <button class="btn btn-sm btn-primary" onclick="pagarConMercadoPago()">Pagar con Mercado Pago</button>
  {% else %}
    <a id="enviarCarrito" class="btn btn-sm btn-success" target="_blank">Enviar por WhatsApp</a>
  {% endif %}
</div>

  </div>
<!-- Aviso flotante de precio actualizado -->
<div id="avisoPrecio" class="alert alert-success text-center" role="alert"
     style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Precio actualizado
</div>

  <script>
    const configWhatsApp = "{{ config.whatsapp }}";

    window.addEventListener('scroll', () => {
      const btn = document.getElementById('volverArriba');
      btn.style.display = window.scrollY > 300 ? 'block' : 'none';
      btn.style.backgroundColor = 'white';
      btn.style.color = 'black';
    });
    const subcategoriasPorGrupo = {
      {% for grupo, subgrupos in grupos.items() %}
        "{{ grupo }}": [{% for sub in subgrupos.keys() %}"{{ sub }}"{% if not loop.last %}, {% endif %}{% endfor %}],
      {% endfor %}
    };

    document.getElementById('volverArriba').onclick = () => {
      window.scrollTo({ top: 0, behavior: 'auto' }); // Cambiado a 'auto' para evitar deslizamiento
    };
    
    function mostrarGrupo(nombre, event, auto = false) {
  console.log("üß™ Grupo seleccionado:", nombre, "auto:", auto);

  const grupoId = 'grupo_' + nombre.toLowerCase().replace(/\s+/g, '_');
  const grupoActivo = document.getElementById(grupoId);
  document.querySelectorAll('.grupo-section').forEach(div => div.classList.remove('active', 'initial-load'));
  if (grupoActivo) {
    grupoActivo.classList.add('active');
    if (auto) grupoActivo.classList.add('initial-load');
  }

  document.querySelectorAll('.btn-grupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) event.target.classList.add('active');

  const subcategorias = subcategoriasPorGrupo[nombre] || [];
  const panel = document.getElementById('panelSubcategorias');
  panel.innerHTML = '';

  const bloques = grupoActivo?.querySelectorAll('.subgrupo-bloque');
  console.log("üîç Bloques encontrados:", bloques?.length || 0);

  subcategorias.forEach(sub => {
    if (!sub || sub.trim().toLowerCase() === 'general') return;
    const btn = document.createElement('button');
    btn.textContent = sub;
    btn.className = 'btn-grupo';
    btn.onclick = () => filtrarSubcategoria(nombre, sub);
    panel.appendChild(btn);
    console.log("üß± Bot√≥n creado para subcategor√≠a:", sub);
  });

  if (!auto) {
    panel.classList.remove('oculta');
    bloques?.forEach((bloque, i) => {
      bloque.style.display = 'block';
      console.log(`üîÑ Mostrando bloque ${i}:`, bloque.dataset.subgrupo);
    });

    if (subcategorias.length > 0) {
      console.log("üéØ Aplicando filtro por primera subcategor√≠a:", subcategorias[0]);
      filtrarSubcategoria(nombre, subcategorias[0]);
    }
  } else {
    panel.classList.add('oculta');
    if (subcategorias.length > 0) {
      console.log("üéØ Auto-carga: filtrando por subcategor√≠a inicial:", subcategorias[0]);
      filtrarSubcategoria(nombre, subcategorias[0]);
    }
  }
}

   function filtrarSubcategoria(grupo, subgrupo) {
  console.log("üéØ Filtrando grupo:", grupo, "por subgrupo:", subgrupo);

  const grupoId = 'grupo_' + grupo.toLowerCase().replace(/\s+/g, '_');
  const grupoDiv = document.getElementById(grupoId);
  if (!grupoDiv) {
    console.warn("‚ö†Ô∏è Grupo no encontrado:", grupoId);
    return;
  }

  const bloques = grupoDiv.querySelectorAll('.subgrupo-bloque');
  console.log("üîç Bloques en grupo:", bloques.length);

  bloques.forEach((bloque, i) => {
    const subgrupoActual = bloque.dataset.subgrupo?.trim() || '';
    const mostrar = subgrupoActual.toLowerCase() === subgrupo.trim().toLowerCase();
    bloque.style.display = mostrar ? 'block' : 'none';

    console.log(`üîé Bloque ${i}: subgrupo=${subgrupoActual}, mostrar=${mostrar}`);
  });

  window.scrollTo({ top: 0, behavior: 'auto' });
}

    window.onload = function() {
  const panelSubcategorias = document.getElementById('panelSubcategorias');
  const panelGrupos = document.getElementById('panelGrupos');
  panelSubcategorias.classList.add('oculta');
  panelGrupos.classList.add('oculta');

  const primerGrupo = Object.keys(subcategoriasPorGrupo)[0];
  const primerSub = subcategoriasPorGrupo[primerGrupo]?.find(s => s.toLowerCase() !== 'general') || '';

  if (primerGrupo && primerSub) {
    mostrarGrupo(primerGrupo, null, true);
    filtrarSubcategoria(primerGrupo, primerSub);
  }

  document.getElementById('toggleCarrito').onclick = function() {
    const carritoDiv = document.getElementById('carrito');
    carritoDiv.style.display = carritoDiv.style.display === 'none' ? 'block' : 'none';
  };
};

    let carrito = [];

   function agregarAlCarritoDOM(nombre, idPrecioSpan, idCantidad, id_base) {
  const cantidadInput = document.getElementById(idCantidad); 
  const precioSpan = document.getElementById(idPrecioSpan);
  const talleSelect = document.getElementById("talle_" + id_base);

  const cantidad = parseInt(cantidadInput?.value) || 1; 
  const precio = parseFloat(precioSpan?.textContent?.trim()) || 0;
  const talleElegido = talleSelect?.value || "";

  console.log("üõí Intentando agregar al carrito:", {
    nombre,
    precio,
    cantidad,
    talle: talleElegido,
    id_base
  });

  const existente = carrito.find(item => item.id_base === id_base && item.talle === talleElegido);
  if (existente) {
    existente.cantidad += cantidad;
    console.log("üîÅ Producto ya en carrito, sumando cantidad:", existente);
  } else {
    const nuevoItem = { nombre, precio, cantidad, id_base, talle: talleElegido };
    carrito.push(nuevoItem);
    console.log("‚úÖ Producto agregado al carrito:", nuevoItem);
  }

  actualizarCarrito();
}

function editarPrecio(id) {
  const span = document.getElementById("precio_" + id);
  if (!span) {
    console.warn("‚ùå No se encontr√≥ el span con id:", "precio_" + id);
    return;
  }

  const valorActual = span.textContent.replace("$", "").trim();
  console.log("üß™ Editando precio para:", id, "| Valor actual:", valorActual);

  const input = document.createElement("input");
  input.type = "number";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "80px";
  input.id = "input_precio_" + id;  // ‚úÖ ID √∫nico para el input

  // ‚úÖ Guardar al salir del input
  input.onblur = () => {
    console.log("üì§ onblur: guardando precio para", id, "con valor:", input.value);
    guardarPrecio(id);
  };

  // ‚úÖ Guardar al presionar Enter
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      console.log("‚èé Enter presionado: guardando precio para", id, "con valor:", input.value);
      input.blur(); // dispara onblur
    }
  });

  span.replaceWith(input);
  input.focus();
}
  
function guardarPrecio(id) {
  console.log("üü° Iniciando guardarPrecio para:", id);

  const input = document.getElementById("input_precio_" + id);
  if (!input) {
    console.warn("‚ùå No se encontr√≥ el input con id:", "input_precio_" + id);
    return;
  }

  const nuevoValor = parseFloat(input.value);
  console.log("üîç Valor ingresado:", input.value, "| Parseado:", nuevoValor);

  if (isNaN(nuevoValor)) {
    console.warn("‚ö†Ô∏è Valor ingresado no es un n√∫mero v√°lido:", input.value);
    alert("‚ùå El precio ingresado no es v√°lido");
    return;
  }

  console.log("üß™ Precio validado para", id, "‚Üí", nuevoValor);

  // ‚úÖ Enviar al backend antes de modificar el DOM
  console.log("üì° Enviando fetch a /actualizar-precio con:", { id, nuevoPrecio: nuevoValor });

  fetch('/actualizar-precio', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, nuevoPrecio: nuevoValor })
  })
    .then(res => {
      console.log("üì¨ Respuesta recibida del backend:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("üì® Payload recibido:", data);
      if (data.status === "ok") {
        console.log("‚úÖ Precio confirmado en Firestore para", id);

        // ‚úÖ Actualizar el DOM solo si el backend responde OK
        const span = document.createElement("span");
        span.id = "precio_" + id;
        span.textContent = "$" + nuevoValor.toFixed(2);
        span.className = input.className;  // hereda estilos del input
        span.classList.add("text-success");  // feedback visual
        input.replaceWith(span);
        setTimeout(() => span.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoPrecio === "function") {
          console.log("üîî Ejecutando mostrarAvisoPrecio()");
          mostrarAvisoPrecio();
        }
      } else {
        console.warn("‚ùå Error en respuesta del backend:", data);
        input.classList.add("is-invalid");
        alert("‚ùå No se pudo actualizar el precio en el servidor");
      }
    })
    .catch(err => {
      console.error("‚ùå Error de red al actualizar precio:", err);
      input.classList.add("is-invalid");
      alert("‚ùå Error de conexi√≥n al guardar el precio");
    });
}

function loginAdmin(event) {
  event.preventDefault();
  const usuario = document.getElementById("usuario_login").value.trim();
  const clave = document.getElementById("clave_login").value.trim();

  fetch("/login-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert("‚úÖ Acceso concedido");
        location.href = window.location.href;
      } else {
        alert("‚ùå " + data.message);
      }
    })
    .catch(err => {
      console.error("‚ùå Error en login:", err);
      alert("‚ùå Error al intentar login");
    });
}

// Detectar env√≠o autom√°tico del formulario
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("form-login-admin");
  if (form) {
    form.addEventListener("submit", loginAdmin);
  }
});
    
function editarTalles(id) {
  const selector = document.getElementById("talle_" + id);
  const span = document.getElementById("talles_" + id);

  let tallesActuales = "";

  if (selector) {
    tallesActuales = Array.from(selector.options).map(opt => opt.value).join(", ");
  } else if (span) {
    tallesActuales = span.textContent;
  } else {
    console.warn("‚ùå No se encontr√≥ selector ni span para:", id);
    return;
  }

  const nuevoTalle = prompt("Modificar talles (separados por coma):", tallesActuales);
  if (nuevoTalle === null) return;

  const tallesArray = nuevoTalle.split(',').map(t => t.trim()).filter(t => t);
  console.log("‚úÖ Nuevos talles ingresados:", tallesArray);

  // ‚úÖ Enviar al backend antes de modificar el DOM
  fetch('/actualizar-talles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: id, talles: tallesArray })
  })
    .then(res => res.json())
    .then(data => {
      console.log("üì® Payload recibido:", data);
      if (data.status === "ok") {
        console.log("‚úÖ Talles confirmados en Firestore para", id);

        // ‚úÖ Actualizar visualmente solo si el backend responde OK
        const nuevoSelect = document.createElement("select");
        nuevoSelect.id = "talle_" + id;
        nuevoSelect.className = "form-select form-select-sm w-auto d-inline-block";
        tallesArray.forEach(t => {
          const option = document.createElement("option");
          option.value = t;
          option.textContent = t;
          nuevoSelect.appendChild(option);
        });

        if (selector) {
          selector.replaceWith(nuevoSelect);
        } else if (span) {
          const nuevoSpan = document.createElement("span");
          nuevoSpan.id = "talles_" + id;
          nuevoSpan.textContent = tallesArray.join(', ');
          span.replaceWith(nuevoSpan);
        }

        // ‚úÖ Feedback visual
        nuevoSelect.classList.add("text-success");
        setTimeout(() => nuevoSelect.classList.remove("text-success"), 1000);
      } else {
        console.warn("‚ùå Error en respuesta del backend:", data);
        alert("‚ùå No se pudo actualizar los talles");
      }
    })
    .catch(err => {
      console.error("‚ùå Error en fetch al actualizar talles:", err);
      alert("‚ùå Error de conexi√≥n al guardar los talles");
    });
}
 
function guardarTalles(id) {
  console.log("üü° Iniciando guardarTalles para:", id);

  const input = document.getElementById("talles_" + id);
  if (!input) {
    console.warn("‚ùå No se encontr√≥ el input con id:", "talles_" + id);
    return;
  }

  const nuevosTalles = input.value
    .split(",")
    .map(t => t.trim())
    .filter(t => t);

  console.log("üß™ Talles capturados para", id, "‚Üí", nuevosTalles);

  // ‚úÖ Enviar al backend antes de modificar el DOM
  console.log("üì° Enviando fetch a /actualizar-talles con:", { id_base: id, nuevoTalles: nuevosTalles.join(',') });

  fetch('/actualizar-talles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id_base: id, nuevoTalles: nuevosTalles.join(',') })
  })
    .then(res => {
      console.log("üì¨ Respuesta recibida del backend:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("üì® Payload recibido:", data);
      if (data.status === "ok") {
        console.log("‚úÖ Talles confirmados en Firestore para", id);

        // ‚úÖ Actualizar el DOM solo si el backend responde OK
        const nuevoSpan = document.createElement("span");
        nuevoSpan.id = "talles_" + id;
        nuevoSpan.textContent = nuevosTalles.join(", ");
        nuevoSpan.className = input.className;
        nuevoSpan.classList.add("text-success");
        input.replaceWith(nuevoSpan);
        setTimeout(() => nuevoSpan.classList.remove("text-success"), 1000);
      } else {
        console.warn("‚ùå Error en respuesta del backend:", data);
        input.classList.add("is-invalid");
        alert("‚ùå No se pudo actualizar los talles");
      }
    })
    .catch(err => {
      console.error("‚ùå Error de red al actualizar talles:", err);
      input.classList.add("is-invalid");
      alert("‚ùå Error de conexi√≥n al guardar los talles");
    });
}

function actualizarFirestore(id, datos) {
  if (!id || typeof datos !== "object" || Object.keys(datos).length === 0) {
    console.warn("‚ö†Ô∏è Datos incompletos para actualizar Firestore:", { id, datos });
    return;
  }

  console.log("üì° Enviando actualizaci√≥n a Firestore para", id, "‚Üí", datos);

  fetch("/actualizar-firestore", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, ...datos })
  })
    .then(res => {
      console.log("üì¨ Respuesta recibida del backend:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("üì® Payload recibido:", data);
      if (data.status === "ok") {
        console.log("‚úÖ Firestore actualizado para", id);
        if (typeof mostrarAvisoFirestore === "function") {
          console.log("üîî Ejecutando mostrarAvisoFirestore()");
          mostrarAvisoFirestore();
        }
      } else {
        console.warn("‚ùå Error en respuesta del backend:", data);
        alert("‚ùå No se pudo actualizar Firestore");
      }
    })
    .catch(err => {
      console.error("‚ùå Error de red al actualizar Firestore:", err);
      alert("‚ùå Error de conexi√≥n al guardar los datos");
    });
}

function mostrarAvisoPrecio() {
  const aviso = document.getElementById("avisoPrecio");
  aviso.style.display = "block";
  setTimeout(() => {
    aviso.style.display = "none";
  }, 2000);
}

function pagarConMercadoPago() {
  fetch('/pagar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ carrito })
  })
  .then(res => res.json())
  .then(data => {
    if (data.init_point) {
      window.location.href = data.init_point;
    } else {
      alert("Error al generar pago");
    }
  });
}

function eliminarProducto(id_base, talle, event) {
  event.stopPropagation(); // üëà evita que el clic cierre el carrito
  carrito = carrito.filter(p => !(p.id_base === id_base && p.talle === talle));
  actualizarCarrito();
}


    function vaciarCarrito() {
      carrito = [];
      actualizarCarrito();
    }
    function actualizarPrecioEnCarrito(nombre, nuevoPrecio) {
  let cambio = false;
  carrito.forEach(item => {
    if (item.nombre === nombre && item.precio !== nuevoPrecio) {
      console.log(`üîÑ Actualizando precio en carrito para ${nombre}: ${item.precio} ‚Üí ${nuevoPrecio}`);
      item.precio = nuevoPrecio;
      cambio = true;
    }
  });
  if (cambio) actualizarCarrito();
}

function sincronizarPreciosDelCarrito() {
  carrito.forEach(item => {
    const idPrecio = "precio_" + (item.id_base || item.nombre.replace(/ /g, "_"));
    const precioSpan = document.getElementById(idPrecio);
    if (precioSpan) {
      const precioActual = parseFloat(precioSpan.textContent.replace("$", ""));
      if (!isNaN(precioActual)) {
        item.precio = precioActual;
      } else {
        console.warn("‚ö†Ô∏è Precio no num√©rico en DOM para", idPrecio);
      }
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ el span de precio para", idPrecio);
    }
  });
}

function actualizarCarrito() {
  sincronizarPreciosDelCarrito();

  const lista = document.getElementById('listaCarrito');
  const total = document.getElementById('totalCarrito');
  if (!lista || !total) {
    console.warn("‚ö†Ô∏è No se encontr√≥ listaCarrito o totalCarrito en el DOM");
    return;
  }

  lista.innerHTML = '';
  let suma = 0;

  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    suma += subtotal;

    lista.innerHTML += `
      <li style="display: flex; justify-content: space-between; align-items: center;">
        <span>${item.nombre}${item.talle ? ' (' + item.talle + ')' : ''} x ${item.cantidad} - $${subtotal.toFixed(2)}</span>
        <button onclick="eliminarProducto('${item.id_base}', '${item.talle}', event)" 
                style="background: none; border: none; color: red; font-weight: bold; font-size: 16px; cursor: pointer;">
          ‚ùå
        </button>
      </li>`;
  });

  total.textContent = suma.toFixed(2);

  const mensaje = encodeURIComponent(
    `Hola, quiero consultar por:\n` +
    carrito.map(i => `- ${i.nombre}${i.talle ? ' (' + i.talle + ')' : ''} x ${i.cantidad}: $${(i.precio * i.cantidad).toFixed(2)}`).join('\n') +
    `\nTotal estimado: $${suma.toFixed(2)}`
  );

  const link = document.getElementById('enviarCarrito');
  if (link) {
    link.href = configWhatsApp + '?text=' + mensaje;
  } else {
    console.warn("‚ö†Ô∏è No se encontr√≥ el bot√≥n 'enviarCarrito' para actualizar el link de WhatsApp");
  }

  console.log("üõí Carrito actualizado:", carrito);
}


    function mostrarTodos() {
      const panelGrupos = document.getElementById('panelGrupos');
      const panelSub = document.getElementById('panelSubcategorias');

      panelGrupos.classList.toggle('oculta');

      if (!panelSub.classList.contains('oculta')) {
        panelSub.classList.add('oculta');
      }
    }
    function irAContacto() {
      const contacto = document.getElementById('ubicacion');
      if (contacto) contacto.scrollIntoView({ behavior: 'auto' }); // Cambiado a 'auto'
    }
    function ajustarPosicionesPaneles() {
      const panelGrupos = document.getElementById('panelGrupos');
      const panelSub = document.getElementById('panelSubcategorias');
      const barraNav = document.querySelector('.barra-navegacion');

      if (!panelGrupos.classList.contains('oculta')) {
        const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
        const alturaGrupos = panelGrupos ? panelGrupos.offsetHeight : 0;
        panelGrupos.style.top = alturaBarra + 'px';
        panelGrupos.style.position = 'fixed';
        panelGrupos.style.left = '0';
        panelGrupos.style.right = '0';
      }
      if (!panelSub.classList.contains('oculta')) {
        const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
        const alturaGrupos = panelGrupos ? panelGrupos.offsetHeight : 0;
        const margenAdicional = 19; // Margen para evitar superposiciones
        const desplazamientoArriba = -20; // Ajuste para subir un poco si lo necesitas
        panelSub.style.top = (alturaBarra + alturaGrupos + margenAdicional + desplazamientoArriba) + 'px';
        panelSub.style.position = 'fixed';
        panelSub.style.left = '0';
        panelSub.style.right = '0';
      } else {
        panelSub.style.top = '100%';
      }
    }
    // Recalcular posiciones al cargar y al cambiar el tama√±o de la ventana
    window.addEventListener('load', ajustarPosicionesPaneles);
    window.addEventListener('resize', ajustarPosicionesPaneles);
    // Recalcular posiciones cuando se muestra un panel
    document.getElementById('btnProductos').addEventListener('click', function() {
      setTimeout(ajustarPosicionesPaneles, 0); // Ajuste despu√©s de que el DOM se actualice
    });
    document.querySelectorAll('.btn-grupo').forEach(btn => {
      btn.addEventListener('click', function() {
        setTimeout(ajustarPosicionesPaneles, 0); // Ajuste despu√©s de mostrar subcategor√≠as
      });
    });
  </script>
  <script type="module">
  const usarFirestore = {{ 'true' if config.usarFirestore else 'false' }};
  const modoAdmin = {{ 'true' if modoAdmin else 'false' }};

  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "{{ firebase_config.apiKey }}",
    authDomain: "{{ firebase_config.authDomain }}",
    projectId: "{{ firebase_config.projectId }}",
    storageBucket: "{{ firebase_config.storageBucket }}",
    messagingSenderId: "{{ firebase_config.messagingSenderId }}",
    appId: "{{ firebase_config.appId }}"
  };
    
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
    
    function renderizarProductos(grupos) {
  const contenedorPrincipal = document.getElementById("contenedor-grupos");
  contenedorPrincipal.innerHTML = "";

  Object.entries(grupos).forEach(([grupo, subgrupos]) => {
    const grupoId = 'grupo_' + grupo.trim().toLowerCase().replace(/\s+/g, '_'); // üëà blindado
    const grupoDiv = document.createElement("div");
    grupoDiv.className = "container mb-5 grupo-section";
    grupoDiv.id = grupoId;

    Object.entries(subgrupos).forEach(([subgrupo, productos]) => {
      if (!productos || productos.length === 0) return;

      const subgrupoId = subgrupo.trim().toLowerCase(); // üëà blindado
      const subgrupoDiv = document.createElement("div");
      subgrupoDiv.className = "subgrupo-bloque mb-4 bloque-producto";
      subgrupoDiv.dataset.subgrupo = subgrupoId;
      subgrupoDiv.dataset.grupo = grupo.trim().toLowerCase().replace(/\s+/g, '_');

      const fila = document.createElement("div");
      fila.className = "row";

      const orden = document.getElementById("ordenPrecio")?.value || "asc";
      productos.sort((a, b) => {
        const pa = parseFloat(a.precio) || 0;
        const pb = parseFloat(b.precio) || 0;
        return orden === "asc" ? pa - pb : pb - pa;
      });

      productos.forEach((producto, i) => {
        const idBase = producto.id_base;
        const tarjeta = document.createElement("div");
        tarjeta.className = "col-lg-4 col-md-6 col-sm-12 mb-4";
        tarjeta.innerHTML = `
          <div class="card p-3 h-100">
            <img src="/static/img/${producto.imagen}" class="card-img-top" alt="${producto.nombre}" loading="lazy">
            <div class="card-body">
              <h5 class="card-title">${producto.nombre}</h5>
              <p class="card-text">${producto.descripcion || ""}</p>
              <p><strong>Precio:</strong> $ 
                <span id="precio_${idBase}">${producto.precio}</span>
                ${modoAdmin ? `<button onclick="editarPrecio('${idBase}')" class="btn btn-sm btn-outline-secondary ms-2">üñâ</button>` : ''}
              </p>
              <div class="mb-2">
                <label for="talle_${idBase}" class="form-label mb-1" style="font-size: 14px;"><strong>Talle:</strong></label>
                ${producto.talles?.length ? `
                  <select id="talle_${idBase}" class="form-select form-select-sm w-auto d-inline-block">
                    ${producto.talles.map(t => `<option value="${t}">${t}</option>`).join('')}
                  </select>
                ` : `
                  <span id="talles_${idBase}">Sin talles disponibles</span>
                `}
                ${modoAdmin ? `<button onclick="editarTalles('${idBase}')" class="btn btn-sm btn-outline-secondary ms-2">üñâ</button>` : ''}
              </div>
              <a href="${configWhatsApp}" class="btn btn-whatsapp">Contactar por WhatsApp</a>
              <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
                <label for="cantidad_${idBase}" class="mb-0" style="font-size: 14px;">Cantidad:</label>
                <input type="number" min="1" max="100" value="1" class="form-control form-control-sm" style="width: 70px;" id="cantidad_${idBase}">
                <button type="button" class="btn btn-secondary"
                  onclick="agregarAlCarritoDOM('${producto.nombre}', 'precio_${idBase}', 'cantidad_${idBase}', '${idBase}')">
                  Agregar al carrito
                </button>
              </div>
            </div>
          </div>
        `;
        fila.appendChild(tarjeta);
      });

      subgrupoDiv.appendChild(fila);
      grupoDiv.appendChild(subgrupoDiv);
    });

    contenedorPrincipal.appendChild(grupoDiv);
  });

  // Activar primer grupo y subgrupo
  setTimeout(() => {
    const grupoKeys = Object.keys(grupos);
    if (grupoKeys.length === 0) return;

    const primerGrupoId = grupoKeys[0].trim().toLowerCase().replace(/\s+/g, '_'); // üëà blindado
    const primerGrupoDiv = document.getElementById('grupo_' + primerGrupoId);
    if (primerGrupoDiv) primerGrupoDiv.classList.add('active');

    const subgrupos = Object.keys(grupos[grupoKeys[0]]);
    const primerSubgrupoNombre = subgrupos[0]?.trim().toLowerCase();

    if (primerGrupoId && primerSubgrupoNombre) {
      filtrarSubcategoria(grupoKeys[0], subgrupos[0]); // se puede blindar tambi√©n si quer√©s
    }
  }, 100);
}

  document.addEventListener('click', function(event) {
  const carritoDiv = document.getElementById('carrito');
  const toggleBtn = document.getElementById('toggleCarrito');

  // Si el carrito est√° visible y el clic fue fuera del carrito y del bot√≥n
  if (
    carritoDiv.style.display === 'block' &&
    !carritoDiv.contains(event.target) &&
    !toggleBtn.contains(event.target)
  ) {
    carritoDiv.style.display = 'none';
  }
});

  document.getElementById("ordenPrecio")?.addEventListener("change", () => {
    if (window._gruposProductos) {
      renderizarProductos(window._gruposProductos);
    }
  });
  document.addEventListener('click', function(event) {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');

  const esClickDentroGrupos = panelGrupos.contains(event.target);
  const esClickDentroSub = panelSub.contains(event.target);
  const esBotonGrupo = event.target.classList.contains('btn-grupo');
  const esBotonNavegacion = event.target.closest('.barra-navegacion');

  // Si el clic no fue dentro de los paneles ni en botones de grupo o navegaci√≥n
  if (!esClickDentroGrupos && !esClickDentroSub && !esBotonGrupo && !esBotonNavegacion) {
    panelGrupos.classList.add('oculta');
    panelSub.classList.add('oculta');
  }
});
  document.getElementById('ordenPrecio').addEventListener('change', function () {
  const orden = this.value;
  const grupoActivo = document.querySelector('.grupo-section.active');
  if (!grupoActivo) return;

  const bloques = grupoActivo.querySelectorAll('.subgrupo-bloque');
  bloques.forEach(bloque => {
    const productos = Array.from(bloque.querySelectorAll('.col-lg-4, .col-md-6, .col-sm-12'));
    const contenedor = bloque.querySelector('.row');
    if (!contenedor) return;

    productos.sort((a, b) => {
      const precioA = parseFloat(a.querySelector('span[id^="precio_"]').textContent) || 0;
      const precioB = parseFloat(b.querySelector('span[id^="precio_"]').textContent) || 0;
      return orden === 'asc' ? precioA - precioB : precioB - precioA;
    });

    contenedor.innerHTML = '';
    productos.forEach(p => contenedor.appendChild(p));
  });
});
   console.log("üß™ modoAdmin:", {{ modoAdmin|tojson }});
  console.log("üß™ modoAdminIntentado:", {{ modoAdminIntentado|tojson }});
</script>
</body>
</html>
