<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vista previa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Vista previa para redes sociales -->
  <meta property="og:title" content="{{ config.titulo }}">
  <meta property="og:description" content="{{ config.descripcion }}">
  <meta property="og:image" content="{{ config.imagen_destacada }}">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="{{ config.url }}">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Google Fonts disponibles -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Playfair+Display&family=Fira+Code&family=Raleway&family=Quicksand&family=Pacifico&family=Source+Serif+4&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  {% set estilo = config.estilo_visual.lower() %}
  {% if 'claro' in estilo or 'esferas' in estilo or 'blanco' in estilo %}
    {% set modo_visual = 'modo-claro' %}
  {% else %}
    {% set modo_visual = 'modo-oscuro' %}
  {% endif %}

<style>
body {
  font-family: {{ config.fuente | safe }};
  background-image: url("/static/img/{{ config.estilo_visual }}.jpeg");
  background-size: cover;
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-position: center;
  padding-top: 70px;
}
h1, h2, h3, .btn, .card {
  font-family: {{ config.fuente | safe }};
}
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: -1;
}
.fade-reorder {
  opacity: 0;
  transform: scale(0.95);
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.fade-reorder.show {
  opacity: 1;
  transform: scale(1);
}
.fondo-animado {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: -2;
  background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08), transparent 40%),
              radial-gradient(circle at 80% 70%, rgba(255,255,255,0.06), transparent 40%);
  animation: moverFondo 40s ease-in-out infinite;
  background-size: 200% 200%;
  pointer-events: none;
}
html {
  scroll-behavior: auto;
}
.card {
  opacity: 0; /* arranca invisible */
  transform: translateY(20px);
  animation: fadeInUp 0.6s ease forwards; /* animaci√≥n que la hace visible */
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border-radius: 12px;
  overflow: hidden;
  will-change: transform, box-shadow;
  padding: 12px;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}
.modo-oscuro .card:hover {
  box-shadow: 0 8px 20px rgba(255,255,255,0.2);
}
.modo-claro .card:hover {
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}
.card-img-top {
  width: 100%;
  max-width: 300px;
  height: auto;
  display: block;
  margin-left: auto;
  margin-right: auto;
}
.card-body {
  padding: 10px;
}
.card-title {
  font-size: 1rem;
}
.card-text {
  font-size: 0.9rem;
}
.modo-claro .card {
  background-color: #fff;
  color: #333;
  border: none;
}
.modo-oscuro .card {
  background-color: rgba(0,0,0,0.6);
  color: white;
  border: 1px solid rgba(255,255,255,0.2);
}
.color-principal {
  color: inherit; /* o un color fijo, ej. #ff6f61 */
}
.bg-principal {
  background-color: transparent; /* o un color fijo */
}
.modo-oscuro {
  color: white;
}
.modo-claro {
  color: #333;
}
.barra-navegacion {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  display: flex;
  justify-content: center;
  gap: 16px;
  padding: 12px 20px;
  box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
}
.barra-navegacion button {
  font-family: {{ config.fuente | safe }};
  font-weight: 600;
  font-size: 16px;
  padding: 10px 20px;
  border-radius: 30px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.05);
  color: white;
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
  transition: all 0.3s ease;
}
/* Animaciones */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes moverFondo {
  0%   { background-position: 0% 0%; }
  50%  { background-position: 100% 100%; }
  100% { background-position: 0% 0%; }
}
.barra-navegacion button:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
}
.barra-wrapper {
  z-index: 1000;
}
.panel-grupos {
  position: fixed;
  max-height: 50vh; /* Altura m√°xima global */
  overflow-y: auto; /* Desplazamiento vertical global */
  left: 0;
  right: 0;
  z-index: 906;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  padding: 1px 0;
  text-align: center;
  box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
}
.panel-grupos button {
  font-family: {{ config.fuente | safe }};
  font-weight: 600;
  margin: 6px;
  padding: 2px 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 30px;
  background: rgba(255, 255, 255, 0.05);
  color: white;
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
  cursor: pointer;
  transition: all 0.3s ease;
}
.panel-grupos button:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
}
.oculta {
  display: none !important;
}
.logo { 
  height: 10vw; 
  max-height: 380px; 
  filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px white);
  transition: filter 0.3s ease;
  animation: pulsoLogo 4s ease-in-out infinite;
}
@keyframes pulsoLogo {
  0%, 100% {
    filter: brightness(1.5) contrast(1.2) drop-shadow(0 0 14px none);
  }
  50% {
    filter: brightness(1.8) contrast(1.3) drop-shadow(0 0 20px none);
  }
}
.descripcion-emprendimiento {
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  padding: 20px;
  border-radius: 10px;
  display: inline-block;
  max-width: 800px;
  white-space: pre-line;
  text-align: center;
  text-indent: 20px;
  font-size: 16px;
  line-height: 1.6;
  box-shadow: 0 0 6px rgba(255,255,255,0.3);
}
.btn-grupo {
  position: relative;
  padding: 8px 16px;
  margin: 5px;
  border-radius: 20px;
  font-weight: bold;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 0 6px rgba(255,255,255,0.3);
  transition: all 0.3s ease;
  overflow: hidden;
}
.modo-claro .btn-grupo {
  background-color: transparent;
  color: white;
  border: none;
}
.modo-oscuro .btn-grupo {
  background-color: rgba(255, 255, 255, 0.05);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 4px rgba(255,255,255,0.1);
}
.btn-grupo::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 20px;
  z-index: -1;
}
.modo-claro .btn-grupo::before {
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08), transparent 70%);
}
.modo-oscuro .btn-grupo::before {
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05), transparent 70%);
}
.btn-grupo:hover {
  background-color: #fff;
  color: #333;
  transform: scale(1.05);
  box-shadow: 0 0 8px none;
}
.btn-grupo.active {
  box-shadow: none;
}
.btn-whatsapp {
  background-color: #25D366;
  border: none;
  padding: 8px 16px;
  color: white;
  border-radius: 5px;
  font-size: 14px;
}
.btn-volver-arriba {
  background-color: white;
  color: black;
  border: none;
  font-size: 20px;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
  -webkit-tap-highlight-color: transparent;
}
.btn-volver-arriba:hover {
  background-color: #f0f0f0;
  transform: scale(1.1);
}
.btn-volver-arriba:focus,
.btn-volver-arriba:active,
.btn-volver-arriba:visited {
  outline: none;
  box-shadow: none;
  background-color: white;
  color: black;
}
.grupo-section {
  display: none;
  min-height: 100vh;
}
.grupo-section.active {
  display: block !important;
}
.social-icons {
  margin-top: 40px;
  text-align: center;
}
.social-icons img {
  width: 40px;
  margin: 0 10px;
  transition: transform 0.3s ease;
  filter: drop-shadow(0 0 3px white);
}
.social-icons img:hover {
  transform: scale(1.1);
  filter: drop-shadow(0 0 0 transparent);
}
.bloque-ubicacion {
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  padding: 12px 16px;
  border-radius: 10px;
  text-align: center;
  max-width: 600px;
  margin: 20px auto 0;
  box-shadow: 0 0 6px rgba(255,255,255,0.3);
}
#carrito {
  position: fixed;
  bottom: 80px;
  right: 20px;
  padding: 15px;
  border-radius: 10px;
  width: 300px;
  z-index: 999;
  display: none;
}
.modo-oscuro #carrito {
  background-color: rgba(0,0,0,0.85);
  color: white;
  border: 1px solid white;
  box-shadow: 0 0 10px white;
}
.modo-claro #carrito {
  background-color: #fff;
  color: #333;
  border: 1px solid #ccc;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
#toggleCarrito {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  padding: 10px 14px;
  border-radius: 50px;
  font-weight: bold;
  box-shadow: 0 0 5px white;
}
.modo-oscuro #toggleCarrito {
  background-color: transparent;
  color: black;
  border: none;
}
.modo-claro #toggleCarrito {
  background-color: transparent;
  color: white;
  border: none;
}
.panel-subcategorias {
  position: fixed;
  max-height: 50vh; /* Altura m√°xima global */
  overflow-y: auto; /* Desplazamiento vertical global */
  left: 0;
  right: 0;
  z-index: 908;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  padding: 1px 0;
  text-align: center;
  box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}
.panel-subcategorias button {
  font-family: {{ config.fuente | safe }};
  font-weight: 600;
  margin: 6px;
  padding: 1px 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 30px;
  background: rgba(255, 255, 255, 0.05);
  color: white;
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
  cursor: pointer;
  transition: all 0.3s ease;
}
.panel-subcategorias button:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: scale(1.05);
}
@media (min-width: 1024px) {
  .logo {
    width: 103px;
    height: 103px;
    max-height: none; /* opcional, para que no interfiera */
  }
}
.barra-navegacion {
  padding: 8px 10px;
  gap: 8px;
}
.barra-navegacion button {
  font-size: 14px;
  padding: 8px 15px;
}
.panel-grupos {
  padding: 1px 0;
  max-height: 50vh; /* Altura m√°xima para que sea desplazable si hay muchos botones */
  overflow-y: auto; /* Hace el panel desplazable verticalmente */
}

.panel-grupos button {
  font-size: 13px;
  padding: 1px 6px;
  border-radius: 8px;
}
.panel-subcategorias {
  padding: 1px 0;
  max-height: 50vh; /* Altura m√°xima para el panel de subcategor√≠as */
  overflow-y: auto; /* Hace el panel desplazable verticalmente */
}
.panel-subcategorias button {
  font-size: 13px;
  padding: 1px 6px;
  border-radius: 8px;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes moverFondo {
  0%   { background-position: 0% 0%; }
  50%  { background-position: 100% 100%; }
  100% { background-position: 0% 0%; }
}
</style>
</head>
<body class="container py-5 {{ modo_visual }}">
  <div class="barra-wrapper">
    <nav class="barra-navegacion">
      <button id="btnProductos" onclick="mostrarTodos()">Productos</button>
      <button id="btnContacto" onclick="irAContacto()">Contacto</button>
    </nav>

    <!-- Panel de grupos: ahora vac√≠o, se llena con JS -->
    <div id="panelGrupos" class="panel-grupos oculta">
      <!-- Los botones de grupo se generan din√°micamente desde la API -->
    </div>
  </div>

  <!-- Panel de subcategor√≠as: tambi√©n se llena con JS -->
  <div id="panelSubcategorias" class="panel-subcategorias oculta"></div>
  
  <button id="volverArriba" class="btn btn-volver-arriba" 
          style="position: fixed; bottom: 20px; left: 20px; display: none; z-index: 1000;">
    ‚Üë
  </button>

  {% if config.logo %}
    <div class="text-center mt-4">
      <img src="{{ url_for('static', filename='img/' + config.logo) }}"
           alt="Logo"
           class="img-fluid logo mx-auto d-block">
    </div>
  {% endif %}

  {% if modoAdminIntentado and not modoAdmin %}
    <div id="login-admin" class="container mt-4">
      <h3 class="text-center">üîê Ingres√° tu clave de administrador</h3>
      <form id="form-login-admin" class="text-center">
        <input type="text" id="usuario_login" placeholder="Usuario" required>
        <input type="password" id="clave_login" placeholder="Contrase√±a" required>
        <button type="submit" style="margin-top: 10px;">Entrar</button>
      </form>
    </div>
  {% endif %}

  {% if modoAdmin %}
    <div class="text-center mt-3">
      <!-- üîì Bot√≥n para salir del modo administrador -->
      <a href="/logout-admin" class="btn btn-sm btn-outline-light">üîì Salir del modo administrador</a>

      <!-- üí≥ Bot√≥n para configurar / reconfigurar Mercado Pago -->
      <a href="{{ url_for('conectar_mp') }}" class="btn btn-sm btn-primary mt-2">
        <img src="{{ url_for('static', filename='img/mercadopago.png') }}" 
             alt="Mercado Pago" style="height:20px; margin-right:8px;">
        {% if config.mercado_pago %}
          Reconfigurar Mercado Pago
        {% else %}
          Configurar Mercado Pago
        {% endif %}
      </a>
    </div>
  {% endif %}

  <div class="text-center my-4">
    <select id="ordenPrecio" class="form-select w-auto d-inline-block">
      <option value="asc">Precio: Menor a mayor</option>
      <option value="desc">Precio: Mayor a menor</option>
    </select>
  </div>

{% if config.sobre_mi %}
  <div class="text-center mb-4">
    <div class="descripcion-emprendimiento">
       {{ config.sobre_mi | replace('\n', '<br>') | safe }}
    </div>
  </div>
{% endif %}  

<div id="contenedor-grupos"></div>
<div id="productos" class="row mt-4"></div>

<div class="text-center mt-5">
  <a href="/descargar" class="btn btn-primary px-5">
    Descargar sitio
  </a>
</div>

<div class="social-icons">
  {% if config.facebook %}
    <a href="{{ config.facebook }}" target="_blank">
      <img src="/static/img/facebook.png" alt="Facebook">
    </a>
  {% endif %}
  {% if config.instagram %}
    <a href="{{ config.instagram }}" target="_blank">
      <img src="/static/img/instagram.png" alt="Instagram">
    </a>
  {% endif %}
  {% if config.whatsapp %}
    <a href="{{ config.whatsapp }}" target="_blank">
      <img src="/static/img/whatsapp.png" alt="WhatsApp">
    </a>
  {% endif %}
</div>

{% if config.ubicacion %}
  <div id="ubicacion" class="bloque-ubicacion text-center mt-4">
    <p style="margin-bottom: 6px;">
      üìç {{ config.ubicacion }}
    </p>
    {% if config.link_mapa %}
      <a href="{{ config.link_mapa }}" target="_blank" style="text-decoration: none;">
        <span style="margin-right: 6px;">‚ûú</span>
        <img src="/static/img/map.png" alt="Ver en Google Maps" style="width: 30px;">
      </a>
    {% endif %}
  </div>
{% endif %}

<button id="toggleCarrito">üõí</button>

<div id="carrito">
  <h5>üõí Tu carrito</h5>
  <ul id="listaCarrito"></ul>
  <p><strong>Total:</strong> $<span id="totalCarrito">0</span></p>
  <div class="d-grid gap-2">
    <button class="btn btn-sm btn-danger" onclick="vaciarCarrito()">Vaciar carrito</button>

    {% if config.mercado_pago and config.public_key %}
      <button id="btn_pagar" class="btn btn-sm btn-primary" onclick="pagarConMercadoPago()">Pagar con Mercado Pago</button>
    {% else %}
      <a id="enviarCarrito" class="btn btn-sm btn-success" target="_blank">Enviar por WhatsApp</a>
    {% endif %}
  </div>
</div>

<!-- Aviso flotante de precio actualizado -->
<div id="avisoPrecio" class="alert alert-success text-center" role="alert"
     style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Precio actualizado
</div>

<!-- Aviso flotante de talle actualizado -->
<div id="avisoTalle" class="alert alert-info text-center" role="alert"
     style="display: none; position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  ‚úî Talle actualizado
</div>

  <script>
const configWhatsApp = "{{ config.whatsapp }}";
const EMAIL_VENDEDOR = "{{ session.get('email') }}";
const URL_BACKEND = "https://appweb-n4cl.onrender.com"; // Tu URL central

  // Mostrar/ocultar bot√≥n volver arriba
  window.addEventListener('scroll', () => {
    const btn = document.getElementById('volverArriba');
    btn.style.display = window.scrollY > 300 ? 'block' : 'none';
    btn.style.backgroundColor = 'white';
    btn.style.color = 'black';
  });

  document.getElementById('volverArriba').onclick = () => {
    window.scrollTo({ top: 0, behavior: 'auto' });
  };

fetch("/api/productos")
  .then(r => r.json())
  .then(lista => {
    window.todosLosProductos = Array.isArray(lista) ? lista : [];

    const cont = document.getElementById("productos");
    const contGrupos = document.getElementById("panelGrupos");
    const contSub = document.getElementById("panelSubcategorias");

    if (!cont) {
      console.warn("‚ö†Ô∏è No existe #productos en el DOM");
      return;
    }
    if (!contGrupos || !contSub) {
      console.warn("‚ö†Ô∏è Faltan paneles #panelGrupos o #panelSubcategorias en el DOM");
    }

    const grupos = [...new Set(window.todosLosProductos.map(p => p.grupo).filter(Boolean))];
    if (contGrupos) {
      grupos.forEach(g => {
        contGrupos.insertAdjacentHTML("beforeend", `
          <button class="btn-grupo" onclick="mostrarGrupo('${g}', event)">${g}</button>
        `);
      });
    }

    // Render inicial: primer grupo y subgrupo
    const primerGrupo = grupos[0];
    const subgruposPrimer = [...new Set(window.todosLosProductos
      .filter(p => p.grupo === primerGrupo)
      .map(p => p.subgrupo).filter(Boolean))];

    if (primerGrupo) {
      mostrarGrupo(primerGrupo, null, true);
      if (subgruposPrimer.length > 0) {
        filtrarSubcategoria(primerGrupo, subgruposPrimer[0]);
      }
    }
  })
  .catch(err => {
    console.error("Error cargando productos:", err);
    const cont = document.getElementById("productos");
    if (cont) cont.innerHTML = "<p>Error al cargar productos.</p>";
  });
    
function mostrarGrupo(nombre, event, auto = false) {
  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }

  // Resetear botones de grupo
  document.querySelectorAll('.btn-grupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) event.target.classList.add('active');

  const panel = document.getElementById('panelSubcategorias');
  if (!panel) return;
  panel.innerHTML = "";

  const productosGrupo = window.todosLosProductos.filter(
    p => p.grupo?.toLowerCase() === nombre.toLowerCase()
  );

  const subcategorias = [...new Set(
    productosGrupo.map(p => p.subgrupo).filter(s => s && s.toLowerCase() !== 'general')
  )];

  subcategorias.forEach(sub => {
    const btn = document.createElement('button');
    btn.textContent = sub;
    btn.className = 'btn-subgrupo';
    btn.onclick = () => filtrarSubcategoria(nombre, sub);
    panel.appendChild(btn);
  });

  if (subcategorias.length > 0) {
    if (!auto) {
      panel.classList.remove('oculta');
      filtrarSubcategoria(nombre, subcategorias[0]);
    } else {
      panel.classList.add('oculta');
    }
  } else {
    // Caso sin subcategor√≠as ‚Üí mostrar todo el grupo
    panel.classList.add('oculta');
    cont.innerHTML = "";
    productosGrupo.forEach(p => {
      const card = renderProducto(p);
      cont.appendChild(card);
      // üëá activar transici√≥n al siguiente frame
      requestAnimationFrame(() => card.classList.add("show"));
    });
  }

  window.scrollTo({ top: 0, behavior: 'auto' });
}

window.mostrarGrupo = mostrarGrupo;

function filtrarSubcategoria(grupo, subgrupo) {
  const cont = document.getElementById("productos");
  if (!cont) {
    console.warn("‚ö†Ô∏è No existe #productos en el DOM");
    return;
  }
  cont.innerHTML = "";

  let productosFiltrados;
  if (subgrupo && subgrupo.trim() !== "") {
    // Caso grupo + subgrupo
    productosFiltrados = window.todosLosProductos.filter(p =>
      p.grupo?.toLowerCase() === grupo.toLowerCase() &&
      p.subgrupo?.toLowerCase() === subgrupo.toLowerCase()
    );
  } else {
    // Caso "General" ‚Üí normalizar igual que en Firestore
    const subgrupoGeneral = `General_${grupo}`;
    productosFiltrados = window.todosLosProductos.filter(p =>
      p.grupo?.toLowerCase() === grupo.toLowerCase() &&
      p.subgrupo?.toLowerCase() === subgrupoGeneral.toLowerCase()
    );
  }

  productosFiltrados.forEach(p => {
    const card = renderProducto(p); // üëà devuelve el div con fade-reorder
    cont.appendChild(card);
    // üëá activar transici√≥n al siguiente frame
    requestAnimationFrame(() => card.classList.add("show"));
  });

  window.scrollTo({ top: 0, behavior: 'auto' });
}

// Si us√°s type="module", exponerla al global:
window.filtrarSubcategoria = filtrarSubcategoria;


window.onload = function() {
  const panelSubcategorias = document.getElementById('panelSubcategorias');
  const panelGrupos = document.getElementById('panelGrupos');
  panelSubcategorias.classList.add('oculta');
  panelGrupos.classList.add('oculta');

  // Usar los datos de la API para inicializar
  fetch("/api/productos")
    .then(r => r.json())
    .then(lista => {
      window.todosLosProductos = lista;

      const primerGrupo = [...new Set(lista.map(p => p.grupo))][0];
      const primerSub = lista.find(p => p.grupo === primerGrupo && p.subgrupo?.toLowerCase() !== "general")?.subgrupo;

      if (primerGrupo && primerSub) {
        mostrarGrupo(primerGrupo, null, true);
        filtrarSubcategoria(primerGrupo, primerSub);
      }
    });

  document.getElementById('toggleCarrito').onclick = function() {
    const carritoDiv = document.getElementById('carrito');
    if (!carritoDiv) return;
    carritoDiv.style.display = carritoDiv.style.display === 'none' ? 'block' : 'none';
  };
};

let carrito = [];

function agregarAlCarritoDOM(nombre, idPrecioSpan, idCantidad, id_base, grupo = "", subgrupo = "") {
  const cantidadInput = document.getElementById(idCantidad);
  const precioSpan = document.getElementById(idPrecioSpan);
  const talleSelect = document.getElementById("talle_" + id_base);

  const cantidad = parseInt(cantidadInput?.value) || 1;
  const precio = parseFloat(precioSpan?.textContent?.trim()) || 0;
  const talleElegido = talleSelect?.value || "Sin talle";

  const existente = carrito.find(item => item.id_base === id_base && item.talle === talleElegido);
  if (existente) {
    existente.cantidad += cantidad;
  } else {
    const nuevoItem = { nombre, precio, cantidad, id_base, talle: talleElegido, grupo, subgrupo };
    carrito.push(nuevoItem);
  }

  actualizarCarrito();
}

async function pagarConMercadoPago() {
  try {
    if (!carrito.length) {
      alert("Tu carrito est√° vac√≠o");
      return;
    }

    const response = await fetch(`${URL_BACKEND}/pagar`, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        carrito,
        email_vendedor: EMAIL_VENDEDOR,
        url_retorno: window.location.href
      })
    });

    const data = await response.json();

    if (data.preference_id) {
      // ‚úÖ Checkout Pro con SDK
      mp.checkout({
        preference: { id: data.preference_id },
        autoOpen: true
      });
    } else if (data.init_point) {
      // ‚úÖ Fallback cl√°sico
      window.location.href = data.init_point;
    } else {
      alert("Error al generar el pago: " + (data.error || "desconocido"));
    }
  } catch (err) {
    console.error("‚ö†Ô∏è Error al conectar con backend central:", err);
    alert("Error interno al intentar pagar");
  }
}

function editarPrecio(id) {
  const span = document.getElementById("precio_" + id);
  if (!span) return;

  const valorActual = span.textContent.replace("$", "").trim();

  const input = document.createElement("input");
  input.type = "number";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "80px";
  input.id = "input_precio_" + id;

  input.onblur = () => guardarPrecio(id);

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") input.blur(); // dispara onblur
  });

  span.replaceWith(input);
  input.focus();
}

function guardarPrecio(id) {
  const input = document.getElementById("input_precio_" + id);
  if (!input) return;

  const nuevoValor = parseFloat(input.value);
  if (isNaN(nuevoValor)) {
    alert("‚ùå El precio ingresado no es v√°lido");
    return;
  }

  fetch('/actualizar-precio', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, nuevoPrecio: nuevoValor })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const span = document.createElement("span");
        span.id = "precio_" + id;
        const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        span.textContent = "$" + fmt.format(nuevoValor);
        span.className = input.className;
        span.classList.add("text-success");
        input.replaceWith(span);
        setTimeout(() => span.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoPrecio === "function") mostrarAvisoPrecio();
      } else {
        alert("‚ùå No se pudo actualizar el precio en el servidor");
      }
    })
    .catch(() => {
      alert("‚ùå Error de conexi√≥n al guardar el precio");
    });
}

function loginAdmin(event) {
  event.preventDefault();

  const usuario = document.getElementById("usuario_login").value.trim();
  const clave = document.getElementById("clave_login").value.trim();

  if (!usuario || !clave) {
    alert("‚ùå Usuario y clave requeridos");
    return;
  }

  const btn = event.target.querySelector('button[type="submit"]');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Entrando...';
  }

  fetch("/login-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario, clave })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert("‚úÖ Acceso concedido");
        location.href = "/preview"; // redirigir directo al preview
      } else {
        alert("‚ùå " + data.message);
      }
    })
    .catch(() => {
      alert("‚ùå Error al intentar login");
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Entrar';
      }
    });
}

function editarTalles(id) {
  const select = document.getElementById("talle_" + id);
  if (!select) return;

  const opciones = Array.from(select.options).map(opt => opt.value).filter(Boolean);
  const valorActual = opciones.join(", ");

  const input = document.createElement("input");
  input.type = "text";
  input.value = valorActual;
  input.className = "form-control form-control-sm d-inline-block";
  input.style.width = "200px";
  input.id = "input_talles_" + id;

  input.onblur = () => guardarTalles(id);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") input.blur(); });

  select.replaceWith(input);
  input.focus();
}

function guardarTalles(id) {
  const input = document.getElementById("input_talles_" + id);
  if (!input) return;

  const nuevosTalles = input.value.split(",").map(t => t.trim()).filter(t => t);

  fetch('/actualizar-talles', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, talles: nuevosTalles })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const nuevoSelect = document.createElement("select");
        nuevoSelect.id = "talle_" + id;
        nuevoSelect.className = "form-select form-select-sm w-auto d-inline-block";

        if (nuevosTalles.length > 0) {
          nuevosTalles.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            nuevoSelect.appendChild(opt);
          });
        } else {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Sin talles";
          nuevoSelect.appendChild(opt);
        }

        input.replaceWith(nuevoSelect);
        nuevoSelect.classList.add("text-success");
        setTimeout(() => nuevoSelect.classList.remove("text-success"), 1000);

        if (typeof mostrarAvisoTalle === "function") mostrarAvisoTalle();
      } else {
        alert("‚ùå No se pudo actualizar los talles en el servidor");
      }
    })
    .catch(() => {
      alert("‚ùå Error de conexi√≥n al guardar los talles");
    });
}

function actualizarFirestore(id, datos) {
  if (!id || typeof datos !== "object" || Object.keys(datos).length === 0) {
    return;
  }

  fetch("/actualizar-firestore", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, ...datos })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        if (typeof mostrarAvisoFirestore === "function") mostrarAvisoFirestore();
      } else {
        mostrarAviso("‚ùå " + (data.error || "No se pudo actualizar Firestore"));
      }
    })
    .catch(() => {
      mostrarAviso("‚ùå Error de conexi√≥n al guardar los datos");
    });
}

function guardarProducto(producto) {
  fetch('/guardar-producto', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ producto })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'ok') {
        mostrarAviso("‚úÖ Producto guardado correctamente");
      } else {
        mostrarAviso("‚ùå " + (data.error || "Error al guardar producto"));
      }
    })
    .catch(() => {
      mostrarAviso("‚ùå Error de conexi√≥n");
    });
}

function cargarProductos() {
  fetch('/ver-productos')
    .then(res => res.json())
    .then(productos => {
      if (Array.isArray(productos)) {
        renderizarProductos(productos);
      } else {
        mostrarAviso("‚ùå Respuesta inv√°lida del servidor");
      }
    })
    .catch(() => {
      mostrarAviso("‚ùå Error al cargar productos");
    });
}

function mostrarAvisoPrecio() {
  const aviso = document.getElementById("avisoPrecio");
  if (!aviso) return;
  aviso.style.display = "block";
  setTimeout(() => {
    aviso.style.display = "none";
  }, 2000);
}

function eliminarProducto(id_base, talle, event) {
  if (event?.stopPropagation) event.stopPropagation();
  carrito = carrito.filter(p => !(p.id_base === id_base && p.talle === talle));
  actualizarCarrito();
}
    
function mostrarSubgrupo(subgrupo, event) {
  // Buscar el grupo actualmente activo (bot√≥n marcado)
  const grupoActivoBtn = document.querySelector('.btn-grupo.active');
  const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;

  if (!grupoActivo) {
    console.warn("‚ö†Ô∏è No hay grupo activo para mostrar subgrupo:", subgrupo);
    return;
  }

  // Resetear botones de subgrupo
  document.querySelectorAll('.btn-subgrupo').forEach(btn => btn.classList.remove('active'));
  if (event?.target) event.target.classList.add('active');

  // Filtrar y renderizar productos del grupo + subgrupo
  filtrarSubcategoria(grupoActivo, subgrupo);
}

// Si us√°s type="module", exponerla al global:
window.mostrarSubgrupo = mostrarSubgrupo;

function vaciarCarrito() {
  carrito = [];
  actualizarCarrito();
}

function actualizarPrecioEnCarrito(nombre, nuevoPrecio) {
  let cambio = false;
  carrito.forEach(item => {
    if (item.nombre === nombre && item.precio !== nuevoPrecio) {
      item.precio = nuevoPrecio;
      cambio = true;
    }
  });
  if (cambio) actualizarCarrito();
}

function sincronizarPreciosDelCarrito() {
  carrito.forEach(item => {
    const idPrecio = "precio_" + (item.id_base || item.nombre.replace(/ /g, "_"));
    const precioSpan = document.getElementById(idPrecio);
    if (precioSpan) {
      const precioActual = parseFloat(precioSpan.textContent);
      if (!isNaN(precioActual)) {
        item.precio = precioActual;
      }
    }
  });
}

function actualizarCarrito() {
  sincronizarPreciosDelCarrito();

  const lista = document.getElementById('listaCarrito');
  const total = document.getElementById('totalCarrito');
  const link = document.getElementById('enviarCarrito');
  if (!lista || !total) return;

  lista.innerHTML = '';
  let suma = 0;

  if (carrito.length === 0) {
    lista.innerHTML = "<li>üõí Carrito vac√≠o</li>";
    total.textContent = "0.00";
    if (link) link.href = configWhatsApp;
    return;
  }

  const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  carrito.forEach(item => {
    const subtotal = item.precio * item.cantidad;
    suma += subtotal;

    lista.insertAdjacentHTML("beforeend", `
      <li style="display: flex; justify-content: space-between; align-items: center;">
        <span>${item.nombre}${item.talle ? ' (' + item.talle + ')' : ''} x ${item.cantidad} - $${fmt.format(subtotal)}</span>
        <button onclick="eliminarProducto('${item.id_base}', '${item.talle}', event)" 
                style="background: none; border: none; color: red; font-weight: bold; font-size: 16px; cursor: pointer;">
          ‚ùå
        </button>
      </li>`);
  });

  total.textContent = fmt.format(suma);

  const mensaje = encodeURIComponent(
    `Hola, quiero consultar por:\n` +
    carrito.map(i => `- ${i.nombre}${i.talle ? ' (' + i.talle + ')' : ''} x ${i.cantidad}: $${fmt.format(i.precio * i.cantidad)}`).join('\n') +
    `\nTotal estimado: $${fmt.format(suma)}`
  );

  if (link) {
    link.href = configWhatsApp + '?text=' + mensaje;
  }
}

function mostrarTodos() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');

  if (!panelGrupos || !panelSub) return;

  panelGrupos.classList.toggle('oculta');

  if (!panelSub.classList.contains('oculta')) {
    panelSub.classList.add('oculta');
  }
}
window.mostrarTodos = mostrarTodos; 
    
function irAContacto() {
  const contacto = document.getElementById('ubicacion');
  if (contacto) contacto.scrollIntoView({ behavior: 'auto' });
}
window.irAContacto = irAContacto; // si us√°s m√≥dulos
    
function renderProducto(p) {
  const card = document.createElement("div");
  // conserv√° tus clases de layout y animaci√≥n, y a√±ad√≠ 'card-producto'
  card.className = "col-lg-4 col-md-6 col-sm-12 mb-4 fade-reorder card-producto";

  // setear atributos de dataset necesarios para ordenarDentroDeBloques
  card.dataset.precio = String(Number(p.precio) || 0);
  if (p.id_base != null) card.dataset.id = String(p.id_base);

  card.innerHTML = `
    <div class="card p-3 h-100">
      <img src="${p.imagen_github || '/static/img/fallback.webp'}"
           alt="${p.nombre}" loading="lazy"
           style="width:300px;height:180px;object-fit:contain;border-radius:4px;">
      <div class="card-body">
        <h5 class="card-title">${p.nombre}</h5>
        <p class="card-text">${p.descripcion || ""}</p>
        <p><strong>Precio:</strong> $<span id="precio_${p.id_base}">${p.precio}</span></p>
        ${Array.isArray(p.talles) && p.talles.length ? `
          <div class="mb-2">
            <label class="form-label mb-1" style="font-size: 14px;"><strong>Talle:</strong></label>
            <select id="talle_${p.id_base}" class="form-select form-select-sm w-auto d-inline-block">
              ${p.talles.map(t => `<option value="${t}">${t}</option>`).join("")}
            </select>
          </div>` : ""}
        ${configWhatsApp ? `<a href="${configWhatsApp}" class="btn btn-whatsapp">Contactar por WhatsApp</a>` : ""}
        <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
          <label class="mb-0" style="font-size: 14px;">Cantidad:</label>
          <input type="number" min="1" max="100" value="1"
                 id="cantidad_${p.id_base}"
                 class="form-control form-control-sm" style="width: 70px;">
          <button type="button" class="btn btn-secondary"
            onclick="agregarAlCarritoDOM('${p.nombre}', 'precio_${p.id_base}', 'cantidad_${p.id_base}', '${p.id_base}', '${p.grupo}', '${p.subgrupo}')">
            Agregar al carrito
          </button>
        </div>
      </div>
    </div>
  `;

  // Log de diagn√≥stico: confirmar clase y dataset para ordenar
  console.log('renderProducto ->', {
    clase: card.className,
    dataset_precio: card.dataset.precio,
    dataset_id: card.dataset.id || "(sin-id)",
    nombre: p.nombre,
    grupo: p.grupo || "(sin-grupo)",
    subgrupo: p.subgrupo || "(sin-subgrupo)"
  });

  return card;
}
    
function ajustarPosicionesPaneles() {
  const panelGrupos = document.getElementById('panelGrupos');
  const panelSub = document.getElementById('panelSubcategorias');
  const barraNav = document.querySelector('.barra-navegacion');

  if (!panelGrupos || !panelSub) return;

  if (!panelGrupos.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    panelGrupos.style.top = alturaBarra + 'px';
    panelGrupos.style.position = 'fixed';
    panelGrupos.style.left = '0';
    panelGrupos.style.right = '0';
  }

  if (!panelSub.classList.contains('oculta')) {
    const alturaBarra = barraNav ? barraNav.offsetHeight : 0;
    const alturaGrupos = panelGrupos ? panelGrupos.offsetHeight : 0;
    const margenAdicional = 19;
    const desplazamientoArriba = -20;
    panelSub.style.top = (alturaBarra + alturaGrupos + margenAdicional + desplazamientoArriba) + 'px';
    panelSub.style.position = 'fixed';
    panelSub.style.left = '0';
    panelSub.style.right = '0';
  } else {
    panelSub.style.top = '';
  }
}
  
// üëâ Helpers de diagn√≥stico (solo logs)
function logTitulo(msg) {
  console.log(`\n===== ${msg} =====`);
}
    
function logCardsOrden(bloque, etiqueta) {
  const items = Array.from(bloque.querySelectorAll(".card-producto")).map(card => ({
    id: card.dataset.id || "(sin-id)",
    subgrupo: card.closest(".bloque-subgrupo")?.dataset?.subgrupo || "(sin-bloque)",
    precio: Number(card.dataset.precio) || 0
  }));
  console.table(items, ["id", "subgrupo", "precio"]);
  console.log(`Total ${etiqueta}:`, items.length);
}

// Reordenar dentro de bloques ya existentes
function ordenarDentroDeBloques(asc = true) {
  const bloques = document.querySelectorAll(".bloque-subgrupo");
  bloques.forEach(bloque => {
    const cards = Array.from(bloque.querySelectorAll(".card-producto"));
    cards.sort((a, b) => {
      const pa = Number(a.dataset.precio) || 0;
      const pb = Number(b.dataset.precio) || 0;
      return asc ? pa - pb : pb - pa;
    });
    // Reinsertar en orden sin vaciar el bloque (preserva nodos y dataset)
    cards.forEach(card => bloque.appendChild(card));
  });
}

document.addEventListener("DOMContentLoaded", () => {
  // Login admin
  const form = document.getElementById("form-login-admin");
  if (form) {
    form.addEventListener("submit", loginAdmin);
  }

  // Ajustar posiciones al cargar y al redimensionar
  window.addEventListener("load", ajustarPosicionesPaneles);
  window.addEventListener("resize", ajustarPosicionesPaneles);

  // Bot√≥n Productos
  const btnProductos = document.getElementById("btnProductos");
  if (btnProductos) {
    btnProductos.addEventListener("click", () => {
      const panelGrupos = document.getElementById("panelGrupos");
      if (panelGrupos) panelGrupos.classList.remove("oculta");

      // Ajustar posiciones despu√©s de mostrar
      setTimeout(ajustarPosicionesPaneles, 0);
    });
  }

  // Bot√≥n Subcategor√≠as
  const btnSubcategorias = document.getElementById("btnSubcategorias");
  if (btnSubcategorias) {
    btnSubcategorias.addEventListener("click", () => {
      const panelSub = document.getElementById("panelSubcategorias");
      if (panelSub) panelSub.classList.remove("oculta");

      // Ajustar posiciones despu√©s de mostrar
      setTimeout(ajustarPosicionesPaneles, 0);
    });
  }

  // Delegaci√≥n de eventos para botones de grupo din√°micos
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("btn-grupo")) {
      setTimeout(ajustarPosicionesPaneles, 0);
    }

    // ‚úÖ Cerrar carrito al hacer clic fuera
    const carritoDiv = document.getElementById("carrito");
    const toggleBtn = document.getElementById("toggleCarrito");
    if (carritoDiv && toggleBtn) {
      const visible = carritoDiv.style.display === "block";
      const clicFueraCarrito = !carritoDiv.contains(e.target) && !toggleBtn.contains(e.target);
      if (visible && clicFueraCarrito) {
        carritoDiv.style.display = "none";
      }
    }

    // ‚úÖ Ocultar paneles al hacer clic fuera
    const panelGrupos = document.getElementById("panelGrupos");
    const panelSub = document.getElementById("panelSubcategorias");
    if (panelGrupos && panelSub) {
      const esClickDentroGrupos = panelGrupos.contains(e.target);
      const esClickDentroSub = panelSub.contains(e.target);
      const esBotonGrupo = e.target.classList.contains("btn-grupo");
      const esBotonNavegacion = !!e.target.closest(".barra-navegacion");

      if (!esClickDentroGrupos && !esClickDentroSub && !esBotonGrupo && !esBotonNavegacion) {
        panelGrupos.classList.add("oculta");
        panelSub.classList.add("oculta");
      }
    }
  });

  // üëâ Ordenar por precio sin mezclar subgrupos (usa ordenarDentroDeBloques)
  const ordenSelect = document.getElementById("ordenPrecio");
  if (ordenSelect) {
    ordenSelect.addEventListener("change", (e) => {
      const asc = e.target.value === "asc";

      const grupoActivoBtn = document.querySelector(".btn-grupo.active");
      const grupoActivo = grupoActivoBtn ? grupoActivoBtn.textContent.trim() : null;

      const subActivoBtn = document.querySelector(".btn-subgrupo.active");
      const subActivo = subActivoBtn ? subActivoBtn.textContent.trim() : null;

      // Tomamos la fuente original
      let productosFiltrados = window.todosLosProductos || [];

      // Filtramos por grupo activo si existe
      if (grupoActivo) {
        productosFiltrados = productosFiltrados.filter(
          p => p.grupo?.toLowerCase() === grupoActivo.toLowerCase()
        );
      }

      if (grupoActivo && subActivo) {
        // Caso 1: hay subgrupo activo ‚Üí ordenar solo ese subgrupo (reemplaza contenido del bloque activo)
        const bloque = document.querySelector(`.bloque-subgrupo[data-subgrupo="${subActivo}"]`);
        if (bloque) {
          // Filtrar productos para ese subgrupo y ordenarlos
          const productosSub = productosFiltrados.filter(
            p => p.subgrupo?.toLowerCase() === subActivo.toLowerCase()
          ).sort((a, b) => {
            const pa = Number(a.precio) || 0;
            const pb = Number(b.precio) || 0;
            return asc ? pa - pb : pb - pa;
          });

          // Reemplazar contenido del bloque con las cards en orden
          bloque.innerHTML = "";
          productosSub.forEach(p => {
            const card = renderProducto(p);
            bloque.appendChild(card);
            setTimeout(() => card.classList.remove("fade-reorder"), 50);
          });
        }
      } else if (grupoActivo) {
        // Caso 2: NO hay subgrupo activo ‚Üí reordenar dentro de cada bloque ya existente
        // Si los bloques ya est√°n en DOM, esto solo reordena sus cards; no recrea bloques
        ordenarDentroDeBloques(asc);
      } else {
        // Si no hay grupo activo, pod√©s decidir no ordenar o aplicar orden global.
        // Aqu√≠ no hacemos nada para respetar la UX actual.
      }
    });
  }
}); // üëà cierre de DOMContentLoaded

// Bot√≥n Productos (SOLO cierra los paneles)
const btnProductos = document.getElementById('btnProductos');
if (btnProductos) {
  btnProductos.addEventListener('click', (e) => {
    e.stopPropagation(); // Evita conflictos con otros clicks

    // Solo ocultamos los paneles
    document.getElementById('panelGrupos').classList.add('oculta');
    document.getElementById('panelSubcategorias').classList.add('oculta');
    
    // Eliminamos mostrarTodos() y scrollTo() para no alterar la vista
  });
}
   
</script>
<script type="module">
const usarFirestore = {{ 'true' if config.usarFirestore else 'false' }};
const email = "{{ session.get('email') or '' }}";
const modoAdmin = {{ 'true' if modoAdmin else 'false' }};

setTimeout(() => {
  if (!window.todosLosProductos || window.todosLosProductos.length === 0) return;

  const primerGrupo = [...new Set(window.todosLosProductos.map(p => p.grupo))][0];
  if (!primerGrupo) return;

  const primerGrupoId = primerGrupo.trim().toLowerCase().replace(/\s+/g, '_');
  const primerGrupoDiv = document.getElementById('grupo_' + primerGrupoId);
  if (primerGrupoDiv) primerGrupoDiv.classList.add('active');

  const subgrupos = [...new Set(window.todosLosProductos
    .filter(p => p.grupo === primerGrupo)
    .map(p => p.subgrupo))];

  // Normalizar: si no hay subgrupo, usar General_{grupo}
  let primerSubgrupoNombre = subgrupos[0]?.trim();
  if (!primerSubgrupoNombre) {
    primerSubgrupoNombre = `General_${primerGrupo}`;
  }

  if (primerGrupoId && primerSubgrupoNombre) {
    filtrarSubcategoria(primerGrupo, primerSubgrupoNombre);
  }
}, 100);

   
</script>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
  const PUBLIC_KEY = "{{ config.public_key or '' }}";
  let mp = null;

  if (PUBLIC_KEY) {
    mp = new MercadoPago(PUBLIC_KEY, { locale: 'es-AR' });
  }

  const pagarBtn = document.getElementById('btn_pagar');
  if (pagarBtn && !PUBLIC_KEY) {
    pagarBtn.disabled = true;
  }

  console.log("PUBLIC_KEY:", PUBLIC_KEY);
</script>
</body>
</html>
