<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Step0 - Subir im√°genes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#000; color:#fff; font-family:sans-serif; }
    h2 { color:#fff; }
    .preview { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
    .preview img { max-width:120px; max-height:120px; border:2px solid #444; border-radius:6px; object-fit:contain; }
    .btn-gradient { background:linear-gradient(135deg,#8e2de2,#ff6f61); color:#fff; border:none; padding:10px 20px; border-radius:50px; font-weight:bold; }
    .btn-gradient:hover { transform:scale(1.05); }
  </style>
</head>
<body>
<div class="container py-5">
  <h2 class="mb-4 text-center">Step0 - Sub√≠ tus im√°genes</h2>

  <div class="text-center mb-4">
    <input type="file" id="inputImagenes" accept="image/*" multiple class="form-control w-50 mx-auto mb-2">
    <button type="button" class="btn-gradient" onclick="procesarImagenes()">üìÇ Subir im√°genes</button>
  </div>

  <div id="preview" class="preview"></div>
</div>

<script>
const MAX_FILES = 50;
const MAX_SIZE_MB = 5;
const bucket = "mpagina";

async function procesarImagenes() {
  const input = document.getElementById("inputImagenes");
  if (!input.files.length) {
    alert("‚ö†Ô∏è Seleccion√° al menos una imagen");
    return;
  }

  const email = window.sessionEmail || localStorage.getItem("email") || "anonimo";
  const email_encoded = email.replace("@","%40");

  const archivos = Array.from(input.files);
  const rutasFinales = [];
  const nombresOriginales = [];

  if (archivos.length > MAX_FILES) {
    alert(`‚ö†Ô∏è M√°ximo ${MAX_FILES} im√°genes`);
    return;
  }

  for (const file of archivos) {
    if (file.size > MAX_SIZE_MB * 1024 * 1024) {
      alert(`‚ö†Ô∏è ${file.name} excede ${MAX_SIZE_MB}MB`);
      continue;
    }

    // Validar duplicados por nombre
    if (nombresOriginales.includes(file.name)) {
      console.warn("‚ö†Ô∏è Duplicado ignorado:", file.name);
      continue;
    }
    nombresOriginales.push(file.name);

    // Optimizar con WASM (ejemplo simplificado)
    const optimizedBlob = await optimizarImagen(file);

    // Generar UUID
    const uuid = crypto.randomUUID() + ".webp";

    // Subir a GCS v√≠a backend
    const formData = new FormData();
    formData.append("file", optimizedBlob, uuid);
    formData.append("email", email);

    const resp = await fetch("/upload_gcs", { method:"POST", body:formData });
    if (!resp.ok) {
      console.error("‚ùå Error subiendo", file.name);
      continue;
    }

    // Ruta p√∫blica final
    const url = `https://storage.googleapis.com/${bucket}/${email_encoded}/${uuid}`;
    rutasFinales.push(url);

    // Mostrar preview
    const img = document.createElement("img");
    img.src = url;
    document.getElementById("preview").appendChild(img);
  }

  // Guardar en localStorage
  localStorage.setItem("imagenes_step0", JSON.stringify(rutasFinales));
  localStorage.setItem("imagenesLista", JSON.stringify(nombresOriginales));

  console.log("‚úÖ Step0 completado. Rutas finales:", rutasFinales);
}

// Simulaci√≥n de optimizaci√≥n WASM
async function optimizarImagen(file) {
  // Aqu√≠ ir√≠a la l√≥gica real con WASM
  return file;
}
</script>
</body>
</html>
